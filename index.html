<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>粉黑乙女：校庆心动企划</title>
  <style>
    :root {
      --bg: #0b0b12;
      --panel: #141420;
      --panel-2: #1f1a2a;
      --accent: #ff4f99;
      --accent-2: #ff8ac2;
      --text: #f5e9f2;
      --muted: #b7a6c6;
      --danger: #ff4f6d;
      --good: #7dffb0;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "PingFang SC", "Noto Sans CJK SC", "Microsoft Yahei", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top, #1b0c1f 0%, #08070d 65%);
      min-height: 100vh;
    }
    header {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 16px 20px;
      background: #09090f;
      border-bottom: 1px solid #2d2033;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 2px;
      color: var(--accent-2);
      flex: 1;
    }
    .btn {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--accent);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s ease;
    }
    .btn:hover {
      background: var(--accent);
      color: #0b0b12;
    }
    .container {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 16px;
      padding: 20px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid #2d2033;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    }
    .panel h2 {
      margin: 0 0 10px;
      font-size: 16px;
      color: var(--accent-2);
    }
    .stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .stat .bar {
      flex: 1;
      height: 8px;
      background: #2a2035;
      border-radius: 999px;
      margin-left: 10px;
      overflow: hidden;
    }
    .bar span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #a95bff);
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #2c1b33;
      color: var(--accent-2);
      margin-right: 6px;
    }
    .task-list {
      display: grid;
      gap: 8px;
    }
    .task {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #2d2033;
      background: var(--panel-2);
      font-size: 13px;
    }
    .task small {
      color: var(--muted);
      display: block;
      margin-top: 4px;
    }
    .story {
      min-height: 340px;
      max-height: 420px;
      overflow-y: auto;
      background: rgba(9, 7, 12, 0.7);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #2d2033;
      line-height: 1.7;
    }
    .story p {
      margin: 0 0 12px;
    }
    .choices {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 16px;
    }
    .choices button {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--accent-2);
      background: #1b1223;
      color: var(--text);
      cursor: pointer;
      transition: 0.2s ease;
    }
    .choices button:hover {
      background: var(--accent-2);
      color: #0b0b12;
    }
    .right-panel .character {
      border-bottom: 1px solid #2d2033;
      padding-bottom: 12px;
      margin-bottom: 12px;
    }
    .character h3 {
      margin: 0 0 8px;
      font-size: 15px;
      color: var(--accent-2);
    }
    .small {
      font-size: 12px;
      color: var(--muted);
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: var(--panel);
      border: 1px solid #2d2033;
      border-radius: 12px;
      padding: 20px;
      width: min(640px, 90vw);
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content h2 {
      margin-top: 0;
      color: var(--accent-2);
    }
    .inventory {
      display: grid;
      gap: 8px;
      margin-top: 8px;
    }
    .inventory .item {
      background: #1d1525;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #2d2033;
    }
    footer {
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      padding: 20px 0 30px;
    }
    .highlight {
      color: var(--accent-2);
    }
  </style>
</head>
<body>
  <header>
    <h1>粉黑乙女：校庆心动企划</h1>
    <button class="btn" id="newGame">新游戏</button>
    <button class="btn" id="saveGame">存档</button>
    <button class="btn" id="loadGame">读档</button>
    <button class="btn" id="toTitle">返回标题</button>
    <button class="btn" id="openTutorial">帮助/教程</button>
    <button class="btn" id="renamePlayer">修改名字</button>
    <button class="btn" id="openSettings">设置</button>
    <button class="btn" id="openShop">商店</button>
  </header>

  <div class="container">
    <aside class="panel">
      <h2>资源面板</h2>
      <div class="small" id="actionInfo"></div>
      <div class="stat">精力 <span id="energyValue">0</span><div class="bar"><span id="energyBar"></span></div></div>
      <div class="stat">金钱 <span id="moneyValue">0</span><div class="bar"><span id="moneyBar"></span></div></div>
      <div class="stat">心情 <span id="moodValue">0</span><div class="bar"><span id="moodBar"></span></div></div>
      <div class="stat">学业 <span id="studyValue">0</span><div class="bar"><span id="studyBar"></span></div></div>
      <div class="stat">企划进度 <span id="projectValue">0</span><div class="bar"><span id="projectBar"></span></div></div>
      <div class="stat">社团效率 <span id="clubEffValue">0</span><div class="bar"><span id="clubEffBar"></span></div></div>
      <div class="small" id="projectHint">未达标将直接失败</div>
      <div class="small" id="stageInfo"></div>
      <div class="small" id="weekGoal"></div>
      <hr />
      <h2>每日任务清单</h2>
      <div class="task-list" id="taskList"></div>
      <div style="margin-top:12px;">
        <button class="btn" id="openAchievements">成就入口</button>
        <button class="btn" id="openInventory">道具</button>
      </div>
    </aside>

    <main class="panel">
      <div class="small" id="dayInfo"></div>
      <div class="story" id="story"></div>
      <div class="choices" id="choices"></div>
    </main>

    <aside class="panel right-panel">
      <h2>男主状态</h2>
      <div class="character" id="charA"></div>
      <div class="character" id="charB"></div>
      <div class="character" id="charC"></div>
    </aside>
  </div>

  <div class="modal" id="achievementModal">
    <div class="modal-content">
      <h2>成就</h2>
      <div id="achievementList"></div>
      <button class="btn" id="closeAchievements">关闭</button>
    </div>
  </div>

  <div class="modal" id="inventoryModal">
    <div class="modal-content">
      <h2>道具</h2>
      <div class="inventory" id="inventoryList"></div>
      <button class="btn" id="closeInventory">关闭</button>
    </div>
  </div>

  <div class="modal" id="settlementModal">
    <div class="modal-content">
      <h2>今日结算</h2>
      <div id="settlementBody"></div>
      <button class="btn" id="confirmSettlement">进入下一天</button>
    </div>
  </div>

  <div class="modal" id="tutorialModal">
    <div class="modal-content">
      <h2>新手教程</h2>
      <div id="tutorialBody"></div>
      <div class="choices" id="tutorialControls"></div>
    </div>
  </div>

  <div class="modal" id="nameModal">
    <div class="modal-content">
      <h2>为女主命名</h2>
      <div class="small">默认名：未散，可随时修改。</div>
      <input id="nameInput" type="text" style="width:100%;padding:8px;margin:12px 0;border-radius:6px;border:1px solid #2d2033;background:#0d0a13;color:var(--text);" />
      <div class="choices">
        <button class="btn" id="confirmName">确认</button>
        <button class="btn" id="skipName">跳过(使用未散)</button>
      </div>
    </div>
  </div>

  <div class="modal" id="nameHintModal">
    <div class="modal-content">
      <h2>小提示</h2>
      <p>建议改名增强代入感。</p>
      <div class="choices">
        <button class="btn" id="renameNow">现在改名</button>
        <button class="btn" id="renameLater">稍后再说</button>
      </div>
    </div>
  </div>

  <div class="modal" id="mainlineWarningModal">
    <div class="modal-content">
      <h2>重要提示</h2>
      <p>主线校庆企划必须按阶段达标，否则直接失败。建议优先推进主线，再安排见面。</p>
      <div class="choices">
        <button class="btn" id="ackWarning">我知道了</button>
        <button class="btn" id="skipWarning">不再提示</button>
      </div>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <h2>设置</h2>
      <label class="small"><input type="checkbox" id="toggleMainlineWarning" /> 显示主线失败提醒</label>
      <div style="margin-top:12px;">
        <button class="btn" id="closeSettings">关闭</button>
      </div>
    </div>
  </div>

  <div class="modal" id="shopModal">
    <div class="modal-content">
      <h2>商店</h2>
      <div class="small">当前金钱：<span id="shopMoney">0</span></div>
      <div id="shopList" class="inventory"></div>
      <button class="btn" id="closeShop">关闭</button>
    </div>
  </div>

  <footer>粉黑乙女风 · 现代校园 · 一天3次行动 · 20周一周目 Demo</footer>

  <script>
    const maxDay = 140;
    const maxWeek = 20;
    const defaultName = "未散";

    const weekGoals = [
      "第1周：立项准备，稳住节奏",
      "第2周：主题确认，开始分工",
      "第3周：展台与节目初稿",
      "第4周：立项结算，进度≥25%",
      "第5周：素材收集与试排",
      "第6周：节目与展台细化",
      "第7周：赞助与宣传铺垫",
      "第8周：资源结算，进度≥50%",
      "第9周：第一轮彩排",
      "第10周：执行细节落地",
      "第11周：流程与人员磨合",
      "第12周：执行结算，进度≥75%",
      "第13周：危机预案与补强",
      "第14周：二轮彩排",
      "第15周：物资到位",
      "第16周：最终结算，进度≥100%",
      "第17周：校庆冲刺",
      "第18周：最后检查",
      "第19周：总彩排",
      "第20周：校庆当日"
    ];

    const milestoneEvents = [
      { threshold: 10, text: "【主线】校庆企划正式立项，你被推为展台联络人。" },
      { threshold: 18, text: "【主线】主题确认：粉黑学院恋爱剧场。" },
      { threshold: 26, text: "【主线】赞助谈判开局，白澤凛司默默递来预算模板。" },
      { threshold: 34, text: "【主线】节目定案：三男主联动的校园舞台剧。" },
      { threshold: 50, text: "【主线】展台制作开工，材料清单排到爆。" },
      { threshold: 58, text: "【主线】第一次彩排，浅羽朔把气氛带得像派对。" },
      { threshold: 66, text: "【主线】突发危机：赞助缩水，需要临时补救。" },
      { threshold: 74, text: "【主线】二轮彩排，久世伶的台词改得更“贴近你”。" },
      { threshold: 82, text: "【主线】物资到位，展台初成型。" },
      { threshold: 90, text: "【主线】最终彩排，你站在舞台中央。" },
      { threshold: 100, text: "【主线】校庆当日，所有人都在等你的指挥。" }
    ];

    const mainlineStages = [
      {
        week: 4,
        target: 25,
        title: "立项未通过",
        text: "立项评审上，你递交的方案被挑出太多细节漏洞，预算与流程迟迟无法定案。你看见同学们的期待慢慢变成犹豫，会议室的灯光冷得像宣判。你明白这不是终点，却需要先停下来，把破碎的节奏一点点捡起。",
        passText: "【阶段过场】会议室的灯光从冷白变得柔一些，你听见纸张翻动的声音像细雨。你心里松了一口气，却依旧紧绷着肩。负责的老师点了点头：“立项先通过，后续细化。”你低声应：“我会把细节补上。”同学们悄声说：“总算开始了。”你看向窗外，心里提醒自己，这只是第一步。"
      },
      {
        week: 8,
        target: 50,
        title: "资源断裂",
        text: "赞助名单被退回，展台材料一再缩水，你的手写清单像被风吹散。你尽力补洞，却发现资源像潮水退去，留下空白与难堪。你深呼吸，告诉自己还有机会，只是校庆的脚步已比想象更快。",
        passText: "【阶段过场】走廊里风很轻，你捏着更新后的赞助表，指尖微微发热。有人凑过来问：“进度还好吗？”你点头：“暂时稳住了。”浅羽朔在一旁笑了下：“那就继续走。”你听见自己的心跳，明白资源只是暂时撑住，后面的路仍要咬牙。"
      },
      {
        week: 12,
        target: 75,
        title: "执行崩塌",
        text: "排练接连出错，人员与流程像齿轮错位，彼此磨损。你试图把所有人拉回同一个节拍，却发现疲惫已经掏空了士气。你看着空荡的舞台，心里不再是绝望，而是明白需要重整旗鼓。",
        passText: "【阶段过场】舞台灯光亮起时，你听见道具落位的轻响，心里有一点踏实。白澤凛司递来流程表，语气简短：“节奏回来了。”你轻声回：“我会守住。”有人在后台说：“再练一次就好。”你抬手压住心跳，告诉自己还能继续。"
      },
      {
        week: 16,
        target: 100,
        title: "临门止步",
        text: "你距离完成只差最后一步，却在关键节点被堵住。报表、审批、物资，像一道道看不见的墙。你已经走到这里，仍被迫停下脚步，心里却很清楚：这不是失败，只是这一次，你没有跨过终点线。",
        passText: "【阶段过场】清点表格时，你终于在最后一页打上对勾。你抬眼，看到大家的表情从紧绷变得轻松。有人说：“终于齐了。”你轻声答：“还差最后冲刺。”久世伶在一旁低声道：“我会守住宣传位。”你把手心合上，心里知道终点就在前方。"
      }
    ];

    const mainlineSuccessText = "【校庆当日】舞台灯光铺满操场，鼓点与人声交叠，你在展台与舞台间穿行。熟悉的名字在耳边交错，你想起那些熬夜与纸张翻动的声音。有人轻声喊：“快来合影。”你笑着回：“我马上。”另一侧有人说：“我们的企划成功了。”你点头：“谢谢你们。”喧闹像浪潮把你托起，你知道自己用20周把故事推到这里，终于走到可以拥抱结局的时刻。";

    const guyProfiles = {
      B: {
        name: "浅羽 朔",
        roman: "Asaba Saku",
        label: "竹马",
        preferred: ["善良", "体贴", "坦率", "边界感"],
        disliked: ["恶趣味", "操控", "冷漠"],
        mild: true
      },
      A: {
        name: "白澤 凛司",
        roman: "Shirasawa Rinji",
        label: "学霸",
        preferred: ["守规矩", "上进", "坦率", "尊重边界", "效率"],
        disliked: ["胡闹", "低效率", "恶趣味"],
        mild: true
      },
      C: {
        name: "久世 伶",
        roman: "Kuze Rei",
        label: "病娇",
        preferred: ["试探", "恶趣味", "占有", "信息差", "小谎言"],
        disliked: ["公开拒绝", "强调边界", "把他当外人"],
        mild: false
      }
    };

    const items = {
      snack: { name: "能量小饼干", type: "补给", desc: "精力+15", effect: (state) => addResource(state, "energy", 15) },
      meal: { name: "食堂热餐", type: "补给", desc: "精力+25", effect: (state) => addResource(state, "energy", 25) },
      bento: { name: "便当盒", type: "补给", desc: "精力+15", effect: (state) => { addResource(state, "energy", 15); } },
      tonic: { name: "能量饮料", type: "补给", desc: "精力+20", effect: (state) => { addResource(state, "energy", 20); } },
      coffee: { name: "咖啡", type: "补给", desc: "学习效率+1（学业+1）", effect: (state) => { addResource(state, "study", 1); } },
      bookmark: { name: "书签", type: "礼物", desc: "送给白澤凛司，好感+3", effect: (state) => giftTo(state, "A", 3) },
      sweets: { name: "手作点心", type: "礼物", desc: "送给浅羽朔，好感+3", effect: (state) => giftTo(state, "B", 3) },
      headset: { name: "黑色耳机", type: "礼物", desc: "送给久世伶，好感+3", effect: (state) => giftTo(state, "C", 3) },
      note: { name: "灵感便笺", type: "补给", desc: "企划进度+6", effect: (state) => addResource(state, "project", 6) },
      charm: { name: "黑桃发夹", type: "礼物", desc: "送给白澤凛司，好感+6", effect: (state) => giftTo(state, "A", 6) },
      soda: { name: "草莓汽水", type: "礼物", desc: "送给浅羽朔，好感+6", effect: (state) => giftTo(state, "B", 6) },
      ribbon: { name: "暗红丝带", type: "礼物", desc: "送给久世伶，好感+6", effect: (state) => giftTo(state, "C", 6) },
      ticket: { name: "演出券", type: "纪念品", desc: "心情+10，随机男主信任+4", effect: (state) => { addResource(state, "mood", 10); randomTrust(state, 4); } },
      clueA: { name: "A的旧奖状", type: "线索", desc: "解锁A的背景故事", effect: (state) => addClue(state, "A") },
      clueB: { name: "B的旧照片", type: "线索", desc: "解锁B的背景故事", effect: (state) => addClue(state, "B") },
      clueC: { name: "C的广播手稿", type: "线索", desc: "解锁C的背景故事", effect: (state) => addClue(state, "C") }
    };

    const shopItems = [
      { id: "bookmark", name: "书签", cost: 18, desc: "凛司好感+3" },
      { id: "sweets", name: "手作点心", cost: 18, desc: "朔好感+3" },
      { id: "headset", name: "黑色耳机", cost: 22, desc: "伶好感+3" },
      { id: "tonic", name: "能量饮料", cost: 15, desc: "精力+20" },
      { id: "bento", name: "便当", cost: 12, desc: "精力+15" },
      { id: "coffee", name: "咖啡", cost: 14, desc: "学习效率+1" }
    ];

    const achievements = [
      { id: "study7", name: "学霸养成", desc: "连续学习7天", reward: "灵感便笺", rewardItem: "note", check: (s) => s.streaks.study >= 7 },
      { id: "firstDate", name: "第一次见面", desc: "完成任意男主见面", reward: "草莓汽水", rewardItem: "soda", check: (s) => s.flags.firstDate },
      { id: "secret", name: "揭开秘密", desc: "任意男主故事解锁到核心真相", reward: "回溯+1", rewardRewind: 1, check: (s) => Object.values(s.guys).some((g) => g.storyTier === 2 && g.storyIndex >= 3) },
      { id: "project50", name: "校庆推进50%", desc: "企划进度达到50%", reward: "能量小饼干", rewardItem: "snack", check: (s) => s.resources.project >= 50 },
      { id: "triangle", name: "三人修罗场存活", desc: "同日触发两位男主事件", reward: "回溯+1", rewardRewind: 1, check: (s) => s.flags.triangle },
      { id: "support", name: "支援者", desc: "累计企划推进20次", reward: "灵感便笺", rewardItem: "note", check: (s) => s.stats.projectTasks >= 20 },
      { id: "workaholic", name: "勤劳打工人", desc: "累计打工10次", reward: "演出券", rewardItem: "ticket", check: (s) => s.stats.partTime >= 10 },
      { id: "clubStar", name: "社团明星", desc: "累计社团活动10次", reward: "暗红丝带", rewardItem: "ribbon", check: (s) => s.stats.club >= 10 },
      { id: "restMaster", name: "自我疗愈", desc: "休息次数达12次", reward: "能量小饼干", rewardItem: "snack", check: (s) => s.stats.rest >= 12 },
      { id: "affection70", name: "心动临界", desc: "任意男主好感>=70", reward: "回溯+1", rewardRewind: 1, check: (s) => Object.values(s.guys).some((g) => g.affection >= 70) },
      { id: "trust70", name: "信赖临界", desc: "任意男主信任>=70", reward: "演出券", rewardItem: "ticket", check: (s) => Object.values(s.guys).some((g) => g.trust >= 70) },
      { id: "week12", name: "坚持到底", desc: "完成12周", reward: "终局回溯+1", rewardRewind: 1, check: (s) => s.day > maxDay }
    ];

    const guyStories = {
      A: {
        name: "白澤 凛司",
        layers: [
          ["他总在图书馆固定座位，像一条冷清的走廊。", "对社团活动不屑一顾，视社交为浪费。", "他拒绝合照，理由是“没必要”。"],
          ["家里对他“必须第一”的高压让他习惯把情绪压成静音。", "他暗中在做校庆赞助申请，却不愿说出口。", "他把忙碌当成防护罩，只留给你一丝温度。"],
          ["他曾因一次“放弃机会去救人”导致成绩受影响。", "家里的冷暴力把他逼成了“可靠机器”。", "他把“可靠”当成赎罪，直到你伸手。"]
        ]
      },
      B: {
        name: "浅羽 朔",
        layers: [
          ["他总能逗你笑，像春天的操场。", "小卖部新品第一口总想塞给你。", "对你转学回来特别上心，像在确认你还在。"],
          ["他对外像太阳，对内却自卑。", "他怕你越走越远，于是拼命跟上。", "他常替你挡流言，却装作不经意。"],
          ["他曾经“误会”你一次，导致你离开。", "他把这三年当作补偿，日复一日。", "他想在校庆那天把真心说出口。"]
        ]
      },
      C: {
        name: "久世 伶",
        layers: [
          ["他温柔、会记住你所有细节。", "总能“刚好路过”，像一阵精准的风。", "他把你的喜好写进广播台的片尾。"],
          ["他在学生会/广播站掌握信息。", "会用“为了你好”制造选择倾向。", "他给你安排“最佳路线”，不让别人靠近。"],
          ["他小时候被长期忽视。", "靠观察与操控获得安全感。", "他害怕失去你，所以宁愿当“坏人也要留下你”。"]
        ]
      }
    };

    const randomEvents = [
      { id: "energyLow", condition: (s) => s.resources.energy <= 30, text: "走廊的窗缝漏进风，光线被切成细长的格子。你靠着墙缓缓吐气，心里提醒自己别被疲惫拖垮。这时有人停下脚步，轻轻把水瓶递到你手里，指尖短暂停顿。对方说：“先喝一点。”你低声回了一句：“谢谢，我会慢慢调整。”", effect: (s) => addResource(s, "energy", 10) },
      { id: "moodLow", condition: (s) => s.resources.mood <= 30, text: "傍晚的广播声在走廊里回旋，你盯着地面上摇晃的光影，心里有一瞬间想逃。手机忽然弹出匿名鼓励语，像有人在暗处扶了一把。你抿唇笑了笑，对屏幕轻声说：“我知道了。”手机那头没有回应，你却觉得空气缓和了。", effect: (s) => addResource(s, "mood", 8) },
      { id: "moneyLow", condition: (s) => s.resources.money <= 20, text: "夜色沉下来，兼职群忽然亮起提示音，你看着那行“临时加班”犹豫了几秒。心里想着主线的支出，你伸手点了确认。对方回复得很快：“辛苦了，明天见。”你把手机塞回口袋，自言自语：“至少能把海报费补上。”", effect: (s) => addResource(s, "money", 30) },
      { id: "studyHigh", condition: (s) => s.resources.study >= 70, text: "教室灯光明亮，你的笔尖在纸上划出整齐的线。老师经过时停了一下，低声道：“你稳得像定心丸。”你心里一热，却只是点点头。旁边同学悄声说：“你也太厉害了吧。”你轻轻笑了一下，回道：“我也只是认真一点。”", effect: (s) => addResource(s, "mood", 5) },
      { id: "projectPush", condition: (s) => s.resources.project >= 40, text: "会议室空调声嗡嗡作响，你把流程卡片一张张摆好，心里默数着进度。有人翻了翻计划表，说：“这次推进比上周顺。”你握紧笔，低声回应：“大家一起才快。”窗外的晚霞被玻璃映成柔色，你的呼吸也跟着轻了点。", effect: (s) => addResource(s, "project", 4) },
      { id: "giftDrop", condition: () => true, text: "社团柜子被轻轻推开，木板发出细微的响声。你发现一只小纸袋安静地躺在角落，系着浅色丝带。你心里微微一跳，伸手拿起时袋口滑出一张便签：“希望你今天别太累。”你轻声说：“是谁写的呢？”空气没有回答。", effect: (s) => gainItem(s, "ticket") },
      { id: "library", condition: () => true, text: "图书馆的灯光温黄，纸页翻动的声音像细雨。你把企划内容摊开，心里暗暗给自己加油。管理员路过时轻声提醒：“注意别太晚。”你点头回应：“我就整理一下。”笔尖停停走走，你的思路逐渐清晰。", effect: (s) => { addResource(s, "study", 4); addResource(s, "project", 2); } },
      { id: "canteen", condition: () => true, text: "食堂里热气腾腾，蒸汽在天花板下卷出淡淡的光晕。你端着新推出的粉黑限定甜品，心里悄悄松一口气。路过的同学笑着说：“这个很好吃。”你应了一声：“是啊，甜得刚好。”暖意顺着指尖蔓延，让你不再那么紧绷。", effect: (s) => addResource(s, "mood", 6) },
      { id: "rain", condition: () => true, text: "雨点敲在伞面上，声音细密而近。你刚抬头，三把伞从不同方向靠近，像三道并行的光。有人低声说：“别淋到。”另一个补了一句：“路有点滑，小心。”你握紧伞柄，心里既慌乱又温热，像被无形的线牵住。", effect: (s) => { addAffection(s, "A", 2); addAffection(s, "B", 2); addAffection(s, "C", 2); s.flags.triangle = true; } },
      { id: "broadcast", condition: () => true, text: "广播台的声音在校园上空缓缓落下，像一层薄雾。你听见自己的名字被温柔念出，心里忽然被点亮。旁边的同学侧头问：“是你吗？”你轻声回：“嗯，是我。”回声散开，你却觉得自己被看见了。", effect: (s) => addResource(s, "mood", 5) },
      { id: "campusCat", condition: () => true, text: "校园猫蜷在台阶边，尾巴轻轻摆动。你蹲下身时它抬眼看你，像在确认你的情绪。你轻声说：“今天也辛苦了。”猫轻轻蹭过你的指尖，你心里忽然松了一下。旁边有人笑道：“它很黏人吧？”你点头：“是啊，像在安慰我。”", effect: (s) => addResource(s, "energy", 5) },
      { id: "poster", condition: () => true, text: "主楼的公告栏前有人驻足，你的海报被风微微掀起边角。你看着自己的字迹，心里涌出一点成就感。学弟学妹指着海报讨论：“这个看起来很认真。”你轻声回：“谢谢，希望你们来。”风把纸角抚平，像是在回应。", effect: (s) => addResource(s, "project", 3) },
      { id: "rumor", condition: (s) => s.resources.mood <= 40, text: "走廊角落传来低低的议论声，你的名字被夹在句尾。你停顿了一下，心里有点刺痛，却还是继续往前走。有人小声说：“她真的这么拼吗？”你在心里回：“是啊，我在为自己的选择负责。”脚步声稳下来，你不再回头。", effect: (s) => addResource(s, "mood", 4) },
      { id: "clinic", condition: (s) => s.resources.energy <= 25, text: "校医室的灯光柔白，你坐在床边，听见电热水壶咕噜作响。校医把暖宝宝贴在你腰侧，动作很轻。她说：“别硬扛。”你小声应：“我会注意。”窗外风吹过树叶，沙沙声像在提醒你慢下来。", effect: (s) => addResource(s, "energy", 12) },
      { id: "bonus", condition: (s) => s.resources.money >= 120, text: "账目本上的数字比预想多了一点，你看着它们心里动摇。最终你还是把一部分资金投入校庆，像把信心投进一张票。有人惊讶地说：“你这么舍得？”你回：“这是我们一起的舞台。”纸张被按平，心也跟着稳了。", effect: (s) => { addResource(s, "money", -20); addResource(s, "project", 4); } },
      { id: "practice", condition: (s) => s.resources.project >= 60, text: "舞台边的音响调试发出低鸣，你站在台阶上看着队伍排开。动作刚开始就比预想顺，节拍像在同一条线。负责同学对你点头：“这次稳多了。”你轻声说：“谢谢，继续保持。”风吹过幕布，像给出无声肯定。", effect: (s) => addResource(s, "project", 4) },
      { id: "sleepy", condition: (s) => s.resources.energy <= 40, text: "午后的教室被光线铺满，灰尘在空中缓慢漂浮。你趴在桌上闭了会儿眼，心里默数着时间。有人轻声提醒：“别睡太久。”你含糊回应：“嗯，马上起。”短短的休息像把精神重新缝起来。", effect: (s) => addResource(s, "energy", 8) },
      { id: "volunteer", condition: () => true, text: "新生志愿者抱着物料进来，脸上带着紧张与期待。你指给他们位置，心里忽然松了一口气。有人问：“这样摆可以吗？”你笑着说：“可以，辛苦了。”人手变多，任务不再像山一样压住你。", effect: (s) => addResource(s, "project", 2) }
    ];

    const meetingEvents = {
      B: [
        {
          id: "B_meet_1",
          text: "操场晚风吹过，浅羽朔把运动外套搭在你肩上，笑意很轻却不散。他说起你刚转来那天，自己跑遍教学楼帮你找教室，像是在确认你真的回来了。夜色把灯光晕开，他却盯着你，不让你躲开。你心里泛起熟悉的温度，听见他问：“{callName}，今天还好吗？”你回道：“还行，只是有点累。”他点头：“累了就靠我一会儿。”",
          options: [
            { label: "认真道谢，说你很感激他的陪伴。", tags: ["善良", "体贴", "坦率"] },
            { label: "笑着调侃他太黏人，提醒他也要照顾自己。", tags: ["边界感", "坦率"] },
            { label: "收回情绪，转而谈校庆任务。", tags: ["冷漠"] }
          ]
        },
        {
          id: "B_meet_2",
          text: "小卖部新品被他塞进你手里，塑料袋上凝着水珠。浅羽朔边说排练顺利，边把你推到有风的走廊尽头。你看见他背包夹层里掉出旧照片——你们小时候在校庆舞台下的合影。他立刻收回，眼神短促慌了一下：“{callName}，如果你不喜欢，我就不提过去了。”你心里一软，低声答：“我没有不喜欢。”他笑了一下：“那以后也一起。”",
          options: [
            { label: "告诉他你也怀念过去，并愿意听他讲。", tags: ["善良", "坦率"] },
            { label: "轻声说现在也很好，但希望彼此尊重边界。", tags: ["边界感", "体贴"] },
            { label: "半开玩笑说照片太幼稚，想看新的合照。", tags: ["坦率", "体贴"] }
          ]
        },
        {
          id: "B_meet_3",
          text: "排练结束的空教室里只剩你和浅羽朔，他把椅子拖到你身旁，声音压低：“我们以前，是不是也这样并肩？”他刻意把“以前”说得很轻，却又像刻在字里。你听得出他在用熟悉感拉住你，既温柔又带一点小心机。他的眼神像在等你给答案。你轻声说：“我们一直在变，但我还在。”他回：“那我也在。”",
          options: [
            { label: "坦白告诉他你珍惜这份羁绊。", tags: ["坦率", "善良"] },
            { label: "提醒他别靠过去绑住你们的现在。", tags: ["边界感"] },
            { label: "调皮地说要用行动证明你们的现在。", tags: ["体贴", "坦率"] }
          ]
        },
        {
          id: "B_meet_4_heart",
          text: "晚霞斜斜铺进走廊，浅羽朔把你的资料夹接过去，一页页帮你压平。他的手指在纸边停住，像是怕弄皱你的心思。你心里忽然有点发热，想起他总是替你挡流言，却从不说出口。他轻声说：“我不想你一个人撑。”你抬眼看他，听见自己回答：“那你呢？”他笑得很淡：“我只要你回头看我就好。”风吹起他的刘海，他却没有移开视线。",
          options: [
            { label: "轻声说你一直看着他。", tags: ["体贴", "坦率"] },
            { label: "告诉他你需要并肩而不是被保护。", tags: ["边界感", "坦率"] },
            { label: "玩笑说他总是太认真，让你紧张。", tags: ["善良", "体贴"] }
          ]
        },
        {
          id: "B_meet_5",
          text: "食堂外的风有点凉，浅羽朔把围巾绕到你脖子上，动作很熟练。你心里一紧，想说谢谢，又觉得太客气。他先开口：“你总是硬撑，我看得出来。”你垂眼：“我不想拖累大家。”他停顿一下：“你不是负担，是我的习惯。”你轻笑：“这话太犯规了。”他回：“那就罚我多陪你一点。”",
          options: [
            { label: "接受他的关心，认真道谢。", tags: ["体贴", "善良"] },
            { label: "提醒他别把你当成过去的投影。", tags: ["边界感"] },
            { label: "半开玩笑说他太会说话。", tags: ["坦率"] }
          ]
        },
        {
          id: "B_meet_6",
          text: "操场灯光像一圈圈柔光，他陪你慢跑，脚步刻意放慢。你心里想着企划细节，他却忽然问：“{callName}，你有没有想过，我们以后还能不能一直这样？”你停了半步，听见自己的呼吸。你答：“我们要先把现在走稳。”他点点头：“那我就陪你把现在走完。”风吹过发梢，他的笑意比灯光更温。",
          options: [
            { label: "肯定他，表示你愿意一起走下去。", tags: ["善良", "坦率"] },
            { label: "说你需要先完成目标，再谈未来。", tags: ["上进", "边界感"] },
            { label: "调皮地说他先赢过你再说。", tags: ["坦率"] }
          ]
        },
        {
          id: "B_meet_7_heart",
          text: "雨后教学楼的地面还带着潮意，浅羽朔撑着伞把你护在身侧。他的衣角被雨水打湿，却一直往你这边倾。你心里泛起一种说不清的酸软，像被旧回忆轻轻触碰。你低声说：“你不用这样。”他笑：“我想。”你抬头看他，听见他补了一句：“我从小就想这样。”伞外的雨声更密，你的心跳也更快。",
          options: [
            { label: "轻声说你也想靠近他。", tags: ["体贴", "坦率"] },
            { label: "提醒他别把过去当成义务。", tags: ["边界感"] },
            { label: "转移话题，怕自己太动摇。", tags: ["试探", "边界感"] }
          ]
        },
        {
          id: "B_meet_8",
          text: "你整理物资时手指划到纸边，浅羽朔立刻把你的手拉过来看。他眉心微皱，却语气轻：“别急，慢一点。”你心里一紧，觉得自己像被过度照顾。你说：“我没那么脆弱。”他沉默一下：“我知道，但我还是想挡在你前面。”你轻叹：“那就一起分担。”他点头：“好。”",
          options: [
            { label: "让他知道你愿意依赖他。", tags: ["体贴", "善良"] },
            { label: "强调你也能照顾他。", tags: ["坦率", "边界感"] },
            { label: "敷衍带过，回到工作。", tags: ["冷漠"] }
          ]
        },
        {
          id: "B_meet_9",
          text: "你在楼梯口停住，浅羽朔刚好从下方走来。他抬眼时，像是先认出了你的疲惫。他说：“要不要我帮你顶一会儿？”你心里有点动摇，担心自己会习惯他的好。你答：“我可以。”他笑：“那就让我陪你一起可以。”你被他的逻辑逗笑，紧绷的肩慢慢放下。",
          options: [
            { label: "接受他的陪伴，轻声感谢。", tags: ["体贴", "善良"] },
            { label: "说你不想麻烦他太多。", tags: ["边界感"] },
            { label: "用玩笑带过，转而说任务。", tags: ["坦率"] }
          ]
        },
        {
          id: "B_meet_10",
          text: "灯光偏暗的走廊里，他把你挡在身后避开人潮。你心里有点不安，想到自己是不是又在依赖他。他却低声说：“我不是在管你，只是怕你被挤到。”你轻声回：“我明白。”他停顿一秒：“你明白就好。”那一瞬间，你听见自己心里很轻的回应。",
          options: [
            { label: "主动靠近他，表示信任。", tags: ["体贴", "坦率"] },
            { label: "提醒他保持一点距离。", tags: ["边界感"] },
            { label: "不置可否，默默跟着。", tags: ["试探"] }
          ]
        },
        {
          id: "B_meet_11",
          text: "夜跑后，你们坐在操场边，呼吸还没平稳。他递给你水，语气里带着一点认真：“{callName}，你有没有想过离开这里？”你愣了下，心里一酸：“我刚回来。”他轻声说：“那我就更想好好陪你。”你看着他的侧脸，忽然意识到，他的温柔里藏着不愿被你忽略的心意。",
          options: [
            { label: "直白说你不想再离开。", tags: ["坦率", "善良"] },
            { label: "说你需要时间确认自己的方向。", tags: ["边界感", "上进"] },
            { label: "用笑掩饰情绪，转移话题。", tags: ["试探"] }
          ]
        },
        {
          id: "B_meet_12",
          text: "排练室里只剩灯管的嗡鸣，你整理道具，他突然把一张折好的纸塞给你。展开一看，是你名字的练习字迹。他低声说：“怕你累的时候忘了自己的名字。”你心里一跳，轻轻笑了：“你怎么总把我当重要的人？”他很认真：“因为你就是。”你别开脸，却忍不住弯起唇角。",
          options: [
            { label: "承认你也把他放在心上。", tags: ["坦率", "体贴"] },
            { label: "提醒他别把你捧得太高。", tags: ["边界感"] },
            { label: "假装嫌弃，缓和气氛。", tags: ["恶趣味", "坦率"] }
          ]
        },
        {
          id: "B_meet_13",
          text: "你在教室门口等人，浅羽朔把外套披到你身上，指尖轻轻拢了一下。你心里忽然安静下来，像被旧时光包围。他说：“我们从以前到现在，都在同一条路上。”你轻声回应：“我知道。”他笑：“那就别走太快，让我跟上。”你点头，心里有一点柔软的决定。",
          options: [
            { label: "让他放心，你会等他。", tags: ["体贴", "善良"] },
            { label: "说你更希望并肩而不是被追赶。", tags: ["边界感", "坦率"] },
            { label: "转移话题，怕自己说太多。", tags: ["试探"] }
          ]
        }
      ],
      A: [
        {
          id: "A_meet_1",
          text: "预算表摊在桌面上，白澤凛司的笔尖停在细小的数字偏差处。他抬眼，语气清晰：“这个位置要对齐。”你注意到他连纸边都整理得一丝不苟，像在守护规则。他把文件递给你时指节发白，像在压住焦躁。你心里轻轻一缩，听见他低低喊了一声“{callName}”。你答：“我会改好。”他点头：“谢谢。”",
          options: [
            { label: "认真记录并表示会马上修正。", tags: ["守规矩", "效率", "上进"] },
            { label: "轻声说谢谢他的校对，同时询问他是否需要休息。", tags: ["体贴", "尊重边界"] },
            { label: "笑着说格式无所谓，重点是内容。", tags: ["胡闹", "低效率"] }
          ]
        },
        {
          id: "A_meet_2",
          text: "你在教室外等他签字，白澤凛司却先把你叫进办公室。他指向屏幕上的流程图：“如果不按规定走，整个校庆会卡死。”他的语气不高，却像刀锋干净。你看见他眼底的倦意，像压了很久的负担。你轻声说：“我会配合。”他停顿一下：“{callName}，别勉强。”你答：“不会。”",
          options: [
            { label: "表示理解并愿意配合流程优化。", tags: ["守规矩", "效率"] },
            { label: "直白说你也不想拖累他，会更上进。", tags: ["坦率", "上进"] },
            { label: "试图拉他去喝点东西放松。", tags: ["体贴", "尊重边界"] }
          ]
        },
        {
          id: "A_meet_3",
          text: "晚自习后，白澤凛司把折得很平整的资料递给你。他没有多解释，只说：“你会用得到。”走廊灯光冷白，他的影子落在你脚边，像一条严谨的线。你轻声问他是不是也会累，他回答：“没事，{callName}，先把事做好。”你心里有点发热，低声回：“谢谢你。”他略微点头，却没有走远。",
          options: [
            { label: "点头收下资料，并承诺按他的思路推进。", tags: ["守规矩", "效率"] },
            { label: "说你会努力，但也希望他能照顾自己。", tags: ["尊重边界", "体贴"] },
            { label: "开玩笑说他太死板，想看他失控一次。", tags: ["胡闹", "恶趣味"] }
          ]
        },
        {
          id: "A_meet_4_heart",
          text: "教室窗外是淡蓝的夜色，白澤凛司把你的企划纸张按在桌面，逐条对照。他的声音很低：“这段改完，流程就通了。”你心里忽然安静下来，像把乱线重新理顺。他停顿片刻，似乎在寻找合适的词：“{callName}……做得很好。”那句话很轻，却像落在心口。你抬眼看他，发现他的耳尖微红，却很快移开视线。你轻声说：“谢谢你一直在。”他回：“我只是做该做的。”",
          options: [
            { label: "认可他的认真，愿意一起扛。", tags: ["坦率", "守规矩"] },
            { label: "提醒他也要喘口气。", tags: ["尊重边界", "体贴"] },
            { label: "用玩笑缓和他的紧绷。", tags: ["坦率"] }
          ]
        },
        {
          id: "A_meet_5",
          text: "你把打印好的流程递上去，他先是对齐角度，再慢慢翻页。他忽然抬头：“你为什么总是一个人做？”你怔了一下，心里有点酸，却还是平静回答：“习惯了。”他沉默几秒，说：“不必习惯。”你轻声回：“那我就试着不习惯。”他点头，像在认可你的回答。",
          options: [
            { label: "坦白说你其实也想有人并肩。", tags: ["坦率", "善良"] },
            { label: "表示自己还能撑住，不想麻烦人。", tags: ["上进", "边界感"] },
            { label: "把话题转回工作细节。", tags: ["效率"] }
          ]
        },
        {
          id: "A_meet_6",
          text: "办公室的灯光亮得刺眼，你们对着预算表一行行核对。他忽然停下笔：“这部分可以优化。”你顺着他的手指看过去，心里有种被认真对待的感觉。你说：“我会再调整。”他答：“我等你的版本。”你轻声笑了下：“谢谢你信我。”他抿唇：“这是流程需要。”",
          options: [
            { label: "认真记录并快速修改。", tags: ["效率", "守规矩"] },
            { label: "询问他是否还有别的建议。", tags: ["坦率", "上进"] },
            { label: "提醒他别太苛刻。", tags: ["边界感"] }
          ]
        },
        {
          id: "A_meet_7_heart",
          text: "图书馆的灯光落在他的侧脸上，线条冷而漂亮。他把一本书推到你面前：“这个章节会有用。”你翻开时发现里面夹着一张便签，写着你的名字。你心里一怔，抬头看他。他说得很轻：“我不擅长表达，但我会记住。”你低声回应：“我知道。”他的指尖轻轻敲了敲桌面，像在压住某种情绪。你忽然觉得这个安静的瞬间，比任何热闹都让人心动。",
          options: [
            { label: "直白告诉他你很感动。", tags: ["坦率", "体贴"] },
            { label: "轻声道谢，给他空间。", tags: ["尊重边界"] },
            { label: "用玩笑缓解紧张。", tags: ["坦率"] }
          ]
        },
        {
          id: "A_meet_8",
          text: "你递交资料时不小心打翻水杯，他伸手帮你挡住纸面，袖口瞬间湿了一片。他没有抱怨，只说：“下次注意。”你心里一紧：“对不起。”他看了你一眼：“没事。”你低声补：“谢谢你。”他微不可察地嗯了一声，像把情绪压到最轻。",
          options: [
            { label: "认真道歉并马上整理。", tags: ["守规矩", "上进"] },
            { label: "询问他是否需要更换衣物。", tags: ["体贴", "尊重边界"] },
            { label: "试着笑着带过，缓解气氛。", tags: ["坦率"] }
          ]
        },
        {
          id: "A_meet_9",
          text: "走廊尽头的风吹得纸张微卷，他把一叠表格按住，抬眼看你：“你别总把责任背在自己身上。”你心里一震，却还是说：“我怕出错。”他语气淡却很坚定：“流程不是你一个人的。”你点头，心里忽然轻了一点。你说：“我会学着依赖团队。”他轻轻颔首。",
          options: [
            { label: "接受他的提醒，愿意分担。", tags: ["坦率", "守规矩"] },
            { label: "表示你会更努力保证质量。", tags: ["上进", "效率"] },
            { label: "试探他是否也需要帮助。", tags: ["体贴", "尊重边界"] }
          ]
        },
        {
          id: "A_meet_10",
          text: "你在资料室找文件，他从背后递来一份备份，语气简短：“你要的。”你心里一热，想说谢谢又觉得太轻。他补了一句：“我顺手。”你抬眼：“你的顺手总是救急。”他没有回应，但视线停在你身上半秒。你轻声说：“我会记得。”他淡淡回：“不必。”",
          options: [
            { label: "表达感谢并认真收下。", tags: ["坦率", "体贴"] },
            { label: "说你会用成果回报他。", tags: ["上进", "效率"] },
            { label: "提醒他别把自己逼太紧。", tags: ["尊重边界"] }
          ]
        },
        {
          id: "A_meet_11",
          text: "晚风穿过楼道，他站在栏杆边翻看你的修改稿。你站在旁边，心里有点紧张。他忽然说：“这一版比上一版好。”你轻轻松了口气：“我熬了一夜。”他抬眼：“别熬。”你笑了下：“你也别。”他停顿一下：“我会尽量。”那句尽量很轻，却让你觉得他不是只有冰冷的规则。",
          options: [
            { label: "答应他会调整作息。", tags: ["守规矩", "体贴"] },
            { label: "坦白说你需要他提醒。", tags: ["坦率"] },
            { label: "笑着敷衍，继续推进。", tags: ["效率"] }
          ]
        },
        {
          id: "A_meet_12",
          text: "你把预算表重新打印，他忽然递来一支备用笔：“你的笔没墨了。”你一怔，才发现他一直留意你的小细节。你说：“谢谢。”他淡淡回：“别分心。”你心里忽然有一点被照顾的温度，却又不敢说太多。你低声问：“你是不是也会怕？”他看向远处：“怕出错。”你点头：“我也是。”",
          options: [
            { label: "坦率承认你也会不安。", tags: ["坦率"] },
            { label: "表示你会用行动弥补不安。", tags: ["上进", "效率"] },
            { label: "试着转移话题，减轻压力。", tags: ["体贴"] }
          ]
        },
        {
          id: "A_meet_13",
          text: "你在空教室里写报告，他突然进来把窗关上：“风太大，会乱。”你看着他背影，心里有种被保护的错觉。他转身时语气克制：“你可以慢一点。”你轻轻回答：“我会。”他点头，像把允许写进规则里。你忽然觉得这个人其实比你想的更温柔，只是用另一种方式表达。",
          options: [
            { label: "接受他的提醒，放慢节奏。", tags: ["守规矩", "体贴"] },
            { label: "说你需要他的协助。", tags: ["坦率"] },
            { label: "坚持自己能扛住。", tags: ["上进", "边界感"] }
          ]
        }
      ],
      C: [
        {
          id: "C_meet_1",
          text: "广播站的玻璃窗映着你的倒影，久世伶推开门时脚步轻得像没声音。他把宣传位的排班表递给你，语气温柔：“我帮你留了最佳时段。”你明白这不是无条件好意，而是信息差后的选择。他的手指停在你名字旁边，像在确认归属。他低声重复：“{callName}。”你回：“谢谢。”他轻笑：“不用谢我，答应就好。”",
          options: [
            { label: "顺着他的安排，表示愿意配合。", tags: ["信息差", "小谎言"] },
            { label: "试探他为什么愿意帮你。", tags: ["试探"] },
            { label: "强调自己会按规则申请，不需要特殊照顾。", tags: ["强调边界"] }
          ]
        },
        {
          id: "C_meet_2",
          text: "你在走廊拐角被久世伶“偶遇”，他递来匿名赞助线索，嘴角弧度恰到好处：“我只是不想看到你被别人抢走资源。”他总是把话说得很轻，却像一根线缠上你的手腕。你听见远处有人走近，他却站得更近，让你只能面对他。那份靠近里有温柔，也有不容拒绝的坚持，他在你耳边叫了声“{callName}”。你低声回：“我记住了。”",
          options: [
            { label: "半真半假地说只有他懂你。", tags: ["占有", "小谎言"] },
            { label: "提醒他别太过度，合作就够了。", tags: ["公开拒绝", "强调边界"] },
            { label: "轻声说想听他真正的目的。", tags: ["试探", "恶趣味"] }
          ]
        },
        {
          id: "C_meet_3",
          text: "夜晚的广播站灯光昏暗，久世伶把耳机扣在你耳边，低声说：“你听，只有我们听得到。”他的声音像在缠绕你，语气温柔却不容置疑。他把你的名字在句尾拖长：“{callName}……”你心里一紧，意识到他的亲近不是单纯喜欢，而是带着占有与试探。你低声说：“别靠太近。”他笑：“那就更近一点，你会习惯的。”",
          options: [
            { label: "让他继续念下去，告诉他你想听。", tags: ["占有", "试探"] },
            { label: "轻轻把耳机取下，说你需要一点空间。", tags: ["公开拒绝"] },
            { label: "用玩笑回应他的暧昧，保持模糊。", tags: ["恶趣味", "信息差"] }
          ]
        },
        {
          id: "C_meet_4_heart",
          text: "广播站外的灯忽明忽暗，久世伶把你的名字写在便签上，指腹轻轻描过那两个字。你心里一热，像被某种视线缠住。他低声说：“你今天只需要听我的。”你笑得很轻：“你为什么总是这么自信？”他靠近半步：“因为你会回来。”你听见自己的呼吸，想说拒绝，却又被他的温柔拖住。你轻声问：“如果我不呢？”他回答：“那我就等。”",
          options: [
            { label: "顺着他的节奏，表示愿意听他一次。", tags: ["占有", "信息差"] },
            { label: "试探他会不会真的等你。", tags: ["试探", "恶趣味"] },
            { label: "提醒他你不喜欢被控制。", tags: ["强调边界"] }
          ]
        },
        {
          id: "C_meet_5",
          text: "你在公告栏前停下脚步，久世伶从背后递来一张宣传卡。他的声音很低：“我把最好的位置留给你。”你心里微微一紧，知道这意味着你必须承他的人情。你回：“我会补偿。”他轻声笑：“我不要补偿，我要你记住我。”你抬眼看他，他的目光像一层看不见的网。",
          options: [
            { label: "答应他，顺势接受好意。", tags: ["信息差", "小谎言"] },
            { label: "试探他真正的代价。", tags: ["试探"] },
            { label: "拒绝太多照顾，强调合作边界。", tags: ["强调边界"] }
          ]
        },
        {
          id: "C_meet_6",
          text: "夜色压在走廊上，他忽然伸手替你拉好胸前的围巾，动作轻得几乎没有触感。你心里一跳，想后退，却被他温柔的声音按住：“别怕，我只是帮你挡风。”你低声说：“你总是知道我会在哪里。”他笑：“因为我记得你所有的习惯。”你抿唇：“这不公平。”他轻声回：“公平不重要，只有你重要。”",
          options: [
            { label: "接受他的靠近，轻声回应。", tags: ["占有", "试探"] },
            { label: "提醒他不要越界。", tags: ["强调边界"] },
            { label: "用玩笑缓和紧绷。", tags: ["恶趣味"] }
          ]
        },
        {
          id: "C_meet_7",
          text: "广播台的红灯亮起，他把耳麦放到你手心，指尖轻轻擦过你的掌心。你心里一紧，觉得他故意放慢了动作。他说：“只要你愿意，所有人都会听见你的声音。”你低声回：“我不想欠你。”他笑：“那就把你的秘密给我。”你抬眼：“你想知道什么？”他靠近：“你更偏向谁。”",
          options: [
            { label: "含糊回应，给他一点想象。", tags: ["信息差", "小谎言"] },
            { label: "直接拒绝他的试探。", tags: ["公开拒绝"] },
            { label: "反问他是不是在嫉妒。", tags: ["试探", "恶趣味"] }
          ]
        },
        {
          id: "C_meet_8_heart",
          text: "你在楼梯间停住，久世伶从上方望下来，影子把你包住。他慢慢走近，声音像擦过耳际：“{callName}，你总是把自己放在最后。”你想反驳，却被他轻轻握住手腕。你说：“你这样很危险。”他笑得温柔：“危险的是你离我太远。”你心里一震，意识到他的温柔背后藏着极深的执念。你轻声问：“那我该怎么办？”他回答：“只要别把我当外人。”",
          options: [
            { label: "答应他会更靠近一些。", tags: ["占有", "试探"] },
            { label: "告诉他你需要保持边界。", tags: ["强调边界"] },
            { label: "用玩笑掩饰心跳。", tags: ["恶趣味"] }
          ]
        },
        {
          id: "C_meet_9",
          text: "夜风吹过走廊，他把你的手套塞进你掌心：“你又忘了。”你心里一软，却又觉得他知道得太多。他说：“你会在这个时间经过这里。”你低声回：“你监视我？”他笑：“我在等你。”你心里一震，发现他把等待说得很轻，却像在设定你的位置。",
          options: [
            { label: "接受他的等待，轻声道谢。", tags: ["试探", "占有"] },
            { label: "质疑他的行为，要求解释。", tags: ["公开拒绝"] },
            { label: "用玩笑带过，保持模糊。", tags: ["恶趣味", "信息差"] }
          ]
        },
        {
          id: "C_meet_10",
          text: "广播室里只有机器的低鸣，你在整理稿件，久世伶靠在门边看着你。他忽然说：“我知道你今天很累。”你抬眼：“你怎么知道？”他笑：“我听见你的叹气。”你心里一紧，觉得自己被看得太透。他靠近半步：“让我帮你。”你低声回：“你想换什么？”他轻轻说：“你的信任。”",
          options: [
            { label: "答应他，试着交出一点信任。", tags: ["占有", "试探"] },
            { label: "拒绝他，强调你自己能处理。", tags: ["公开拒绝"] },
            { label: "用玩笑试探他的底线。", tags: ["恶趣味"] }
          ]
        },
        {
          id: "C_meet_11",
          text: "你在公告栏前拆掉被覆盖的宣传纸，他从后方递上新的版面：“我重新排了顺序。”你心里一凛，知道他在替你扫清障碍。你说：“你不需要做到这一步。”他轻声回：“我想。”你抬眼看他，他目光温柔却不容置疑。你低声问：“你到底想要什么？”他答：“只要你别把我推开。”",
          options: [
            { label: "答应他会考虑他的心情。", tags: ["试探", "占有"] },
            { label: "提醒他不要控制你。", tags: ["强调边界"] },
            { label: "用暧昧笑意回避问题。", tags: ["恶趣味", "信息差"] }
          ]
        },
        {
          id: "C_meet_12",
          text: "夜自习后你独自收拾，他突然出现，递来一张新的流程表。你心里一紧：“你怎么在这里？”他笑：“我总会出现。”你低声回：“那不公平。”他慢慢说：“公平从来不是我们的规则。”他的语气很柔，却让你心里发凉。你抬眼：“你会一直这样吗？”他答：“只要你还需要我。”",
          options: [
            { label: "顺势接受他的安排。", tags: ["信息差", "占有"] },
            { label: "质疑他的动机。", tags: ["试探"] },
            { label: "冷静拒绝他的插手。", tags: ["公开拒绝"] }
          ]
        },
        {
          id: "C_meet_13",
          text: "你在楼道拐角停住，他靠近时带着淡淡的皂香。久世伶把你的名牌轻轻拨正，像在确认你属于哪里。他低声说：“别让别人碰你。”你心里一紧，问：“你是在命令我？”他笑得温柔：“只是请求。”你看着他，觉得他的温柔像一条细线，慢慢绕上你的心。",
          options: [
            { label: "答应他的请求，保持暧昧距离。", tags: ["占有", "试探"] },
            { label: "提醒他你有自己的选择。", tags: ["强调边界"] },
            { label: "用玩笑缓和，保留主动权。", tags: ["恶趣味", "信息差"] }
          ]
        }
      ]
    };

    const tasks = [
      { id: "study", name: "学习", desc: "学业+3~6 社团效率+1 心情-1 精力-12", effect: (s) => { const gain = 3 + Math.floor(Math.random() * 4); addResource(s, "study", gain); addResource(s, "clubEff", 1); addResource(s, "mood", -1); addResource(s, "energy", -12); s.streaks.study++; },
        condition: () => true },
      { id: "club", name: "社团", desc: "心情+1 企划+2+效率系数 精力-10", effect: (s) => { const bonus = Math.floor(s.resources.clubEff / 5); addResource(s, "mood", 1); addResource(s, "project", 2 + bonus); addResource(s, "energy", -10); s.stats.club++; s.streaks.study = 0; },
        condition: () => true },
      { id: "parttime", name: "打工", desc: "金钱+20~+40 心情-2 精力-16", effect: (s) => { const gain = 20 + Math.floor(Math.random() * 21); addResource(s, "money", gain); addResource(s, "mood", -2); addResource(s, "energy", -16); s.stats.partTime++; s.streaks.study = 0; },
        condition: () => true },
      { id: "rest", name: "休息", desc: "精力+35 心情+4（有概率额外+5）", effect: (s) => { addResource(s, "energy", 35); addResource(s, "mood", 4); if (Math.random() < 0.35) addResource(s, "mood", 5); s.stats.rest++; s.streaks.study = 0; },
        condition: () => true },
      { id: "date", name: "见面", desc: "与男主互动 好感/信任↑ 精力-8 心情+3", effect: (s) => { s.flags.firstDate = true; },
        condition: (s) => s.day >= 3 },
      { id: "project", name: "校庆推进", desc: "企划+10 精力-14 心情-1（需资金支持）", effect: (s) => { applyProjectProgress(s); addResource(s, "energy", -14); addResource(s, "mood", -1); s.stats.projectTasks++; s.streaks.study = 0; },
        condition: () => true },
      { id: "useItem", name: "使用道具", desc: "使用背包内道具", effect: () => {}, condition: (s) => s.inventory.length > 0 },
      { id: "emergencyRest", name: "强制休整", desc: "精力+40 心情+3（低精力时解锁）", effect: (s) => { addResource(s, "energy", 40); addResource(s, "mood", 3); s.stats.rest++; }, condition: (s) => s.resources.energy < 25 },
      { id: "canteen", name: "食堂补给", desc: "精力+30 心情+3（低精力时解锁）", effect: (s) => { addResource(s, "energy", 30); addResource(s, "mood", 3); }, condition: (s) => s.resources.energy < 25 },
      { id: "seekB", name: "向竹马求助", desc: "精力+25 心情+6 信任+4（低精力时解锁）", effect: (s) => { addResource(s, "energy", 25); addResource(s, "mood", 6); addTrust(s, "B", 4); }, condition: (s) => s.resources.energy < 25 && s.day >= 2 }
    ];

    const tutorialSteps = [
      "欢迎来到粉黑乙女校园！左侧是资源面板、任务与成就入口。",
      "一天有3次行动：学习/社团/打工/休息/见面/校庆推进等。",
      "主线目标是20周内完成校庆企划，进度条与阶段目标会提示你。",
      "右侧是男主好感与信任，提升后可解锁背景故事层层秘密。",
      "顶部可存档/读档，成就会奖励道具或回溯券。",
      "回溯券可在关键时刻救场，放心探索选择！"
    ];

    const stateTemplate = () => ({
      playerName: defaultName,
      day: 1,
      week: 1,
      actionsPerDay: 3,
      actionsTaken: 0,
      storyLog: ["新学期第1周，你作为转学/返校生踏进校园。一天有3次行动。校庆企划的消息铺天盖地。"],
      resources: { energy: 80, money: 100, mood: 60, study: 50, project: 0, clubEff: 0 },
      inventory: ["snack", "meal"],
      achievements: [],
      guys: {
        A: { affection: 20, trust: 20, storyTier: 0, storyIndex: 0, unlocked: false },
        B: { affection: 20, trust: 20, storyTier: 0, storyIndex: 0, unlocked: true },
        C: { affection: 20, trust: 20, storyTier: 0, storyIndex: 0, unlocked: false }
      },
      stats: { projectTasks: 0, partTime: 0, club: 0, rest: 0 },
      streaks: { study: 0 },
      milestoneIndex: 0,
      extremeChoices: 0,
      lowTrustDays: 0,
      rewindTokens: 1,
      daySummary: null,
      forcedRest: false,
      flags: { firstDate: false, triangle: false, nameHintShown: false },
      settings: { showMainlineWarning: true },
      gameOver: false
    });

    let state = stateTemplate();
    let nameModalMode = "newgame";
    initDaySummary();

    const storyEl = document.getElementById("story");
    const choicesEl = document.getElementById("choices");
    const taskListEl = document.getElementById("taskList");
    const dayInfoEl = document.getElementById("dayInfo");
    const actionInfoEl = document.getElementById("actionInfo");

    const achievementModal = document.getElementById("achievementModal");
    const inventoryModal = document.getElementById("inventoryModal");
    const settlementModal = document.getElementById("settlementModal");
    const settlementBody = document.getElementById("settlementBody");
    const tutorialModal = document.getElementById("tutorialModal");
    const tutorialBody = document.getElementById("tutorialBody");
    const tutorialControls = document.getElementById("tutorialControls");
    const nameModal = document.getElementById("nameModal");
    const nameHintModal = document.getElementById("nameHintModal");
    const mainlineWarningModal = document.getElementById("mainlineWarningModal");
    const settingsModal = document.getElementById("settingsModal");
    const achievementList = document.getElementById("achievementList");
    const inventoryList = document.getElementById("inventoryList");

    const resourceMap = {
      energy: { value: document.getElementById("energyValue"), bar: document.getElementById("energyBar") },
      money: { value: document.getElementById("moneyValue"), bar: document.getElementById("moneyBar") },
      mood: { value: document.getElementById("moodValue"), bar: document.getElementById("moodBar") },
      study: { value: document.getElementById("studyValue"), bar: document.getElementById("studyBar") },
      project: { value: document.getElementById("projectValue"), bar: document.getElementById("projectBar") },
      clubEff: { value: document.getElementById("clubEffValue"), bar: document.getElementById("clubEffBar") }
    };
    const resourceLabels = {
      energy: "精力",
      money: "金钱",
      mood: "心情",
      study: "学业",
      project: "企划进度",
      clubEff: "社团效率"
    };

    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

    function getCallName(guyId, affection, trust) {
      const base = state.playerName;
      if (guyId === "B") {
        if (affection < 20) return `${base}同学`;
        if (affection < 55) return base;
        if (affection < 80) return `${base}酱`;
        return trust >= 70 ? base : `${base}酱`;
      }
      if (guyId === "A") {
        if (affection < 20) return `${base}同学`;
        if (affection < 55) return base;
        if (affection < 80) return `${base}…`;
        return trust >= 70 ? `……${base}` : `${base}…`;
      }
      if (guyId === "C") {
        if (affection < 20) return base;
        if (affection < 55) return `${base}、${base}`;
        if (affection < 80) return `${base}……`;
        return trust >= 70 ? `${base}……过来` : `${base}……`;
      }
      return base;
    }

    function getGuyDisplayName(guyId) {
      return `${guyProfiles[guyId].name} (${guyProfiles[guyId].roman})`;
    }

    function cloneGuyStats(guys) {
      return Object.fromEntries(Object.entries(guys).map(([id, g]) => [id, { affection: g.affection, trust: g.trust }]));
    }

    function initDaySummary() {
      state.daySummary = {
        startResources: { ...state.resources },
        startGuys: cloneGuyStats(state.guys),
        items: [],
        clues: [],
        logs: []
      };
    }

    function addResource(s, key, amount) {
      s.resources[key] = clamp(s.resources[key] + amount, 0, 100);
      if (key === "project") {
        s.resources.project = clamp(s.resources.project, 0, 100);
        checkMilestones(s);
      }
    }

    function applyProjectProgress(s) {
      const costs = [8, 10, 12];
      const cost = costs[s.stats.projectTasks % costs.length];
      if (s.resources.money < cost) {
        s.storyLog.push("【资金不足】海报费/布景费/宣传费未凑齐，本次推进受阻。");
        addResource(s, "project", 2);
      } else {
        addResource(s, "money", -cost);
        addResource(s, "project", 10);
        s.storyLog.push(`【资金支出】支付${cost}金，推进顺利。`);
      }
    }

    function addAffection(s, guy, amount) {
      s.guys[guy].affection = clamp(s.guys[guy].affection + amount, 0, 100);
      if (s.daySummary) {
        s.daySummary.logs.push(`好感变动：${guyStories[guy].name} ${amount > 0 ? "+" : ""}${amount}`);
      }
    }

    function addTrust(s, guy, amount) {
      s.guys[guy].trust = clamp(s.guys[guy].trust + amount, 0, 100);
      if (s.daySummary) {
        s.daySummary.logs.push(`信任变动：${guyStories[guy].name} ${amount > 0 ? "+" : ""}${amount}`);
      }
    }

    function giftTo(s, guy, amount) {
      addAffection(s, guy, amount);
      addTrust(s, guy, Math.floor(amount / 2));
    }

    function randomTrust(s, amount) {
      const keys = Object.keys(s.guys);
      const pick = keys[Math.floor(Math.random() * keys.length)];
      addTrust(s, pick, amount);
    }

    function gainItem(s, itemId) {
      s.inventory.push(itemId);
      s.storyLog.push(`获得道具：${items[itemId].name}。`);
      if (s.daySummary) {
        s.daySummary.items.push(items[itemId].name);
      }
    }

    function addClue(s, guy) {
      const g = s.guys[guy];
      const layer = guyStories[guy].layers[g.storyTier] || [];
      const index = g.storyIndex;
      if (layer[index]) {
        s.storyLog.push(`【${guyStories[guy].name}背景】${layer[index]}`);
        if (s.daySummary) {
          s.daySummary.clues.push(`${guyStories[guy].name}：${layer[index]}`);
        }
        g.storyIndex += 1;
        if (g.storyIndex >= 3 && g.storyTier < 2) {
          g.storyTier += 1;
          g.storyIndex = 0;
        }
      } else {
        s.storyLog.push("故事线索已全部解锁。");
      }
    }

    function checkMilestones(s) {
      const next = milestoneEvents[s.milestoneIndex];
      if (next && s.resources.project >= next.threshold) {
        s.storyLog.push(next.text);
        s.milestoneIndex += 1;
      }
    }

    function getWeek() {
      return Math.ceil(state.day / 7);
    }

    function updateWeek() {
      state.week = getWeek();
    }

    function renderResources() {
      Object.entries(state.resources).forEach(([key, value]) => {
        resourceMap[key].value.textContent = value;
        resourceMap[key].bar.style.width = `${value}%`;
      });
      document.getElementById("weekGoal").textContent = weekGoals[state.week - 1] || "";
      const stageIndex = Math.min(Math.floor((state.week - 1) / 4) + 1, 5);
      const stageLabel = stageIndex <= 4 ? `阶段${stageIndex}/4 · 第${stageIndex * 4}周结算` : "阶段5/5 · 校庆当日";
      document.getElementById("stageInfo").textContent = `主线阶段：${stageLabel} · 当前进度${state.resources.project}%`;
    }

    function renderCharacters() {
      const renderGuy = (id, elId) => {
        const guy = state.guys[id];
        const storyProgress = guy.storyTier * 3 + guy.storyIndex;
        const locked = !guy.unlocked;
        const lockText = id === "A"
          ? "第4周：流程/预算审核卡死，需要白澤凛司签字解锁"
          : "第6周：宣传位危机，需与久世伶合作解锁";
        const text = `
          <h3>${getGuyDisplayName(id)}</h3>
          ${locked ? `<div class="small">🔒 未解锁：${lockText}</div>` : `
          <div class="stat">好感 ${guy.affection}<div class="bar"><span style="width:${guy.affection}%"></span></div></div>
          <div class="stat">信任 ${guy.trust}<div class="bar"><span style="width:${guy.trust}%"></span></div></div>
          <div class="small">背景故事解锁进度：${storyProgress}/9</div>`}
        `;
        const element = document.getElementById(elId);
        element.innerHTML = text;
        element.style.opacity = locked ? "0.5" : "1";
      };
      renderGuy("A", "charA");
      renderGuy("B", "charB");
      renderGuy("C", "charC");
    }

    function renderTasks() {
      taskListEl.innerHTML = "";
      tasks.filter((task) => task.condition(state)).forEach((task) => {
        const div = document.createElement("div");
        div.className = "task";
        div.innerHTML = `<strong>${task.name}</strong><small>${task.desc}</small>`;
        taskListEl.appendChild(div);
      });
    }

    function renderStory() {
      storyEl.innerHTML = state.storyLog.map((line) => `<p>${line}</p>`).join("");
      storyEl.scrollTop = storyEl.scrollHeight;
    }

    function renderDayInfo() {
      dayInfoEl.innerHTML = `第${state.day}天 / 第${state.week}周 · 今日行动：${state.actionsTaken}/${state.actionsPerDay}`;
      actionInfoEl.textContent = `今日行动：${state.actionsTaken}/${state.actionsPerDay}`;
    }

    function renderChoices(options) {
      choicesEl.innerHTML = "";
      options.forEach((option) => {
        const button = document.createElement("button");
        button.textContent = option.label;
        button.addEventListener("click", option.onClick);
        choicesEl.appendChild(button);
      });
    }

    function getRandomEvent() {
      const pool = randomEvents.filter((evt) => evt.condition(state));
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function triggerRandomEvent() {
      const chance = state.resources.energy < 25 ? 0.25 : 0.45;
      if (Math.random() < chance) {
        const evt = getRandomEvent();
        if (evt) {
          state.storyLog.push(`【随机事件】${evt.text}`);
          evt.effect(state);
        }
      }
    }

    function runTask(taskId) {
      const task = tasks.find((t) => t.id === taskId);
      if (!task) return;
      if (taskId === "useItem") {
        openInventory(true);
        return;
      }
      if (taskId === "date") {
        renderChoices([
          { label: "和浅羽朔见面", onClick: () => { tryMeeting("B"); } },
          { label: "和白澤凛司见面", onClick: () => { tryMeeting("A"); } },
          { label: "和久世伶见面", onClick: () => { tryMeeting("C"); } },
          { label: "返回", onClick: () => { renderChoices(getDefaultChoices()); } }
        ]);
        return;
      }
      task.effect(state);
      afterAction(`${task.name}完成。`, taskId);
    }

    function tryMeeting(guyId) {
      if (!state.guys[guyId].unlocked) {
        const hint = guyId === "A"
          ? "第4周：流程/预算审核卡死，需要白澤凛司签字解锁。"
          : "第6周：宣传位危机，需要久世伶协作解锁。";
        state.storyLog.push(`【未解锁】${hint}`);
        renderAll();
        return;
      }
      if (triggerTriangleEvent()) {
        return;
      }
      startMeeting(guyId);
    }

    function triggerTriangleEvent() {
      const candidates = Object.keys(state.guys).filter((id) => state.guys[id].unlocked && state.guys[id].affection >= 55 && state.guys[id].affection < 80);
      if (candidates.length < 2) return false;
      const chance = Math.min(0.2, 0.12 + (candidates.length - 2) * 0.04);
      if (Math.random() > chance) return false;
      state.flags.triangle = true;
      const text = "走廊的灯光在你头顶一盏盏亮起，像把人影切成几段，风声被关在窗外，只剩鞋底擦过地面的细响。你刚转身，浅羽朔就从另一侧快步走来，笑容温暖却带着一点不容置疑的熟稔：“我们以前不是一直一起走吗？”他伸手想替你挡住人潮，动作像把你护在记忆里。话音未落，白澤凛司已经站在你身侧，安静得像风停了，他的目光落在你们之间的距离上，冷静又精准：“你答应过要把流程改完。”他的手指轻轻点在资料夹上，像提醒也像占位。久世伶从广播室的门口靠近，手里捏着排班表，语气温柔得几乎像低语：“没关系，只要你选我就行。”他靠近时带着淡淡的皂香，视线却黏着你不放。三个人的目光像三条线交错，空气被拉紧，你的心跳被夹在缝隙里，既想安抚又怕偏向任何一边。你深吸一口气，听见自己的声音在走廊里回响，知道必须给出一个足够稳妥的收场。";
      state.storyLog.push(`【修罗场】${text}`);
      renderChoices([
        { label: "安抚浅羽朔", onClick: () => { addTrust(state, "B", 2); afterAction("你温声让浅羽朔先冷静下来。", "date"); } },
        { label: "安抚白澤凛司", onClick: () => { addTrust(state, "A", 2); afterAction("你向白澤凛司点头，表示会按流程走。", "date"); } },
        { label: "安抚久世伶", onClick: () => { addTrust(state, "C", 2); afterAction("你靠近久世伶，示意他别太逼迫你。", "date"); } }
      ]);
      return true;
    }

    function startMeeting(guyId) {
      tasks.find((t) => t.id === "date").effect(state);
      addResource(state, "energy", -8);
      addResource(state, "mood", 3);
      if (state.guys[guyId].affection >= 60) {
        addResource(state, "energy", 3);
      }
      const pool = meetingEvents[guyId];
      const event = pool[Math.floor(Math.random() * pool.length)];
      const callName = getCallName(guyId, state.guys[guyId].affection, state.guys[guyId].trust);
      const text = event.text.replace("{callName}", callName);
      state.storyLog.push(`【${guyProfiles[guyId].name}见面】${text}`);
      const giftOptions = getGiftOptions(guyId);
      if (giftOptions.length) {
        const giftChoices = giftOptions.map((gift) => ({
          label: `赠送${items[gift].name}（+3好感）`,
          onClick: () => {
            useItem(gift);
            removeItem(gift);
            state.storyLog.push(`你递出${items[gift].name}，对方视线微微一顿。`);
            renderMeetingChoices(event, guyId);
          }
        }));
        giftChoices.push({ label: "不送礼物", onClick: () => renderMeetingChoices(event, guyId) });
        renderChoices(giftChoices);
      } else {
        renderMeetingChoices(event, guyId);
      }
    }

    function renderMeetingChoices(event, guyId) {
      const optionChoices = event.options.map((option) => ({
        label: `${option.label}（${option.tags.join("/")}）`,
        onClick: () => {
          applyMeetingChoice(guyId, option.tags);
          if (Math.random() < 0.3) {
            gainItem(state, `clue${guyId}`);
          }
          afterAction(`你做出了选择。`, "date");
        }
      }));
      renderChoices(optionChoices);
    }

    function getGiftOptions(guyId) {
      const giftMap = { A: "bookmark", B: "sweets", C: "headset" };
      const giftId = giftMap[guyId];
      return state.inventory.includes(giftId) ? [giftId] : [];
    }

    function removeItem(itemId) {
      const index = state.inventory.indexOf(itemId);
      if (index >= 0) {
        state.inventory.splice(index, 1);
      }
    }

    function applyMeetingChoice(guyId, tags) {
      const profile = guyProfiles[guyId];
      let score = 0;
      tags.forEach((tag) => {
        if (profile.preferred.includes(tag)) score += 1;
        if (profile.disliked.includes(tag)) score -= 1;
      });
      let affChange = 0;
      let trustChange = 0;
      if (profile.mild) {
        if (score > 0) {
          affChange = clamp(2 + score * 2, 2, 6);
          trustChange = clamp(1 + score, 1, 4);
        } else if (score < 0) {
          affChange = -clamp(1 + Math.abs(score), 1, 4);
          trustChange = -clamp(Math.abs(score), 1, 3);
        } else {
          affChange = 1;
          trustChange = 0;
        }
      } else {
        if (score > 0) {
          affChange = clamp(6 + score * 2, 6, 12);
          trustChange = clamp(2 + score, 2, 6);
        } else if (score < 0) {
          affChange = 0;
          trustChange = -clamp(6 + Math.abs(score) * 2, 6, 12);
        } else {
          affChange = 2;
          trustChange = 0;
        }
      }
      addAffection(state, guyId, affChange);
      addTrust(state, guyId, trustChange);
    }

    function afterAction(summary, actionId = "") {
      state.storyLog.push(summary);
      state.actionsTaken += 1;
      if (state.daySummary) {
        state.daySummary.logs.push(summary);
      }
      if (actionId) {
        triggerMiniEvent(actionId);
      }
      triggerRandomEvent();
      checkAchievements();
      updateTrustStreak();
      if (state.resources.energy <= 0) {
        state.storyLog.push("【体力透支】你被强制休息一天，且获得1次回溯券。");
        state.rewindTokens += 1;
        state.forcedRest = true;
        state.actionsTaken = state.actionsPerDay;
      }
      renderAll();
    }

    function updateTrustStreak() {
      const lowTrust = Object.values(state.guys).some((g) => g.trust <= 25);
      if (lowTrust) {
        state.lowTrustDays += 1;
      } else {
        state.lowTrustDays = 0;
      }
    }

    function triggerMiniEvent(actionId) {
      if (actionId === "study" && state.guys.A.unlocked) {
        const base = 0.04;
        const scaling = (state.guys.A.affection / 100) * 0.08;
        const chance = Math.min(0.15, base + scaling);
        if (Math.random() < chance) {
          state.storyLog.push("【学习小事件】你翻到难题时，白澤凛司恰好经过，停下脚步给出清晰的推导。你发现他的讲解简短却有力，像在帮你把路灯一盏盏点亮。");
          addAffection(state, "A", 2);
          addTrust(state, "A", 1);
          addResource(state, "study", 1);
        }
      }
      if (actionId === "club") {
        const base = 0.08;
        const scaling = (state.guys.B.affection / 100) * 0.06;
        const chance = Math.min(0.18, base + scaling);
        if (Math.random() < chance) {
          state.storyLog.push("【社团小事件】浅羽朔帮你搬完物料，还顺手修好了摇晃的展架。他笑着说“交给我”，让你忍不住放松了一点。");
          addAffection(state, "B", 2);
          addResource(state, "mood", 1);
          addResource(state, "project", 1);
        }
      }
      if (actionId === "rest" && state.guys.C.unlocked) {
        const base = 0.015;
        const scaling = (state.guys.C.affection / 100) * 0.03;
        const chance = Math.min(0.06, base + scaling);
        if (Math.random() < chance) {
          state.storyLog.push("【休息小事件】你在图书馆角落小憩，久世伶的影子在书架边停住，他压低声音提醒你休息够了再走。那份靠近让你心跳慢了半拍。");
          addAffection(state, "C", 1);
          addTrust(state, "C", 1);
          addResource(state, "energy", 5);
        }
      }
    }

    function applyNightRecovery() {
      let recovery = 25;
      if (state.resources.mood >= 70) recovery += 5;
      addResource(state, "energy", recovery);
      state.storyLog.push(`夜间恢复：精力+${recovery}。`);
    }

    function checkUnlocks() {
      if (state.week >= 4 && !state.guys.A.unlocked) {
        state.guys.A.unlocked = true;
        state.storyLog.push("【主线解锁】校庆流程/预算审核卡死，你需要白澤凛司签字与校对，第一次正式对话就此展开。");
      }
      if (state.week >= 6 && !state.guys.C.unlocked) {
        state.guys.C.unlocked = true;
        state.storyLog.push("【主线解锁】宣传位被抢/谣言扩散，你不得不与久世伶交换信息与资源，合作关系正式建立。");
      }
    }

    function checkMainlineCheckpoint() {
      const prevWeek = state.week - 1;
      const stage = mainlineStages.find((item) => item.week === prevWeek);
      if (!stage) return false;
      if (state.resources.project < stage.target) {
        state.gameOver = true;
        state.storyLog.push(`【失败结局·${stage.title}】${stage.text}`);
        renderAll();
        renderChoices([{ label: "返回标题", onClick: showTitle }]);
        return true;
      }
      if (stage.passText) {
        state.storyLog.push(stage.passText);
      }
      return false;
    }

    function finalizeDay() {
      applyNightRecovery();
      if (state.forcedRest) {
        state.storyLog.push("【强制休息】今天不计入日程，你重新整理状态。");
        state.forcedRest = false;
      } else {
        state.day += 1;
        updateWeek();
        checkUnlocks();
        if (state.day % 7 === 1) {
          state.storyLog.push(`【周总结】第${state.week - 1}周结束，企划进度${state.resources.project}%。`);
          if (checkMainlineCheckpoint()) {
            return;
          }
        }
      }
      state.actionsTaken = 0;
      initDaySummary();
      if (state.day > maxDay) {
        endGame();
      } else {
        state.storyLog.push(`第${state.day}天开始。`);
        renderAll();
      }
    }

    function openSettlement() {
      const summary = state.daySummary;
      if (!summary) return;
      const resDelta = Object.entries(state.resources).map(([key, value]) => {
        const delta = value - summary.startResources[key];
        return `<div class="small">${resourceLabels[key]}：${delta >= 0 ? "+" : ""}${delta}</div>`;
      }).join("");
      const guyDelta = Object.keys(state.guys).map((id) => {
        const start = summary.startGuys[id];
        const current = state.guys[id];
        const aff = current.affection - start.affection;
        const trust = current.trust - start.trust;
        return `<div class="small">${guyStories[id].name} 好感${aff >= 0 ? "+" : ""}${aff} / 信任${trust >= 0 ? "+" : ""}${trust}</div>`;
      }).join("");
      const itemsGained = summary.items.length ? summary.items.map((i) => `<li>${i}</li>`).join("") : "<li>无</li>";
      const cluesGained = summary.clues.length ? summary.clues.map((c) => `<li>${c}</li>`).join("") : "<li>无</li>";
      settlementBody.innerHTML = `
        <div class="small">资源变化</div>
        ${resDelta}
        <hr />
        <div class="small">男主变化</div>
        ${guyDelta}
        <hr />
        <div class="small">获得道具</div>
        <ul>${itemsGained}</ul>
        <div class="small">解锁线索</div>
        <ul>${cluesGained}</ul>
      `;
      settlementModal.classList.add("active");
    }

    function endGame() {
      const mainSuccess = state.resources.project >= 100;
      if (!mainSuccess) {
        state.storyLog.push("【失败结局】校庆企划未达标，你不得不接受直接失败的结果。");
        renderAll();
        renderChoices([{ label: "返回标题", onClick: showTitle }]);
        return;
      }
      state.storyLog.push(mainlineSuccessText);

      const endings = [];
      if (mainSuccess) {
        const trueEndings = Object.entries(state.guys).filter(([, g]) => g.affection >= 80 && g.trust >= 70 && g.storyTier === 2 && g.storyIndex >= 3);
        if (trueEndings.length > 0) {
          endings.push(...trueEndings.map(([id]) => `【真结局】与${guyStories[id].name}的心意在校庆夜明朗。`));
        }
        const normalEndings = Object.entries(state.guys).filter(([, g]) => g.affection >= 60 && g.trust >= 50);
        if (normalEndings.length > 0) {
          endings.push(...normalEndings.map(([id]) => `【普通恋爱结局】你与${guyStories[id].name}在舞台幕布后相拥。`));
        }
        if (endings.length === 0) {
          endings.push("【友情结局】校庆圆满结束，你收获了坚定的伙伴。" );
        }
      }
      state.storyLog.push("\n" + endings.join("\n"));
      renderAll();
      renderChoices([{ label: "返回标题", onClick: showTitle }]);
    }

    function checkAchievements() {
      achievements.forEach((ach) => {
        if (!state.achievements.includes(ach.id) && ach.check(state)) {
          state.achievements.push(ach.id);
          state.storyLog.push(`【成就达成】${ach.name}`);
          if (ach.rewardItem) {
            gainItem(state, ach.rewardItem);
          }
          if (ach.rewardRewind) {
            state.rewindTokens += ach.rewardRewind;
          }
        }
      });
    }

    function openAchievements() {
      achievementList.innerHTML = achievements.map((ach) => {
        const done = state.achievements.includes(ach.id);
        return `<div class="item"><strong>${done ? "✓" : "○"} ${ach.name}</strong><div class="small">${ach.desc}</div></div>`;
      }).join("");
      achievementModal.classList.add("active");
    }

    function openInventory(allowUse = false) {
      inventoryList.innerHTML = state.inventory.map((itemId, index) => {
        const item = items[itemId];
        const useBtn = allowUse ? `<button class="btn" data-index="${index}">使用</button>` : "";
        return `<div class="item"><strong>${item.name}</strong> <span class="badge">${item.type}</span><div class="small">${item.desc}</div>${useBtn}</div>`;
      }).join("");
      inventoryModal.classList.add("active");
      if (allowUse) {
        inventoryList.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", () => {
            const index = Number(btn.dataset.index);
            useItem(state.inventory[index]);
            state.inventory.splice(index, 1);
            inventoryModal.classList.remove("active");
            afterAction("你使用了道具。");
          });
        });
      }
    }

    function useItem(itemId) {
      const item = items[itemId];
      if (item) {
        item.effect(state);
      }
    }

    function openShop() {
      document.getElementById("shopMoney").textContent = state.resources.money;
      const list = document.getElementById("shopList");
      list.innerHTML = shopItems.map((item) => {
        const canBuy = state.resources.money >= item.cost;
        return `
          <div class="item">
            <strong>${item.name}</strong>
            <span class="badge">¥${item.cost}</span>
            <div class="small">${item.desc}</div>
            <button class="btn" data-id="${item.id}" ${canBuy ? "" : "disabled"}>购买</button>
          </div>
        `;
      }).join("");
      list.querySelectorAll("button").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const item = shopItems.find((entry) => entry.id === id);
          if (!item) return;
          if (state.resources.money < item.cost) {
            state.storyLog.push("金钱不足，无法购买。");
            renderAll();
            return;
          }
          addResource(state, "money", -item.cost);
          gainItem(state, id);
          openShop();
        });
      });
      document.getElementById("shopModal").classList.add("active");
    }

    function renderAll() {
      renderResources();
      renderCharacters();
      renderTasks();
      renderStory();
      renderDayInfo();
      if (state.day === 1 && state.actionsTaken === 0 && state.playerName === defaultName && !state.flags.nameHintShown
        && !nameModal.classList.contains("active") && !mainlineWarningModal.classList.contains("active")) {
        state.flags.nameHintShown = true;
        document.getElementById("nameHintModal").classList.add("active");
      }
      if (!state.gameOver && state.day <= maxDay) {
        renderChoices(getDefaultChoices());
      } else if (state.gameOver) {
        renderChoices([{ label: "返回标题", onClick: showTitle }]);
      }
    }

    function getDefaultChoices() {
      if (state.actionsTaken >= state.actionsPerDay) {
        return [{ label: "结束今天", onClick: () => openSettlement() }];
      }
      let priorityTasks = tasks.filter((task) => task.condition(state));
      if (state.resources.energy < 25) {
        const urgentIds = ["emergencyRest", "canteen", "seekB"];
        const urgentTasks = priorityTasks.filter((task) => urgentIds.includes(task.id));
        const normalTasks = priorityTasks.filter((task) => !urgentIds.includes(task.id));
        priorityTasks = [...urgentTasks, ...normalTasks];
      }
      const options = priorityTasks.map((task) => ({
        label: task.name,
        onClick: () => runTask(task.id)
      }));
      options.push({ label: "查看本周目标", onClick: () => state.storyLog.push(`【提示】${weekGoals[state.week - 1]}`) || renderAll() });
      options.push({ label: "查看回溯次数", onClick: () => { state.storyLog.push(`当前回溯次数：${state.rewindTokens}`); renderAll(); } });
      return options.slice(0, 5);
    }

    function showTitle() {
      state.storyLog.push("【标题】选择“新游戏”开始你的12周旅程。");
      renderAll();
    }

    function openTutorial(startIndex = 0) {
      let step = startIndex;
      const renderStep = () => {
        tutorialBody.innerHTML = `<p>${tutorialSteps[step]}</p>`;
        tutorialControls.innerHTML = "";
        const prevBtn = document.createElement("button");
        prevBtn.className = "btn";
        prevBtn.textContent = "上一步";
        prevBtn.disabled = step === 0;
        prevBtn.addEventListener("click", () => { step = Math.max(0, step - 1); renderStep(); });
        const nextBtn = document.createElement("button");
        nextBtn.className = "btn";
        nextBtn.textContent = step === tutorialSteps.length - 1 ? "完成" : "下一步";
        nextBtn.addEventListener("click", () => {
          if (step === tutorialSteps.length - 1) {
            tutorialModal.classList.remove("active");
          } else {
            step += 1;
            renderStep();
          }
        });
        const skipBtn = document.createElement("button");
        skipBtn.className = "btn";
        skipBtn.textContent = "跳过";
        skipBtn.addEventListener("click", () => tutorialModal.classList.remove("active"));
        tutorialControls.append(prevBtn, nextBtn, skipBtn);
      };
      renderStep();
      tutorialModal.classList.add("active");
    }

    function openNameModal(mode = "rename") {
      nameModalMode = mode;
      const input = document.getElementById("nameInput");
      input.value = state.playerName || defaultName;
      nameModal.classList.add("active");
    }

    function applyPlayerName(name) {
      state.playerName = name && name.trim() ? name.trim() : defaultName;
      if (nameModalMode === "newgame") {
        state.storyLog = [`${state.playerName}在新学期第1周回到校园。一天有3次行动，校庆企划等着你。`];
        initDaySummary();
        renderAll();
        openTutorial(0);
        if (state.settings.showMainlineWarning) {
          mainlineWarningModal.classList.add("active");
        }
      } else {
        state.storyLog.push(`【改名】你决定使用新的名字：${state.playerName}。`);
        renderAll();
      }
    }

    function newGame() {
      state = stateTemplate();
      openNameModal("newgame");
      renderAll();
    }

    function saveGame() {
      const slot = prompt("存档位：1/2/3", "1");
      if (!slot) return;
      localStorage.setItem(`otome_save_${slot}`, JSON.stringify(state));
      state.storyLog.push(`【存档】已保存到存档位${slot}。`);
      renderAll();
    }

    function loadGame() {
      const slot = prompt("读档位：1/2/3", "1");
      if (!slot) return;
      const data = localStorage.getItem(`otome_save_${slot}`);
      if (data) {
        state = JSON.parse(data);
        if (!state.playerName) {
          state.playerName = state.name || defaultName;
        }
        ["A", "B", "C"].forEach((id) => {
          if (state.guys[id] && state.guys[id].unlocked == null) {
            state.guys[id].unlocked = id === "B";
          }
        });
        if (state.actionsPerDay == null) state.actionsPerDay = 3;
        if (state.actionsTaken == null) state.actionsTaken = 0;
        if (state.forcedRest == null) state.forcedRest = false;
        if (!state.daySummary) {
          initDaySummary();
        }
        if (!state.settings) state.settings = { showMainlineWarning: true };
        if (!state.flags) state.flags = { firstDate: false, triangle: false, nameHintShown: false };
        if (state.gameOver == null) state.gameOver = false;
        if (state.resources.clubEff == null) state.resources.clubEff = 0;
        checkUnlocks();
        state.storyLog.push(`【读档】已读取存档位${slot}。`);
      } else {
        state.storyLog.push("【读档】该存档位为空。");
      }
      renderAll();
    }

    document.getElementById("newGame").addEventListener("click", newGame);
    document.getElementById("saveGame").addEventListener("click", saveGame);
    document.getElementById("loadGame").addEventListener("click", loadGame);
    document.getElementById("toTitle").addEventListener("click", showTitle);
    document.getElementById("openTutorial").addEventListener("click", () => openTutorial(0));
    document.getElementById("renamePlayer").addEventListener("click", () => openNameModal("rename"));
    document.getElementById("openShop").addEventListener("click", () => openShop());
    document.getElementById("openSettings").addEventListener("click", () => {
      document.getElementById("toggleMainlineWarning").checked = state.settings.showMainlineWarning;
      settingsModal.classList.add("active");
    });
    document.getElementById("openAchievements").addEventListener("click", openAchievements);
    document.getElementById("closeAchievements").addEventListener("click", () => achievementModal.classList.remove("active"));
    document.getElementById("openInventory").addEventListener("click", () => openInventory(false));
    document.getElementById("closeInventory").addEventListener("click", () => inventoryModal.classList.remove("active"));
    document.getElementById("confirmSettlement").addEventListener("click", () => {
      settlementModal.classList.remove("active");
      finalizeDay();
    });
    document.getElementById("confirmName").addEventListener("click", () => {
      const value = document.getElementById("nameInput").value;
      nameModal.classList.remove("active");
      applyPlayerName(value);
    });
    document.getElementById("skipName").addEventListener("click", () => {
      nameModal.classList.remove("active");
      applyPlayerName(defaultName);
    });
    document.getElementById("renameNow").addEventListener("click", () => {
      nameHintModal.classList.remove("active");
      openNameModal("rename");
    });
    document.getElementById("renameLater").addEventListener("click", () => {
      nameHintModal.classList.remove("active");
    });
    document.getElementById("ackWarning").addEventListener("click", () => {
      mainlineWarningModal.classList.remove("active");
      renderAll();
    });
    document.getElementById("skipWarning").addEventListener("click", () => {
      state.settings.showMainlineWarning = false;
      mainlineWarningModal.classList.remove("active");
      renderAll();
    });
    document.getElementById("toggleMainlineWarning").addEventListener("change", (event) => {
      state.settings.showMainlineWarning = event.target.checked;
    });
    document.getElementById("closeSettings").addEventListener("click", () => {
      settingsModal.classList.remove("active");
    });
    document.getElementById("closeShop").addEventListener("click", () => {
      document.getElementById("shopModal").classList.remove("active");
    });

    // 如何添加新事件/新道具/新成就/新行动：
    // 1) 新行动：在 tasks 中新增对象，并配置 desc/effect/condition（行动点会自动计数）。
    // 2) 新事件：在 randomEvents 或 meetingEvents 中追加对象，包含 text/options。
    // 3) 新道具：在 items 中新增条目，并可在事件或成就奖励里 gainItem。
    // 4) 新成就：在 achievements 中追加对象，提供 check 逻辑与奖励。
    // 5) 精力曲线：修改 tasks 的精力消耗、applyNightRecovery 的恢复值、或补给道具的恢复量。
    // 6) 称呼分段：调整 getCallName 内各阶段返回值。
    // 7) 小事件概率：调整 triggerMiniEvent 内的 base/scaling/上限。

    renderAll();
  </script>
</body>
</html>
