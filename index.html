<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç²‰é»‘ä¹™å¥³ï¼šæ ¡åº†å¿ƒåŠ¨ä¼åˆ’</title>
  <style>
    :root {
      --bg: #0b0b12;
      --panel: #141420;
      --panel-2: #1f1a2a;
      --accent: #ff4f99;
      --accent-2: #ff8ac2;
      --text: #f5e9f2;
      --muted: #b7a6c6;
      --danger: #ff4f6d;
      --good: #7dffb0;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "PingFang SC", "Noto Sans CJK SC", "Microsoft Yahei", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top, #1b0c1f 0%, #08070d 65%);
      min-height: 100vh;
    }
    header {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 16px 20px;
      background: #09090f;
      border-bottom: 1px solid #2d2033;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 2px;
      color: var(--accent-2);
      flex: 1;
    }
    .btn {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--accent);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s ease;
    }
    .btn:hover {
      background: var(--accent);
      color: #0b0b12;
    }
    .container {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 16px;
      padding: 20px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid #2d2033;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    }
    .panel h2 {
      margin: 0 0 10px;
      font-size: 16px;
      color: var(--accent-2);
    }
    .stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .stat .bar {
      flex: 1;
      height: 8px;
      background: #2a2035;
      border-radius: 999px;
      margin-left: 10px;
      overflow: hidden;
    }
    .bar span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #a95bff);
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #2c1b33;
      color: var(--accent-2);
      margin-right: 6px;
    }
    .task-list {
      display: grid;
      gap: 8px;
    }
    .task {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #2d2033;
      background: var(--panel-2);
      font-size: 13px;
    }
    .task small {
      color: var(--muted);
      display: block;
      margin-top: 4px;
    }
    .story {
      min-height: 340px;
      max-height: 420px;
      overflow-y: auto;
      background: rgba(9, 7, 12, 0.7);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #2d2033;
      line-height: 1.7;
    }
    .story p {
      margin: 0 0 12px;
    }
    .choices {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 16px;
    }
    .choices button {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--accent-2);
      background: #1b1223;
      color: var(--text);
      cursor: pointer;
      transition: 0.2s ease;
    }
    .choices button:hover {
      background: var(--accent-2);
      color: #0b0b12;
    }
    .right-panel .character {
      border-bottom: 1px solid #2d2033;
      padding-bottom: 12px;
      margin-bottom: 12px;
    }
    .character h3 {
      margin: 0 0 8px;
      font-size: 15px;
      color: var(--accent-2);
    }
    .small {
      font-size: 12px;
      color: var(--muted);
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: var(--panel);
      border: 1px solid #2d2033;
      border-radius: 12px;
      padding: 20px;
      width: min(640px, 90vw);
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content h2 {
      margin-top: 0;
      color: var(--accent-2);
    }
    .inventory {
      display: grid;
      gap: 8px;
      margin-top: 8px;
    }
    .inventory .item {
      background: #1d1525;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #2d2033;
    }
    footer {
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      padding: 20px 0 30px;
    }
    .highlight {
      color: var(--accent-2);
    }
  </style>
</head>
<body>
  <header>
    <h1>ç²‰é»‘ä¹™å¥³ï¼šæ ¡åº†å¿ƒåŠ¨ä¼åˆ’</h1>
    <button class="btn" id="newGame">æ–°æ¸¸æˆ</button>
    <button class="btn" id="saveGame">å­˜æ¡£</button>
    <button class="btn" id="loadGame">è¯»æ¡£</button>
    <button class="btn" id="toTitle">è¿”å›æ ‡é¢˜</button>
    <button class="btn" id="openTutorial">å¸®åŠ©/æ•™ç¨‹</button>
    <button class="btn" id="renamePlayer">ä¿®æ”¹åå­—</button>
    <button class="btn" id="openSettings">è®¾ç½®</button>
  </header>

  <div class="container">
    <aside class="panel">
      <h2>èµ„æºé¢æ¿</h2>
      <div class="small" id="actionInfo"></div>
      <div class="stat">ç²¾åŠ› <span id="energyValue">0</span><div class="bar"><span id="energyBar"></span></div></div>
      <div class="stat">é‡‘é’± <span id="moneyValue">0</span><div class="bar"><span id="moneyBar"></span></div></div>
      <div class="stat">å¿ƒæƒ… <span id="moodValue">0</span><div class="bar"><span id="moodBar"></span></div></div>
      <div class="stat">å­¦ä¸š <span id="studyValue">0</span><div class="bar"><span id="studyBar"></span></div></div>
      <div class="stat">ä¼åˆ’è¿›åº¦ <span id="projectValue">0</span><div class="bar"><span id="projectBar"></span></div></div>
      <div class="small" id="projectHint">æœªè¾¾æ ‡å°†ç›´æ¥å¤±è´¥</div>
      <div class="small" id="weekGoal"></div>
      <hr />
      <h2>æ¯æ—¥ä»»åŠ¡æ¸…å•</h2>
      <div class="task-list" id="taskList"></div>
      <div style="margin-top:12px;">
        <button class="btn" id="openAchievements">æˆå°±å…¥å£</button>
        <button class="btn" id="openInventory">é“å…·</button>
      </div>
    </aside>

    <main class="panel">
      <div class="small" id="dayInfo"></div>
      <div class="story" id="story"></div>
      <div class="choices" id="choices"></div>
    </main>

    <aside class="panel right-panel">
      <h2>ç”·ä¸»çŠ¶æ€</h2>
      <div class="character" id="charA"></div>
      <div class="character" id="charB"></div>
      <div class="character" id="charC"></div>
    </aside>
  </div>

  <div class="modal" id="achievementModal">
    <div class="modal-content">
      <h2>æˆå°±</h2>
      <div id="achievementList"></div>
      <button class="btn" id="closeAchievements">å…³é—­</button>
    </div>
  </div>

  <div class="modal" id="inventoryModal">
    <div class="modal-content">
      <h2>é“å…·</h2>
      <div class="inventory" id="inventoryList"></div>
      <button class="btn" id="closeInventory">å…³é—­</button>
    </div>
  </div>

  <div class="modal" id="settlementModal">
    <div class="modal-content">
      <h2>ä»Šæ—¥ç»“ç®—</h2>
      <div id="settlementBody"></div>
      <button class="btn" id="confirmSettlement">è¿›å…¥ä¸‹ä¸€å¤©</button>
    </div>
  </div>

  <div class="modal" id="tutorialModal">
    <div class="modal-content">
      <h2>æ–°æ‰‹æ•™ç¨‹</h2>
      <div id="tutorialBody"></div>
      <div class="choices" id="tutorialControls"></div>
    </div>
  </div>

  <div class="modal" id="nameModal">
    <div class="modal-content">
      <h2>ä¸ºå¥³ä¸»å‘½å</h2>
      <div class="small">é»˜è®¤åï¼šæœªæ•£ï¼Œå¯éšæ—¶ä¿®æ”¹ã€‚</div>
      <input id="nameInput" type="text" style="width:100%;padding:8px;margin:12px 0;border-radius:6px;border:1px solid #2d2033;background:#0d0a13;color:var(--text);" />
      <div class="choices">
        <button class="btn" id="confirmName">ç¡®è®¤</button>
        <button class="btn" id="skipName">è·³è¿‡(ä½¿ç”¨æœªæ•£)</button>
      </div>
    </div>
  </div>

  <div class="modal" id="nameHintModal">
    <div class="modal-content">
      <h2>å°æç¤º</h2>
      <p>å»ºè®®æ”¹åå¢å¼ºä»£å…¥æ„Ÿã€‚</p>
      <div class="choices">
        <button class="btn" id="renameNow">ç°åœ¨æ”¹å</button>
        <button class="btn" id="renameLater">ç¨åå†è¯´</button>
      </div>
    </div>
  </div>

  <div class="modal" id="mainlineWarningModal">
    <div class="modal-content">
      <h2>é‡è¦æç¤º</h2>
      <p>ä¸»çº¿æ ¡åº†ä¼åˆ’å¿…é¡»å®Œæˆï¼Œå¦åˆ™ç›´æ¥å¤±è´¥ã€‚å»ºè®®ä¼˜å…ˆæ¨è¿›ä¸»çº¿ï¼Œå†å®‰æ’çº¦ä¼šã€‚</p>
      <div class="choices">
        <button class="btn" id="ackWarning">æˆ‘çŸ¥é“äº†</button>
        <button class="btn" id="skipWarning">ä¸å†æç¤º</button>
      </div>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <h2>è®¾ç½®</h2>
      <label class="small"><input type="checkbox" id="toggleMainlineWarning" /> æ˜¾ç¤ºä¸»çº¿å¤±è´¥æé†’</label>
      <div style="margin-top:12px;">
        <button class="btn" id="closeSettings">å…³é—­</button>
      </div>
    </div>
  </div>

  <footer>ç²‰é»‘ä¹™å¥³é£ Â· ç°ä»£æ ¡å›­ Â· ä¸€å¤©3æ¬¡è¡ŒåŠ¨ Â· 12å‘¨ä¸€å‘¨ç›® Demo</footer>

  <script>
    const maxDay = 84;
    const maxWeek = 12;
    const defaultName = "æœªæ•£";

    const weekGoals = [
      "ç¬¬1å‘¨ï¼šç«‹é¡¹ä¸åˆ†å·¥ï¼Œè‡³å°‘æ¨è¿›10%",
      "ç¬¬2å‘¨ï¼šæ ¡åº†ä¸»é¢˜ç¡®è®¤ï¼Œè‡³å°‘æ¨è¿›18%",
      "ç¬¬3å‘¨ï¼šæ‹‰èµåŠ©&å±•å°æ–¹æ¡ˆï¼Œè‡³å°‘æ¨è¿›26%",
      "ç¬¬4å‘¨ï¼šèˆå°èŠ‚ç›®å®šæ¡ˆï¼Œè‡³å°‘æ¨è¿›34%",
      "ç¬¬5å‘¨ï¼šèŠ‚ç›®è¯•æ’ï¼Œè‡³å°‘æ¨è¿›42%",
      "ç¬¬6å‘¨ï¼šå±•å°åˆ¶ä½œå¯åŠ¨ï¼Œè‡³å°‘æ¨è¿›50%",
      "ç¬¬7å‘¨ï¼šç¬¬ä¸€è½®å½©æ’ï¼Œè‡³å°‘æ¨è¿›58%",
      "ç¬¬8å‘¨ï¼šå±æœºå¤„ç†ä¸è°ƒæ•´ï¼Œè‡³å°‘æ¨è¿›66%",
      "ç¬¬9å‘¨ï¼šäºŒè½®å½©æ’ï¼Œè‡³å°‘æ¨è¿›74%",
      "ç¬¬10å‘¨ï¼šç‰©èµ„åˆ°ä½ï¼Œè‡³å°‘æ¨è¿›82%",
      "ç¬¬11å‘¨ï¼šæœ€ç»ˆå½©æ’ï¼Œè‡³å°‘æ¨è¿›90%",
      "ç¬¬12å‘¨ï¼šæ ¡åº†å½“å¤©ï¼Œå®Œæˆ100%"
    ];

    const milestoneEvents = [
      { threshold: 10, text: "ã€ä¸»çº¿ã€‘æ ¡åº†ä¼åˆ’æ­£å¼ç«‹é¡¹ï¼Œä½ è¢«æ¨ä¸ºå±•å°è”ç»œäººã€‚" },
      { threshold: 18, text: "ã€ä¸»çº¿ã€‘ä¸»é¢˜ç¡®è®¤ï¼šç²‰é»‘å­¦é™¢æ‹çˆ±å‰§åœºã€‚" },
      { threshold: 26, text: "ã€ä¸»çº¿ã€‘èµåŠ©è°ˆåˆ¤å¼€å±€ï¼Œç™½æ¾¤å‡›å¸é»˜é»˜é€’æ¥é¢„ç®—æ¨¡æ¿ã€‚" },
      { threshold: 34, text: "ã€ä¸»çº¿ã€‘èŠ‚ç›®å®šæ¡ˆï¼šä¸‰ç”·ä¸»è”åŠ¨çš„æ ¡å›­èˆå°å‰§ã€‚" },
      { threshold: 50, text: "ã€ä¸»çº¿ã€‘å±•å°åˆ¶ä½œå¼€å·¥ï¼Œææ–™æ¸…å•æ’åˆ°çˆ†ã€‚" },
      { threshold: 58, text: "ã€ä¸»çº¿ã€‘ç¬¬ä¸€æ¬¡å½©æ’ï¼Œæµ…ç¾½æœ”æŠŠæ°”æ°›å¸¦å¾—åƒæ´¾å¯¹ã€‚" },
      { threshold: 66, text: "ã€ä¸»çº¿ã€‘çªå‘å±æœºï¼šèµåŠ©ç¼©æ°´ï¼Œéœ€è¦ä¸´æ—¶è¡¥æ•‘ã€‚" },
      { threshold: 74, text: "ã€ä¸»çº¿ã€‘äºŒè½®å½©æ’ï¼Œä¹…ä¸–ä¼¶çš„å°è¯æ”¹å¾—æ›´â€œè´´è¿‘ä½ â€ã€‚" },
      { threshold: 82, text: "ã€ä¸»çº¿ã€‘ç‰©èµ„åˆ°ä½ï¼Œå±•å°åˆæˆå‹ã€‚" },
      { threshold: 90, text: "ã€ä¸»çº¿ã€‘æœ€ç»ˆå½©æ’ï¼Œä½ ç«™åœ¨èˆå°ä¸­å¤®ã€‚" },
      { threshold: 100, text: "ã€ä¸»çº¿ã€‘æ ¡åº†å½“æ—¥ï¼Œæ‰€æœ‰äººéƒ½åœ¨ç­‰ä½ çš„æŒ‡æŒ¥ã€‚" }
    ];

    const guyProfiles = {
      B: {
        name: "æµ…ç¾½ æœ”",
        roman: "Asaba Saku",
        label: "ç«¹é©¬",
        preferred: ["å–„è‰¯", "ä½“è´´", "å¦ç‡", "è¾¹ç•Œæ„Ÿ"],
        disliked: ["æ¶è¶£å‘³", "æ“æ§", "å†·æ¼ "],
        mild: true
      },
      A: {
        name: "ç™½æ¾¤ å‡›å¸",
        roman: "Shirasawa Rinji",
        label: "å­¦éœ¸",
        preferred: ["å®ˆè§„çŸ©", "ä¸Šè¿›", "å¦ç‡", "å°Šé‡è¾¹ç•Œ", "æ•ˆç‡"],
        disliked: ["èƒ¡é—¹", "ä½æ•ˆç‡", "æ¶è¶£å‘³"],
        mild: true
      },
      C: {
        name: "ä¹…ä¸– ä¼¶",
        roman: "Kuze Rei",
        label: "ç—…å¨‡",
        preferred: ["è¯•æ¢", "æ¶è¶£å‘³", "å æœ‰", "ä¿¡æ¯å·®", "å°è°è¨€"],
        disliked: ["å…¬å¼€æ‹’ç»", "å¼ºè°ƒè¾¹ç•Œ", "æŠŠä»–å½“å¤–äºº"],
        mild: false
      }
    };

    const items = {
      snack: { name: "èƒ½é‡å°é¥¼å¹²", type: "è¡¥ç»™", desc: "ç²¾åŠ›+15", effect: (state) => addResource(state, "energy", 15) },
      meal: { name: "é£Ÿå ‚çƒ­é¤", type: "è¡¥ç»™", desc: "ç²¾åŠ›+25", effect: (state) => addResource(state, "energy", 25) },
      bento: { name: "ä¾¿å½“ç›’", type: "è¡¥ç»™", desc: "ç²¾åŠ›+30 å¿ƒæƒ…+4", effect: (state) => { addResource(state, "energy", 30); addResource(state, "mood", 4); } },
      tonic: { name: "è¡¥ç»™é¥®", type: "è¡¥ç»™", desc: "ç²¾åŠ›+40 å¿ƒæƒ…+2", effect: (state) => { addResource(state, "energy", 40); addResource(state, "mood", 2); } },
      note: { name: "çµæ„Ÿä¾¿ç¬º", type: "è¡¥ç»™", desc: "ä¼åˆ’è¿›åº¦+6", effect: (state) => addResource(state, "project", 6) },
      charm: { name: "é»‘æ¡ƒå‘å¤¹", type: "ç¤¼ç‰©", desc: "é€ç»™ç™½æ¾¤å‡›å¸ï¼Œå¥½æ„Ÿ+6", effect: (state) => giftTo(state, "A", 6) },
      soda: { name: "è‰è“æ±½æ°´", type: "ç¤¼ç‰©", desc: "é€ç»™æµ…ç¾½æœ”ï¼Œå¥½æ„Ÿ+6", effect: (state) => giftTo(state, "B", 6) },
      ribbon: { name: "æš—çº¢ä¸å¸¦", type: "ç¤¼ç‰©", desc: "é€ç»™ä¹…ä¸–ä¼¶ï¼Œå¥½æ„Ÿ+6", effect: (state) => giftTo(state, "C", 6) },
      ticket: { name: "æ¼”å‡ºåˆ¸", type: "çºªå¿µå“", desc: "å¿ƒæƒ…+10ï¼Œéšæœºç”·ä¸»ä¿¡ä»»+4", effect: (state) => { addResource(state, "mood", 10); randomTrust(state, 4); } },
      clueA: { name: "Açš„æ—§å¥–çŠ¶", type: "çº¿ç´¢", desc: "è§£é”Açš„èƒŒæ™¯æ•…äº‹", effect: (state) => addClue(state, "A") },
      clueB: { name: "Bçš„æ—§ç…§ç‰‡", type: "çº¿ç´¢", desc: "è§£é”Bçš„èƒŒæ™¯æ•…äº‹", effect: (state) => addClue(state, "B") },
      clueC: { name: "Cçš„å¹¿æ’­æ‰‹ç¨¿", type: "çº¿ç´¢", desc: "è§£é”Cçš„èƒŒæ™¯æ•…äº‹", effect: (state) => addClue(state, "C") }
    };

    const achievements = [
      { id: "study7", name: "å­¦éœ¸å…»æˆ", desc: "è¿ç»­å­¦ä¹ 7å¤©", reward: "çµæ„Ÿä¾¿ç¬º", rewardItem: "note", check: (s) => s.streaks.study >= 7 },
      { id: "firstDate", name: "ç¬¬ä¸€æ¬¡çº¦ä¼š", desc: "å®Œæˆä»»æ„ç”·ä¸»çº¦ä¼š", reward: "è‰è“æ±½æ°´", rewardItem: "soda", check: (s) => s.flags.firstDate },
      { id: "secret", name: "æ­å¼€ç§˜å¯†", desc: "ä»»æ„ç”·ä¸»æ•…äº‹è§£é”åˆ°æ ¸å¿ƒçœŸç›¸", reward: "å›æº¯+1", rewardRewind: 1, check: (s) => Object.values(s.guys).some((g) => g.storyTier === 2 && g.storyIndex >= 3) },
      { id: "project50", name: "æ ¡åº†æ¨è¿›50%", desc: "ä¼åˆ’è¿›åº¦è¾¾åˆ°50%", reward: "èƒ½é‡å°é¥¼å¹²", rewardItem: "snack", check: (s) => s.resources.project >= 50 },
      { id: "triangle", name: "ä¸‰äººä¿®ç½—åœºå­˜æ´»", desc: "åŒæ—¥è§¦å‘ä¸¤ä½ç”·ä¸»äº‹ä»¶", reward: "å›æº¯+1", rewardRewind: 1, check: (s) => s.flags.triangle },
      { id: "support", name: "æ”¯æ´è€…", desc: "ç´¯è®¡ä¼åˆ’æ¨è¿›20æ¬¡", reward: "çµæ„Ÿä¾¿ç¬º", rewardItem: "note", check: (s) => s.stats.projectTasks >= 20 },
      { id: "workaholic", name: "å‹¤åŠ³æ‰“å·¥äºº", desc: "ç´¯è®¡æ‰“å·¥10æ¬¡", reward: "æ¼”å‡ºåˆ¸", rewardItem: "ticket", check: (s) => s.stats.partTime >= 10 },
      { id: "clubStar", name: "ç¤¾å›¢æ˜æ˜Ÿ", desc: "ç´¯è®¡ç¤¾å›¢æ´»åŠ¨10æ¬¡", reward: "æš—çº¢ä¸å¸¦", rewardItem: "ribbon", check: (s) => s.stats.club >= 10 },
      { id: "restMaster", name: "è‡ªæˆ‘ç–—æ„ˆ", desc: "ä¼‘æ¯æ¬¡æ•°è¾¾12æ¬¡", reward: "èƒ½é‡å°é¥¼å¹²", rewardItem: "snack", check: (s) => s.stats.rest >= 12 },
      { id: "affection70", name: "å¿ƒåŠ¨ä¸´ç•Œ", desc: "ä»»æ„ç”·ä¸»å¥½æ„Ÿ>=70", reward: "å›æº¯+1", rewardRewind: 1, check: (s) => Object.values(s.guys).some((g) => g.affection >= 70) },
      { id: "trust70", name: "ä¿¡èµ–ä¸´ç•Œ", desc: "ä»»æ„ç”·ä¸»ä¿¡ä»»>=70", reward: "æ¼”å‡ºåˆ¸", rewardItem: "ticket", check: (s) => Object.values(s.guys).some((g) => g.trust >= 70) },
      { id: "week12", name: "åšæŒåˆ°åº•", desc: "å®Œæˆ12å‘¨", reward: "ç»ˆå±€å›æº¯+1", rewardRewind: 1, check: (s) => s.day > maxDay }
    ];

    const guyStories = {
      A: {
        name: "ç™½æ¾¤ å‡›å¸",
        layers: [
          ["ä»–æ€»åœ¨å›¾ä¹¦é¦†å›ºå®šåº§ä½ï¼Œåƒä¸€æ¡å†·æ¸…çš„èµ°å»Šã€‚", "å¯¹ç¤¾å›¢æ´»åŠ¨ä¸å±‘ä¸€é¡¾ï¼Œè§†ç¤¾äº¤ä¸ºæµªè´¹ã€‚", "ä»–æ‹’ç»åˆç…§ï¼Œç†ç”±æ˜¯â€œæ²¡å¿…è¦â€ã€‚"],
          ["å®¶é‡Œå¯¹ä»–â€œå¿…é¡»ç¬¬ä¸€â€çš„é«˜å‹è®©ä»–ä¹ æƒ¯æŠŠæƒ…ç»ªå‹æˆé™éŸ³ã€‚", "ä»–æš—ä¸­åœ¨åšæ ¡åº†èµåŠ©ç”³è¯·ï¼Œå´ä¸æ„¿è¯´å‡ºå£ã€‚", "ä»–æŠŠå¿™ç¢Œå½“æˆé˜²æŠ¤ç½©ï¼Œåªç•™ç»™ä½ ä¸€ä¸æ¸©åº¦ã€‚"],
          ["ä»–æ›¾å› ä¸€æ¬¡â€œæ”¾å¼ƒæœºä¼šå»æ•‘äººâ€å¯¼è‡´æˆç»©å—å½±å“ã€‚", "å®¶é‡Œçš„å†·æš´åŠ›æŠŠä»–é€¼æˆäº†â€œå¯é æœºå™¨â€ã€‚", "ä»–æŠŠâ€œå¯é â€å½“æˆèµç½ªï¼Œç›´åˆ°ä½ ä¼¸æ‰‹ã€‚"]
        ]
      },
      B: {
        name: "æµ…ç¾½ æœ”",
        layers: [
          ["ä»–æ€»èƒ½é€—ä½ ç¬‘ï¼Œåƒæ˜¥å¤©çš„æ“åœºã€‚", "å°å–éƒ¨æ–°å“ç¬¬ä¸€å£æ€»æƒ³å¡ç»™ä½ ã€‚", "å¯¹ä½ è½¬å­¦å›æ¥ç‰¹åˆ«ä¸Šå¿ƒï¼Œåƒåœ¨ç¡®è®¤ä½ è¿˜åœ¨ã€‚"],
          ["ä»–å¯¹å¤–åƒå¤ªé˜³ï¼Œå¯¹å†…å´è‡ªå‘ã€‚", "ä»–æ€•ä½ è¶Šèµ°è¶Šè¿œï¼Œäºæ˜¯æ‹¼å‘½è·Ÿä¸Šã€‚", "ä»–å¸¸æ›¿ä½ æŒ¡æµè¨€ï¼Œå´è£…ä½œä¸ç»æ„ã€‚"],
          ["ä»–æ›¾ç»â€œè¯¯ä¼šâ€ä½ ä¸€æ¬¡ï¼Œå¯¼è‡´ä½ ç¦»å¼€ã€‚", "ä»–æŠŠè¿™ä¸‰å¹´å½“ä½œè¡¥å¿ï¼Œæ—¥å¤ä¸€æ—¥ã€‚", "ä»–æƒ³åœ¨æ ¡åº†é‚£å¤©æŠŠçœŸå¿ƒè¯´å‡ºå£ã€‚"]
        ]
      },
      C: {
        name: "ä¹…ä¸– ä¼¶",
        layers: [
          ["ä»–æ¸©æŸ”ã€ä¼šè®°ä½ä½ æ‰€æœ‰ç»†èŠ‚ã€‚", "æ€»èƒ½â€œåˆšå¥½è·¯è¿‡â€ï¼Œåƒä¸€é˜µç²¾å‡†çš„é£ã€‚", "ä»–æŠŠä½ çš„å–œå¥½å†™è¿›å¹¿æ’­å°çš„ç‰‡å°¾ã€‚"],
          ["ä»–åœ¨å­¦ç”Ÿä¼š/å¹¿æ’­ç«™æŒæ¡ä¿¡æ¯ã€‚", "ä¼šç”¨â€œä¸ºäº†ä½ å¥½â€åˆ¶é€ é€‰æ‹©å€¾å‘ã€‚", "ä»–ç»™ä½ å®‰æ’â€œæœ€ä½³è·¯çº¿â€ï¼Œä¸è®©åˆ«äººé è¿‘ã€‚"],
          ["ä»–å°æ—¶å€™è¢«é•¿æœŸå¿½è§†ã€‚", "é è§‚å¯Ÿä¸æ“æ§è·å¾—å®‰å…¨æ„Ÿã€‚", "ä»–å®³æ€•å¤±å»ä½ ï¼Œæ‰€ä»¥å®æ„¿å½“â€œåäººä¹Ÿè¦ç•™ä¸‹ä½ â€ã€‚"]
        ]
      }
    };

    const randomEvents = [
      { id: "energyLow", condition: (s) => s.resources.energy <= 30, text: "ä½ åœ¨èµ°å»Šé ç€çª—æ·±å‘¼å¸ï¼Œæœ‰äººé€’æ¥ä¸€ç“¶æ°´ã€‚", effect: (s) => addResource(s, "energy", 10) },
      { id: "moodLow", condition: (s) => s.resources.mood <= 30, text: "æ‰‹æœºå¼¹å‡ºâ€œåŒ¿åé¼“åŠ±è¯­â€ï¼Œä½ å¿½ç„¶æƒ³ç»§ç»­åŠªåŠ›ã€‚", effect: (s) => addResource(s, "mood", 8) },
      { id: "moneyLow", condition: (s) => s.resources.money <= 20, text: "å…¼èŒç¾¤æ‹›äººåŠ ç­ï¼Œä½ æŠ“ä½æœºä¼šã€‚", effect: (s) => addResource(s, "money", 30) },
      { id: "studyHigh", condition: (s) => s.resources.study >= 70, text: "è€å¸ˆå¤¸ä½ ç¨³å¾—åƒå…¨å¹´çº§çš„å®šå¿ƒä¸¸ã€‚", effect: (s) => addResource(s, "mood", 5) },
      { id: "projectPush", condition: (s) => s.resources.project >= 40, text: "ä¼åˆ’ä¼šè®®é¡ºåˆ©ï¼Œæ¨è¿›æ›´é«˜æ•ˆã€‚", effect: (s) => addResource(s, "project", 4) },
      { id: "giftDrop", condition: () => true, text: "ç¤¾å›¢æŸœå­é‡Œå‘ç°ä¸€ä»½â€œæœªç½²åç¤¼ç‰©â€ã€‚", effect: (s) => gainItem(s, "ticket") },
      { id: "library", condition: () => true, text: "å›¾ä¹¦é¦†é‡Œç¯å…‰æš–é»„ï¼Œä½ å†³å®šå®‰é™æ•´ç†ä¼åˆ’ã€‚", effect: (s) => { addResource(s, "study", 4); addResource(s, "project", 2); } },
      { id: "canteen", condition: () => true, text: "é£Ÿå ‚æ¨å‡ºç²‰é»‘é™å®šç”œå“ï¼Œä½ çš„å¿ƒæƒ…è¢«æ‹‰æ»¡ã€‚", effect: (s) => addResource(s, "mood", 6) },
      { id: "rain", condition: () => true, text: "çªç„¶ä¸‹é›¨ï¼Œä¸‰æŠŠä¼ä»ä¸‰ä¸ªæ–¹å‘èµ¶æ¥ã€‚", effect: (s) => { addAffection(s, "A", 2); addAffection(s, "B", 2); addAffection(s, "C", 2); s.flags.triangle = true; } },
      { id: "broadcast", condition: () => true, text: "å¹¿æ’­å°ç‚¹åè‡´è°¢ï¼Œä½ çš„åå­—è¢«æ¸©æŸ”å¿µå‡ºã€‚", effect: (s) => addResource(s, "mood", 5) },
      { id: "campusCat", condition: () => true, text: "æ ¡å›­çŒ«è¶´åœ¨ä½ è„šè¾¹ï¼Œæ—¶é—´æ…¢ä¸‹æ¥ã€‚", effect: (s) => addResource(s, "energy", 5) },
      { id: "poster", condition: () => true, text: "ä½ è®¾è®¡çš„æµ·æŠ¥è¢«æŒ‚åœ¨ä¸»æ¥¼ã€‚", effect: (s) => addResource(s, "project", 3) },
      { id: "rumor", condition: (s) => s.resources.mood <= 40, text: "æœ‰äººåœ¨èƒŒåè®®è®ºä½ çš„å¿™ç¢Œï¼Œä½ å­¦ä¼šæ— è§†ã€‚", effect: (s) => addResource(s, "mood", 4) },
      { id: "clinic", condition: (s) => s.resources.energy <= 25, text: "æ ¡åŒ»ç»™ä½ è´´ä¸Šæ¸©çƒ­çš„æš–å®å®ã€‚", effect: (s) => addResource(s, "energy", 12) },
      { id: "bonus", condition: (s) => s.resources.money >= 120, text: "ä½ æŠŠå¤šä½™çš„é’±æç»™æ ¡åº†ã€‚", effect: (s) => { addResource(s, "money", -20); addResource(s, "project", 4); } },
      { id: "practice", condition: (s) => s.resources.project >= 60, text: "èˆå°è¯•æ’æ¯”é¢„æƒ³æ›´é¡ºåˆ©ã€‚", effect: (s) => addResource(s, "project", 4) },
      { id: "sleepy", condition: (s) => s.resources.energy <= 40, text: "ä½ è¢«å…è®¸å°æ†©ç‰‡åˆ»ã€‚", effect: (s) => addResource(s, "energy", 8) },
      { id: "volunteer", condition: () => true, text: "æ–°ç”Ÿå¿—æ„¿è€…åŠ å…¥ï¼Œä»»åŠ¡è¢«åˆ†æ‹…ã€‚", effect: (s) => addResource(s, "project", 2) }
    ];

    const meetingEvents = {
      B: [
        {
          id: "B_meet_1",
          text: "æ“åœºæ™šé£å¹è¿‡ï¼Œæµ…ç¾½æœ”æŠŠè¿åŠ¨å¤–å¥—æ­åœ¨ä½ è‚©ä¸Šï¼Œå˜´è§’å¸¦ç€æƒ¯å¸¸çš„ç¬‘ã€‚ä»–è¯´èµ·ä½ åˆšè½¬æ¥é‚£å¤©ï¼Œè‡ªå·±è·‘éæ•´ä¸ªæ•™å­¦æ¥¼å¸®ä½ æ‰¾æ•™å®¤ï¼Œåƒæ˜¯åœ¨ç¡®è®¤ä½ çœŸçš„å›æ¥äº†ã€‚å‘¨å›´çš„ç¯å…‰è¢«å¤œè‰²æ™•å¼€ï¼Œä»–å´ç›¯ç€ä½ ï¼Œä¸è®©ä½ èº²å¼€ã€‚ä»–è½»å£°é—®ï¼šâ€œ{callName}ï¼Œä»Šå¤©è¿˜å¥½å—ï¼Ÿâ€ä½ å‘ç°ä»–æŠŠå¿ƒäº‹è—å¾—å¾ˆæ·±ï¼Œå´åˆæ€»èƒ½åœ¨ä½ éœ€è¦æ—¶å‡ºç°ã€‚",
          options: [
            { label: "è®¤çœŸé“è°¢ï¼Œè¯´ä½ å¾ˆæ„Ÿæ¿€ä»–çš„é™ªä¼´ã€‚", tags: ["å–„è‰¯", "ä½“è´´", "å¦ç‡"] },
            { label: "ç¬‘ç€è°ƒä¾ƒä»–å¤ªé»äººï¼Œæé†’ä»–ä¹Ÿè¦ç…§é¡¾è‡ªå·±ã€‚", tags: ["è¾¹ç•Œæ„Ÿ", "å¦ç‡"] },
            { label: "å‡è£…æ— æ‰€è°“ï¼Œè½¬è€Œè°ˆæ ¡åº†ä»»åŠ¡ã€‚", tags: ["å†·æ¼ "] }
          ]
        },
        {
          id: "B_meet_2",
          text: "å°å–éƒ¨çš„æ–°å“è¢«ä»–å¡è¿›ä½ æ‰‹é‡Œï¼Œå¡‘æ–™è¢‹ä¸Šå‡ç€æ°´ç ã€‚æµ…ç¾½æœ”ä¸€è¾¹è¯´ä»Šå¤©æ’ç»ƒé¡ºåˆ©ï¼Œä¸€è¾¹æŠŠä½ æ¨åˆ°æœ‰é£çš„èµ°å»Šå°½å¤´ã€‚ä½ çœ‹è§ä»–èƒŒåŒ…å¤¹å±‚é‡Œæ‰å‡ºä¸€å¼ æ—§ç…§ç‰‡â€”â€”ä½ ä»¬å°æ—¶å€™åœ¨æ ¡åº†èˆå°ä¸‹çš„åˆå½±ã€‚ä»–ç«‹åˆ»æŠŠç…§ç‰‡æ”¶å›ï¼Œå´æ²¡æ©ä½é‚£ä¸€ç¬é—´çš„ç´§å¼ ï¼šâ€œ{callName}ï¼Œå¦‚æœä½ ä¸å–œæ¬¢ï¼Œæˆ‘å°±ä¸æè¿‡å»äº†ã€‚â€",
          options: [
            { label: "å‘Šè¯‰ä»–ä½ ä¹Ÿæ€€å¿µè¿‡å»ï¼Œå¹¶æ„¿æ„å¬ä»–è®²ã€‚", tags: ["å–„è‰¯", "å¦ç‡"] },
            { label: "è½»å£°è¯´ç°åœ¨ä¹Ÿå¾ˆå¥½ï¼Œä½†å¸Œæœ›å½¼æ­¤å°Šé‡è¾¹ç•Œã€‚", tags: ["è¾¹ç•Œæ„Ÿ", "ä½“è´´"] },
            { label: "åŠå¼€ç©ç¬‘è¯´ç…§ç‰‡å¤ªå¹¼ç¨šï¼Œæƒ³çœ‹æ–°çš„åˆç…§ã€‚", tags: ["å¦ç‡", "ä½“è´´"] }
          ]
        },
        {
          id: "B_meet_3",
          text: "æ’ç»ƒç»“æŸçš„ç©ºæ•™å®¤é‡Œåªå‰©ä½ å’Œæµ…ç¾½æœ”ï¼Œä»–æŠŠæ¤…å­æ‹–åˆ°ä½ èº«æ—ï¼Œå£°éŸ³å‹ä½ï¼šâ€œæˆ‘ä»¬ä»¥å‰ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿè¿™æ ·å¹¶è‚©ï¼Ÿâ€ä»–åˆ»æ„æŠŠâ€œä»¥å‰â€è¯´å¾—å¾ˆè½»ï¼Œå´åˆåƒåˆ»åœ¨å­—é‡Œã€‚ä½ å¬å¾—å‡ºä»–åœ¨ç”¨ç†Ÿæ‚‰æ„Ÿæ‹‰ä½ä½ ï¼Œæ—¢æ¸©æŸ”åˆæœ‰ä¸€ç‚¹ç‚¹å°å¿ƒæœºã€‚ä»–çš„çœ¼ç¥åƒåœ¨ç­‰ä½ ç»™ç­”æ¡ˆï¼Œä»¿ä½›åªè¦ä½ å«ä¸€å£°â€œ{callName}â€å°±å¤Ÿã€‚",
          options: [
            { label: "å¦ç™½å‘Šè¯‰ä»–ä½ çæƒœè¿™ä»½ç¾ç»Šã€‚", tags: ["å¦ç‡", "å–„è‰¯"] },
            { label: "æé†’ä»–åˆ«é è¿‡å»ç»‘ä½ä½ ä»¬çš„ç°åœ¨ã€‚", tags: ["è¾¹ç•Œæ„Ÿ"] },
            { label: "è°ƒçš®åœ°è¯´è¦ç”¨è¡ŒåŠ¨è¯æ˜ä½ ä»¬çš„ç°åœ¨ã€‚", tags: ["ä½“è´´", "å¦ç‡"] }
          ]
        }
      ],
      A: [
        {
          id: "A_meet_1",
          text: "é¢„ç®—è¡¨æ‘Šåœ¨æ¡Œé¢ä¸Šï¼Œç™½æ¾¤å‡›å¸çš„ç¬”å°–åœåœ¨ä¸€æ¡ç»†å°çš„æ•°å­—åå·®å¤„ã€‚ä»–ä¸åŠ¨å£°è‰²åœ°æŠ¬çœ¼ï¼Œè§†çº¿å†·è€Œæ¸…æ™°ï¼šâ€œè¿™ä¸ªä½ç½®è¦å¯¹é½ã€‚â€ä½ æ³¨æ„åˆ°ä»–è¿çº¸è¾¹éƒ½æ•´ç†å¾—ä¸€ä¸ä¸è‹Ÿï¼Œåƒåœ¨å®ˆæŠ¤æŸç§è§„åˆ™ã€‚ä»–æŠŠæ–‡ä»¶é€’ç»™ä½ æ—¶ï¼ŒæŒ‡èŠ‚å¾®å¾®å‘ç™½ï¼Œä¼¼ä¹åœ¨å‹ä½ç„¦èºã€‚ä½ å¿½ç„¶å¬è§ä»–ä½ä½å–Šäº†ä¸€å£°â€œ{callName}â€ï¼Œå´æ²¡ç»§ç»­è§£é‡Šã€‚",
          options: [
            { label: "è®¤çœŸè®°å½•å¹¶è¡¨ç¤ºä¼šé©¬ä¸Šä¿®æ­£ã€‚", tags: ["å®ˆè§„çŸ©", "æ•ˆç‡", "ä¸Šè¿›"] },
            { label: "è½»å£°è¯´è°¢è°¢ä»–çš„æ ¡å¯¹ï¼ŒåŒæ—¶è¯¢é—®ä»–æ˜¯å¦éœ€è¦ä¼‘æ¯ã€‚", tags: ["ä½“è´´", "å°Šé‡è¾¹ç•Œ"] },
            { label: "ç¬‘ç€è¯´æ ¼å¼æ— æ‰€è°“ï¼Œé‡ç‚¹æ˜¯å†…å®¹ã€‚", tags: ["èƒ¡é—¹", "ä½æ•ˆç‡"] }
          ]
        },
        {
          id: "A_meet_2",
          text: "ä½ åœ¨æ•™å®¤å¤–ç­‰ä»–ç­¾å­—ï¼Œç™½æ¾¤å‡›å¸å´å…ˆæŠŠä½ å«è¿›åŠå…¬å®¤ã€‚ä»–æŒ‡å‘å±å¹•ä¸Šçš„æµç¨‹å›¾ï¼šâ€œå¦‚æœä¸æŒ‰è§„å®šèµ°ï¼Œæ•´ä¸ªæ ¡åº†ä¼šå¡æ­»ã€‚â€ä»–çš„è¯­æ°”ä¸é«˜ï¼Œå´åƒåˆ€é”‹ä¸€æ ·å¹²å‡€ã€‚ä½ çœ‹è§ä»–çœ¼åº•çš„å€¦æ„â€”â€”ä»–åœ¨æ›¿å¾ˆå¤šäººèƒŒè§„çŸ©çš„å‹åŠ›ï¼Œå´ä¾æ—§æ²¡æœ‰æ€¨è¨€ã€‚ä½ æƒ³èµ·ä»–æ€»ä¸€ä¸ªäººååœ¨å›¾ä¹¦é¦†çš„æ ·å­ï¼Œè¿™æ¬¡ä¹Ÿè®¸è¯¥å’Œä»–ç«™åœ¨åŒä¸€è¾¹ã€‚ä»–åœé¡¿äº†ä¸€ä¸‹ï¼Œè½»å£°å«ä½ â€œ{callName}â€ã€‚",
          options: [
            { label: "è¡¨ç¤ºç†è§£å¹¶æ„¿æ„é…åˆæµç¨‹ä¼˜åŒ–ã€‚", tags: ["å®ˆè§„çŸ©", "æ•ˆç‡"] },
            { label: "ç›´ç™½è¯´ä½ ä¹Ÿä¸æƒ³æ‹–ç´¯ä»–ï¼Œä¼šæ›´ä¸Šè¿›ã€‚", tags: ["å¦ç‡", "ä¸Šè¿›"] },
            { label: "è¯•å›¾æ‹‰ä»–å»å–ç‚¹ä¸œè¥¿æ”¾æ¾ã€‚", tags: ["ä½“è´´", "å°Šé‡è¾¹ç•Œ"] }
          ]
        },
        {
          id: "A_meet_3",
          text: "æ™šè‡ªä¹ åï¼Œç™½æ¾¤å‡›å¸æŠŠä¸€ä»½è¢«æŠ˜å¾—å¾ˆå¹³æ•´çš„èµ„æ–™é€’ç»™ä½ ã€‚ä»–æ²¡æœ‰å¤šè§£é‡Šï¼Œåªè¯´ï¼šâ€œä½ ä¼šç”¨å¾—åˆ°ã€‚â€èµ°å»Šé‡Œç¯å…‰å†·ç™½ï¼Œä»–çš„å½±å­è½åœ¨ä½ è„šè¾¹ï¼Œåƒä¸€æ¡ä¸¥è°¨å´ä¸åŠ¨å£°è‰²çš„çº¿ã€‚ä½ æƒ³èµ·ä»–è¢«ç§°ä½œâ€œæ¼‚äº®è„¸â€çš„æ—¶å€™ï¼Œæ€»æŠŠæƒ…ç»ªè—èµ·æ¥ã€‚ä½ è¯•ç€è½»å£°é—®ä»–æ˜¯ä¸æ˜¯ä¹Ÿä¼šè§‰å¾—ç–²æƒ«ï¼Œä»–çš„å›ç­”åªæ˜¯ä¸€å¥ï¼šâ€œæ²¡äº‹ï¼Œ{callName}ï¼Œå…ˆæŠŠäº‹åšå¥½ã€‚â€",
          options: [
            { label: "ç‚¹å¤´æ”¶ä¸‹èµ„æ–™ï¼Œå¹¶æ‰¿è¯ºæŒ‰ä»–çš„æ€è·¯æ¨è¿›ã€‚", tags: ["å®ˆè§„çŸ©", "æ•ˆç‡"] },
            { label: "è¯´ä½ ä¼šåŠªåŠ›ï¼Œä½†ä¹Ÿå¸Œæœ›ä»–èƒ½ç…§é¡¾è‡ªå·±ã€‚", tags: ["å°Šé‡è¾¹ç•Œ", "ä½“è´´"] },
            { label: "å¼€ç©ç¬‘è¯´ä»–å¤ªæ­»æ¿ï¼Œæƒ³çœ‹ä»–å¤±æ§ä¸€æ¬¡ã€‚", tags: ["èƒ¡é—¹", "æ¶è¶£å‘³"] }
          ]
        }
      ],
      C: [
        {
          id: "C_meet_1",
          text: "å¹¿æ’­ç«™çš„ç»ç’ƒçª—æ˜ ç€ä½ çš„å€’å½±ï¼Œä¹…ä¸–ä¼¶æ¨å¼€é—¨æ—¶è„šæ­¥è½»å¾—åƒæ²¡å£°éŸ³ã€‚ä»–æŠŠä¸€ä»½å®£ä¼ ä½çš„æ’ç­è¡¨é€’ç»™ä½ ï¼Œè¯­æ°”æ¸©æŸ”ï¼šâ€œæˆ‘å¸®ä½ ç•™äº†æœ€ä½³æ—¶æ®µã€‚â€ä½ æ˜ç™½è¿™ä¸æ˜¯æ— æ¡ä»¶çš„å¥½æ„ï¼Œè€Œæ˜¯ä»–æŒæ¡ä¿¡æ¯å·®åçš„â€œé€‰æ‹©â€ã€‚ä»–çš„æ‰‹æŒ‡åœåœ¨ä½ åå­—æ—è¾¹ï¼Œåƒåœ¨ç¡®è®¤ä½ å±äºå“ªä¸€æ ¼ã€‚ä»–ä½å£°é‡å¤ï¼šâ€œ{callName}ã€‚â€",
          options: [
            { label: "é¡ºç€ä»–çš„å®‰æ’ï¼Œè¡¨ç¤ºæ„¿æ„é…åˆã€‚", tags: ["ä¿¡æ¯å·®", "å°è°è¨€"] },
            { label: "è¯•æ¢ä»–ä¸ºä»€ä¹ˆæ„¿æ„å¸®ä½ ã€‚", tags: ["è¯•æ¢"] },
            { label: "å¼ºè°ƒè‡ªå·±ä¼šæŒ‰è§„åˆ™ç”³è¯·ï¼Œä¸éœ€è¦ç‰¹æ®Šç…§é¡¾ã€‚", tags: ["å¼ºè°ƒè¾¹ç•Œ"] }
          ]
        },
        {
          id: "C_meet_2",
          text: "ä½ åœ¨èµ°å»Šæ‹è§’è¢«ä¹…ä¸–ä¼¶â€œå¶é‡â€ï¼Œä»–é€’æ¥ä¸€ä»½åŒ¿åèµåŠ©çº¿ç´¢ï¼Œå˜´è§’å¼§åº¦æ°åˆ°å¥½å¤„ï¼šâ€œæˆ‘åªæ˜¯ä¸æƒ³çœ‹åˆ°ä½ è¢«åˆ«äººæŠ¢èµ°èµ„æºã€‚â€ä»–æ€»æ˜¯æŠŠè¯è¯´å¾—å¾ˆè½»ï¼Œå´åƒä¸€æ ¹çº¿ç¼ ä¸Šä½ çš„æ‰‹è…•ã€‚ä½ å¬è§è¿œå¤„æœ‰äººèµ°è¿‘ï¼Œä»–å´æ•…æ„ç«™å¾—æ›´è¿‘ï¼Œè®©ä½ åªèƒ½é€‰æ‹©é¢å¯¹ä»–ã€‚é‚£ä»½é è¿‘é‡Œæœ‰æ¸©æŸ”ï¼Œä¹Ÿæœ‰ä¸å®¹æ‹’ç»çš„åšæŒï¼Œä»–åœ¨ä½ è€³è¾¹å«äº†å£°â€œ{callName}â€ã€‚",
          options: [
            { label: "åŠçœŸåŠå‡åœ°è¯´åªæœ‰ä»–æ‡‚ä½ ã€‚", tags: ["å æœ‰", "å°è°è¨€"] },
            { label: "æé†’ä»–åˆ«å¤ªè¿‡åº¦ï¼Œåˆä½œå°±å¤Ÿäº†ã€‚", tags: ["å…¬å¼€æ‹’ç»", "å¼ºè°ƒè¾¹ç•Œ"] },
            { label: "è½»å£°è¯´æƒ³å¬ä»–çœŸæ­£çš„ç›®çš„ã€‚", tags: ["è¯•æ¢", "æ¶è¶£å‘³"] }
          ]
        },
        {
          id: "C_meet_3",
          text: "å¤œæ™šçš„å¹¿æ’­ç«™ç¯å…‰æ˜æš—ï¼Œä¹…ä¸–ä¼¶æŠŠè€³æœºæ‰£åœ¨ä½ è€³è¾¹ï¼Œä½å£°è¯´ï¼šâ€œä½ å¬ï¼Œåªæœ‰æˆ‘ä»¬å¬å¾—åˆ°ã€‚â€ä»–çš„å£°éŸ³åƒåœ¨ç¼ ç»•ä½ ï¼Œè¯­æ°”æ¸©æŸ”å´ä¸å®¹ç½®ç–‘ã€‚ä»–æŠŠä½ çš„åå­—åœ¨å¥å°¾æ‹–é•¿ï¼Œåƒåœ¨ç¡®è®¤å½’å±ï¼šâ€œ{callName}â€¦â€¦â€ä½ æ„è¯†åˆ°ï¼Œä»–çš„äº²è¿‘å¹¶ä¸æ˜¯å•çº¯çš„å–œæ¬¢ï¼Œè€Œæ˜¯å¸¦ç€ä¸€ç‚¹å æœ‰ä¸è¯•æ¢ã€‚ä½ å¯ä»¥æ‹’ç»ï¼Œä½†ä¹ŸçŸ¥é“æ‹’ç»ä¼šè®©ä»–é€€å¾—å¾ˆè¿œã€‚",
          options: [
            { label: "è®©ä»–ç»§ç»­å¿µä¸‹å»ï¼Œå‘Šè¯‰ä»–ä½ æƒ³å¬ã€‚", tags: ["å æœ‰", "è¯•æ¢"] },
            { label: "è½»è½»æŠŠè€³æœºå–ä¸‹ï¼Œè¯´ä½ éœ€è¦ä¸€ç‚¹ç©ºé—´ã€‚", tags: ["å…¬å¼€æ‹’ç»"] },
            { label: "ç”¨ç©ç¬‘å›åº”ä»–çš„æš§æ˜§ï¼Œä¿æŒæ¨¡ç³Šã€‚", tags: ["æ¶è¶£å‘³", "ä¿¡æ¯å·®"] }
          ]
        }
      ]
    };

    const tasks = [
      { id: "study", name: "å­¦ä¹ ", desc: "å­¦ä¸š+6 å¿ƒæƒ…-1 ç²¾åŠ›-10", effect: (s) => { addResource(s, "study", 6); addResource(s, "mood", -1); addResource(s, "energy", -10); s.streaks.study++; },
        condition: () => true },
      { id: "club", name: "ç¤¾å›¢", desc: "å¿ƒæƒ…+5 ä¼åˆ’+3 ç²¾åŠ›-9", effect: (s) => { addResource(s, "mood", 5); addResource(s, "project", 3); addResource(s, "energy", -9); s.stats.club++; s.streaks.study = 0; },
        condition: () => true },
      { id: "parttime", name: "æ‰“å·¥", desc: "é‡‘é’±+30 å¿ƒæƒ…-2 ç²¾åŠ›-14", effect: (s) => { addResource(s, "money", 30); addResource(s, "mood", -2); addResource(s, "energy", -14); s.stats.partTime++; s.streaks.study = 0; },
        condition: () => true },
      { id: "rest", name: "ä¼‘æ¯", desc: "ç²¾åŠ›+35 å¿ƒæƒ…+4ï¼ˆæœ‰æ¦‚ç‡é¢å¤–+5ï¼‰", effect: (s) => { addResource(s, "energy", 35); addResource(s, "mood", 4); if (Math.random() < 0.35) addResource(s, "mood", 5); s.stats.rest++; s.streaks.study = 0; },
        condition: () => true },
      { id: "date", name: "è§é¢", desc: "ä¸ç”·ä¸»äº’åŠ¨ å¥½æ„Ÿ/ä¿¡ä»»â†‘ ç²¾åŠ›-8 å¿ƒæƒ…+5", effect: (s) => { s.flags.firstDate = true; },
        condition: (s) => s.day >= 3 },
      { id: "project", name: "æ ¡åº†æ¨è¿›", desc: "ä¼åˆ’+10 ç²¾åŠ›-12 å¿ƒæƒ…-1", effect: (s) => { addResource(s, "project", 10); addResource(s, "energy", -12); addResource(s, "mood", -1); s.stats.projectTasks++; s.streaks.study = 0; },
        condition: () => true },
      { id: "useItem", name: "ä½¿ç”¨é“å…·", desc: "ä½¿ç”¨èƒŒåŒ…å†…é“å…·", effect: () => {}, condition: (s) => s.inventory.length > 0 },
      { id: "emergencyRest", name: "å¼ºåˆ¶ä¼‘æ•´", desc: "ç²¾åŠ›+40 å¿ƒæƒ…+3ï¼ˆä½ç²¾åŠ›æ—¶è§£é”ï¼‰", effect: (s) => { addResource(s, "energy", 40); addResource(s, "mood", 3); s.stats.rest++; }, condition: (s) => s.resources.energy < 25 },
      { id: "canteen", name: "é£Ÿå ‚è¡¥ç»™", desc: "ç²¾åŠ›+30 å¿ƒæƒ…+3ï¼ˆä½ç²¾åŠ›æ—¶è§£é”ï¼‰", effect: (s) => { addResource(s, "energy", 30); addResource(s, "mood", 3); }, condition: (s) => s.resources.energy < 25 },
      { id: "seekB", name: "å‘ç«¹é©¬æ±‚åŠ©", desc: "ç²¾åŠ›+25 å¿ƒæƒ…+6 ä¿¡ä»»+4ï¼ˆä½ç²¾åŠ›æ—¶è§£é”ï¼‰", effect: (s) => { addResource(s, "energy", 25); addResource(s, "mood", 6); addTrust(s, "B", 4); }, condition: (s) => s.resources.energy < 25 && s.day >= 2 }
    ];

    const tutorialSteps = [
      "æ¬¢è¿æ¥åˆ°ç²‰é»‘ä¹™å¥³æ ¡å›­ï¼å·¦ä¾§æ˜¯èµ„æºé¢æ¿ã€ä»»åŠ¡ä¸æˆå°±å…¥å£ã€‚",
      "ä¸€å¤©æœ‰3æ¬¡è¡ŒåŠ¨ï¼šå­¦ä¹ /ç¤¾å›¢/æ‰“å·¥/ä¼‘æ¯/è§é¢/æ ¡åº†æ¨è¿›ç­‰ã€‚",
      "ä¸»çº¿ç›®æ ‡æ˜¯3ä¸ªæœˆå†…å®Œæˆæ ¡åº†ä¼åˆ’ï¼Œè¿›åº¦æ¡ä¸å‘¨ç›®æ ‡ä¼šæç¤ºä½ ã€‚",
      "å³ä¾§æ˜¯ç”·ä¸»å¥½æ„Ÿä¸ä¿¡ä»»ï¼Œæå‡åå¯è§£é”èƒŒæ™¯æ•…äº‹å±‚å±‚ç§˜å¯†ã€‚",
      "é¡¶éƒ¨å¯å­˜æ¡£/è¯»æ¡£ï¼Œæˆå°±ä¼šå¥–åŠ±é“å…·æˆ–å›æº¯åˆ¸ã€‚",
      "å›æº¯åˆ¸å¯åœ¨å…³é”®æ—¶åˆ»æ•‘åœºï¼Œæ”¾å¿ƒæ¢ç´¢é€‰æ‹©ï¼"
    ];

    const stateTemplate = () => ({
      playerName: defaultName,
      day: 1,
      week: 1,
      actionsPerDay: 3,
      actionsTaken: 0,
      storyLog: ["æ–°å­¦æœŸç¬¬1å‘¨ï¼Œä½ ä½œä¸ºè½¬å­¦/è¿”æ ¡ç”Ÿè¸è¿›æ ¡å›­ã€‚ä¸€å¤©æœ‰3æ¬¡è¡ŒåŠ¨ã€‚æ ¡åº†ä¼åˆ’çš„æ¶ˆæ¯é“ºå¤©ç›–åœ°ã€‚"],
      resources: { energy: 80, money: 100, mood: 60, study: 50, project: 0 },
      inventory: ["snack", "meal"],
      achievements: [],
      guys: {
        A: { affection: 20, trust: 20, storyTier: 0, storyIndex: 0, unlocked: false },
        B: { affection: 20, trust: 20, storyTier: 0, storyIndex: 0, unlocked: true },
        C: { affection: 20, trust: 20, storyTier: 0, storyIndex: 0, unlocked: false }
      },
      stats: { projectTasks: 0, partTime: 0, club: 0, rest: 0 },
      streaks: { study: 0 },
      milestoneIndex: 0,
      extremeChoices: 0,
      lowTrustDays: 0,
      rewindTokens: 1,
      daySummary: null,
      forcedRest: false,
      flags: { firstDate: false, triangle: false, nameHintShown: false },
      settings: { showMainlineWarning: true }
    });

    let state = stateTemplate();
    let nameModalMode = "newgame";
    initDaySummary();

    const storyEl = document.getElementById("story");
    const choicesEl = document.getElementById("choices");
    const taskListEl = document.getElementById("taskList");
    const dayInfoEl = document.getElementById("dayInfo");
    const actionInfoEl = document.getElementById("actionInfo");

    const achievementModal = document.getElementById("achievementModal");
    const inventoryModal = document.getElementById("inventoryModal");
    const settlementModal = document.getElementById("settlementModal");
    const settlementBody = document.getElementById("settlementBody");
    const tutorialModal = document.getElementById("tutorialModal");
    const tutorialBody = document.getElementById("tutorialBody");
    const tutorialControls = document.getElementById("tutorialControls");
    const nameModal = document.getElementById("nameModal");
    const nameHintModal = document.getElementById("nameHintModal");
    const mainlineWarningModal = document.getElementById("mainlineWarningModal");
    const settingsModal = document.getElementById("settingsModal");
    const achievementList = document.getElementById("achievementList");
    const inventoryList = document.getElementById("inventoryList");

    const resourceMap = {
      energy: { value: document.getElementById("energyValue"), bar: document.getElementById("energyBar") },
      money: { value: document.getElementById("moneyValue"), bar: document.getElementById("moneyBar") },
      mood: { value: document.getElementById("moodValue"), bar: document.getElementById("moodBar") },
      study: { value: document.getElementById("studyValue"), bar: document.getElementById("studyBar") },
      project: { value: document.getElementById("projectValue"), bar: document.getElementById("projectBar") }
    };
    const resourceLabels = {
      energy: "ç²¾åŠ›",
      money: "é‡‘é’±",
      mood: "å¿ƒæƒ…",
      study: "å­¦ä¸š",
      project: "ä¼åˆ’è¿›åº¦"
    };

    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

    function getCallName(guyId, affection, trust) {
      const base = state.playerName;
      if (guyId === "B") {
        if (affection < 20) return `${base}åŒå­¦`;
        if (affection < 55) return base;
        if (affection < 80) return `${base}é…±`;
        return trust >= 70 ? base : `${base}é…±`;
      }
      if (guyId === "A") {
        if (affection < 20) return `${base}åŒå­¦`;
        if (affection < 55) return base;
        if (affection < 80) return `${base}â€¦`;
        return trust >= 70 ? `â€¦â€¦${base}` : `${base}â€¦`;
      }
      if (guyId === "C") {
        if (affection < 20) return base;
        if (affection < 55) return `${base}ã€${base}`;
        if (affection < 80) return `${base}â€¦â€¦`;
        return trust >= 70 ? `${base}â€¦â€¦è¿‡æ¥` : `${base}â€¦â€¦`;
      }
      return base;
    }

    function getGuyDisplayName(guyId) {
      return `${guyProfiles[guyId].name} (${guyProfiles[guyId].roman})`;
    }

    function cloneGuyStats(guys) {
      return Object.fromEntries(Object.entries(guys).map(([id, g]) => [id, { affection: g.affection, trust: g.trust }]));
    }

    function initDaySummary() {
      state.daySummary = {
        startResources: { ...state.resources },
        startGuys: cloneGuyStats(state.guys),
        items: [],
        clues: [],
        logs: []
      };
    }

    function addResource(s, key, amount) {
      s.resources[key] = clamp(s.resources[key] + amount, 0, 100);
      if (key === "project") {
        s.resources.project = clamp(s.resources.project, 0, 100);
        checkMilestones(s);
      }
    }

    function addAffection(s, guy, amount) {
      s.guys[guy].affection = clamp(s.guys[guy].affection + amount, 0, 100);
      if (s.daySummary) {
        s.daySummary.logs.push(`å¥½æ„Ÿå˜åŠ¨ï¼š${guyStories[guy].name} ${amount > 0 ? "+" : ""}${amount}`);
      }
    }

    function addTrust(s, guy, amount) {
      s.guys[guy].trust = clamp(s.guys[guy].trust + amount, 0, 100);
      if (s.daySummary) {
        s.daySummary.logs.push(`ä¿¡ä»»å˜åŠ¨ï¼š${guyStories[guy].name} ${amount > 0 ? "+" : ""}${amount}`);
      }
    }

    function giftTo(s, guy, amount) {
      addAffection(s, guy, amount);
      addTrust(s, guy, Math.floor(amount / 2));
    }

    function randomTrust(s, amount) {
      const keys = Object.keys(s.guys);
      const pick = keys[Math.floor(Math.random() * keys.length)];
      addTrust(s, pick, amount);
    }

    function gainItem(s, itemId) {
      s.inventory.push(itemId);
      s.storyLog.push(`è·å¾—é“å…·ï¼š${items[itemId].name}ã€‚`);
      if (s.daySummary) {
        s.daySummary.items.push(items[itemId].name);
      }
    }

    function addClue(s, guy) {
      const g = s.guys[guy];
      const layer = guyStories[guy].layers[g.storyTier] || [];
      const index = g.storyIndex;
      if (layer[index]) {
        s.storyLog.push(`ã€${guyStories[guy].name}èƒŒæ™¯ã€‘${layer[index]}`);
        if (s.daySummary) {
          s.daySummary.clues.push(`${guyStories[guy].name}ï¼š${layer[index]}`);
        }
        g.storyIndex += 1;
        if (g.storyIndex >= 3 && g.storyTier < 2) {
          g.storyTier += 1;
          g.storyIndex = 0;
        }
      } else {
        s.storyLog.push("æ•…äº‹çº¿ç´¢å·²å…¨éƒ¨è§£é”ã€‚");
      }
    }

    function checkMilestones(s) {
      const next = milestoneEvents[s.milestoneIndex];
      if (next && s.resources.project >= next.threshold) {
        s.storyLog.push(next.text);
        s.milestoneIndex += 1;
      }
    }

    function getWeek() {
      return Math.ceil(state.day / 7);
    }

    function updateWeek() {
      state.week = getWeek();
    }

    function renderResources() {
      Object.entries(state.resources).forEach(([key, value]) => {
        resourceMap[key].value.textContent = value;
        resourceMap[key].bar.style.width = `${value}%`;
      });
      document.getElementById("weekGoal").textContent = weekGoals[state.week - 1] || "";
    }

    function renderCharacters() {
      const renderGuy = (id, elId) => {
        const guy = state.guys[id];
        const storyProgress = guy.storyTier * 3 + guy.storyIndex;
        const locked = !guy.unlocked;
        const lockText = id === "A"
          ? "ç¬¬4å‘¨ï¼šæµç¨‹/é¢„ç®—å®¡æ ¸å¡æ­»ï¼Œéœ€è¦ç™½æ¾¤å‡›å¸ç­¾å­—è§£é”"
          : "ç¬¬6å‘¨ï¼šå®£ä¼ ä½å±æœºï¼Œéœ€ä¸ä¹…ä¸–ä¼¶åˆä½œè§£é”";
        const text = `
          <h3>${getGuyDisplayName(id)}</h3>
          ${locked ? `<div class="small">ğŸ”’ æœªè§£é”ï¼š${lockText}</div>` : `
          <div class="stat">å¥½æ„Ÿ ${guy.affection}<div class="bar"><span style="width:${guy.affection}%"></span></div></div>
          <div class="stat">ä¿¡ä»» ${guy.trust}<div class="bar"><span style="width:${guy.trust}%"></span></div></div>
          <div class="small">èƒŒæ™¯æ•…äº‹è§£é”è¿›åº¦ï¼š${storyProgress}/9</div>`}
        `;
        const element = document.getElementById(elId);
        element.innerHTML = text;
        element.style.opacity = locked ? "0.5" : "1";
      };
      renderGuy("A", "charA");
      renderGuy("B", "charB");
      renderGuy("C", "charC");
    }

    function renderTasks() {
      taskListEl.innerHTML = "";
      tasks.filter((task) => task.condition(state)).forEach((task) => {
        const div = document.createElement("div");
        div.className = "task";
        div.innerHTML = `<strong>${task.name}</strong><small>${task.desc}</small>`;
        taskListEl.appendChild(div);
      });
    }

    function renderStory() {
      storyEl.innerHTML = state.storyLog.map((line) => `<p>${line}</p>`).join("");
      storyEl.scrollTop = storyEl.scrollHeight;
    }

    function renderDayInfo() {
      dayInfoEl.innerHTML = `ç¬¬${state.day}å¤© / ç¬¬${state.week}å‘¨ Â· ä»Šæ—¥è¡ŒåŠ¨ï¼š${state.actionsTaken}/${state.actionsPerDay}`;
      actionInfoEl.textContent = `ä»Šæ—¥è¡ŒåŠ¨ï¼š${state.actionsTaken}/${state.actionsPerDay}`;
    }

    function renderChoices(options) {
      choicesEl.innerHTML = "";
      options.forEach((option) => {
        const button = document.createElement("button");
        button.textContent = option.label;
        button.addEventListener("click", option.onClick);
        choicesEl.appendChild(button);
      });
    }

    function getRandomEvent() {
      const pool = randomEvents.filter((evt) => evt.condition(state));
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function triggerRandomEvent() {
      const chance = state.resources.energy < 25 ? 0.25 : 0.45;
      if (Math.random() < chance) {
        const evt = getRandomEvent();
        if (evt) {
          state.storyLog.push(`ã€éšæœºäº‹ä»¶ã€‘${evt.text}`);
          evt.effect(state);
        }
      }
    }

    function runTask(taskId) {
      const task = tasks.find((t) => t.id === taskId);
      if (!task) return;
      if (taskId === "useItem") {
        openInventory(true);
        return;
      }
      if (taskId === "date") {
        renderChoices([
          { label: "å’Œæµ…ç¾½æœ”è§é¢", onClick: () => { tryMeeting("B"); } },
          { label: "å’Œç™½æ¾¤å‡›å¸è§é¢", onClick: () => { tryMeeting("A"); } },
          { label: "å’Œä¹…ä¸–ä¼¶è§é¢", onClick: () => { tryMeeting("C"); } },
          { label: "è¿”å›", onClick: () => { renderChoices(getDefaultChoices()); } }
        ]);
        return;
      }
      task.effect(state);
      afterAction(`${task.name}å®Œæˆã€‚`, taskId);
    }

    function tryMeeting(guyId) {
      if (!state.guys[guyId].unlocked) {
        const hint = guyId === "A"
          ? "ç¬¬4å‘¨ï¼šæµç¨‹/é¢„ç®—å®¡æ ¸å¡æ­»ï¼Œéœ€è¦ç™½æ¾¤å‡›å¸ç­¾å­—è§£é”ã€‚"
          : "ç¬¬6å‘¨ï¼šå®£ä¼ ä½å±æœºï¼Œéœ€è¦ä¹…ä¸–ä¼¶åä½œè§£é”ã€‚";
        state.storyLog.push(`ã€æœªè§£é”ã€‘${hint}`);
        renderAll();
        return;
      }
      if (triggerTriangleEvent()) {
        return;
      }
      startMeeting(guyId);
    }

    function triggerTriangleEvent() {
      const candidates = Object.keys(state.guys).filter((id) => state.guys[id].affection >= 55 && state.guys[id].affection < 80);
      if (candidates.length < 2) return false;
      const chance = Math.min(0.2, 0.12 + (candidates.length - 2) * 0.04);
      if (Math.random() > chance) return false;
      state.flags.triangle = true;
      const text = "èµ°å»Šçš„ç¯å…‰åœ¨ä½ å¤´é¡¶ä¸€ç›ç›äº®èµ·ï¼ŒåƒæŠŠäººå½±åˆ‡æˆå‡ æ®µã€‚ä½ åˆšè½¬èº«ï¼Œæµ…ç¾½æœ”å°±ä»å¦ä¸€ä¾§å¿«æ­¥èµ°æ¥ï¼Œç¬‘å®¹æ¸©æš–å´å¸¦ç€ä¸€ç‚¹ä¸å®¹ç½®ç–‘çš„ç†Ÿç¨”ï¼šâ€œæˆ‘ä»¬ä»¥å‰ä¸æ˜¯ä¸€ç›´ä¸€èµ·èµ°å—ï¼Ÿâ€è¯éŸ³æœªè½ï¼Œç™½æ¾¤å‡›å¸å·²ç»ç«™åœ¨ä½ èº«ä¾§ï¼Œå®‰é™å¾—åƒé£åœäº†ï¼Œä»–çš„ç›®å…‰è½åœ¨ä½ ä»¬ä¹‹é—´çš„è·ç¦»ä¸Šï¼Œå†·é™åˆç²¾å‡†ï¼šâ€œä½ ç­”åº”è¿‡è¦æŠŠæµç¨‹æ”¹å®Œã€‚â€ä¹…ä¸–ä¼¶ä»å¹¿æ’­å®¤çš„é—¨å£é è¿‘ï¼Œæ‰‹é‡Œæç€æ’ç­è¡¨ï¼Œè¯­æ°”æ¸©æŸ”å¾—å‡ ä¹åƒä½è¯­ï¼šâ€œæ²¡å…³ç³»ï¼Œåªè¦ä½ é€‰æˆ‘å°±è¡Œã€‚â€ä¸‰ä¸ªäººçš„è§†çº¿åƒä¸‰æ¡çº¿äº¤é”™ï¼Œç©ºæ°”è¢«æ‹‰ç´§ï¼Œä½ èƒ½æ„Ÿåˆ°ä»–ä»¬éƒ½åœ¨ç­‰å¾…ä½ çš„æ”¶åœºæ–¹å¼ã€‚";
      state.storyLog.push(`ã€ä¿®ç½—åœºã€‘${text}`);
      renderChoices([
        { label: "å®‰æŠšæµ…ç¾½æœ”", onClick: () => { addTrust(state, "B", 2); afterAction("ä½ æ¸©å£°è®©æµ…ç¾½æœ”å…ˆå†·é™ä¸‹æ¥ã€‚", "date"); } },
        { label: "å®‰æŠšç™½æ¾¤å‡›å¸", onClick: () => { addTrust(state, "A", 2); afterAction("ä½ å‘ç™½æ¾¤å‡›å¸ç‚¹å¤´ï¼Œè¡¨ç¤ºä¼šæŒ‰æµç¨‹èµ°ã€‚", "date"); } },
        { label: "å®‰æŠšä¹…ä¸–ä¼¶", onClick: () => { addTrust(state, "C", 2); afterAction("ä½ é è¿‘ä¹…ä¸–ä¼¶ï¼Œç¤ºæ„ä»–åˆ«å¤ªé€¼è¿«ä½ ã€‚", "date"); } }
      ]);
      return true;
    }

    function startMeeting(guyId) {
      tasks.find((t) => t.id === "date").effect(state);
      addResource(state, "energy", -8);
      addResource(state, "mood", 5);
      const pool = meetingEvents[guyId];
      const event = pool[Math.floor(Math.random() * pool.length)];
      const callName = getCallName(guyId, state.guys[guyId].affection, state.guys[guyId].trust);
      const text = event.text.replace("{callName}", callName);
      state.storyLog.push(`ã€${guyProfiles[guyId].name}è§é¢ã€‘${text}`);
      const optionChoices = event.options.map((option) => ({
        label: `${option.label}ï¼ˆ${option.tags.join("/")}ï¼‰`,
        onClick: () => {
          applyMeetingChoice(guyId, option.tags);
          if (Math.random() < 0.3) {
            gainItem(state, `clue${guyId}`);
          }
          afterAction(`ä½ åšå‡ºäº†é€‰æ‹©ã€‚`, "date");
        }
      }));
      renderChoices(optionChoices);
    }

    function applyMeetingChoice(guyId, tags) {
      const profile = guyProfiles[guyId];
      let score = 0;
      tags.forEach((tag) => {
        if (profile.preferred.includes(tag)) score += 1;
        if (profile.disliked.includes(tag)) score -= 1;
      });
      let affChange = 0;
      let trustChange = 0;
      if (profile.mild) {
        if (score > 0) {
          affChange = clamp(2 + score * 2, 2, 6);
          trustChange = clamp(1 + score, 1, 4);
        } else if (score < 0) {
          affChange = -clamp(1 + Math.abs(score), 1, 4);
          trustChange = -clamp(Math.abs(score), 1, 3);
        } else {
          affChange = 1;
          trustChange = 0;
        }
      } else {
        if (score > 0) {
          affChange = clamp(6 + score * 2, 6, 12);
          trustChange = clamp(2 + score, 2, 6);
        } else if (score < 0) {
          affChange = 0;
          trustChange = -clamp(6 + Math.abs(score) * 2, 6, 12);
        } else {
          affChange = 2;
          trustChange = 0;
        }
      }
      addAffection(state, guyId, affChange);
      addTrust(state, guyId, trustChange);
    }

    function afterAction(summary, actionId = "") {
      state.storyLog.push(summary);
      state.actionsTaken += 1;
      if (state.daySummary) {
        state.daySummary.logs.push(summary);
      }
      if (actionId) {
        triggerMiniEvent(actionId);
      }
      triggerRandomEvent();
      checkAchievements();
      updateTrustStreak();
      if (state.resources.energy <= 0) {
        state.storyLog.push("ã€ä½“åŠ›é€æ”¯ã€‘ä½ è¢«å¼ºåˆ¶ä¼‘æ¯ä¸€å¤©ï¼Œä¸”è·å¾—1æ¬¡å›æº¯åˆ¸ã€‚");
        state.rewindTokens += 1;
        state.forcedRest = true;
        state.actionsTaken = state.actionsPerDay;
      }
      renderAll();
    }

    function updateTrustStreak() {
      const lowTrust = Object.values(state.guys).some((g) => g.trust <= 25);
      if (lowTrust) {
        state.lowTrustDays += 1;
      } else {
        state.lowTrustDays = 0;
      }
    }

    function triggerMiniEvent(actionId) {
      if (actionId === "study" && state.guys.A.unlocked) {
        const base = 0.04;
        const scaling = (state.guys.A.affection / 100) * 0.08;
        const chance = Math.min(0.15, base + scaling);
        if (Math.random() < chance) {
          state.storyLog.push("ã€å­¦ä¹ å°äº‹ä»¶ã€‘ä½ ç¿»åˆ°éš¾é¢˜æ—¶ï¼Œç™½æ¾¤å‡›å¸æ°å¥½ç»è¿‡ï¼Œåœä¸‹è„šæ­¥ç»™å‡ºæ¸…æ™°çš„æ¨å¯¼ã€‚ä½ å‘ç°ä»–çš„è®²è§£ç®€çŸ­å´æœ‰åŠ›ï¼Œåƒåœ¨å¸®ä½ æŠŠè·¯ç¯ä¸€ç›ç›ç‚¹äº®ã€‚");
          addAffection(state, "A", 2);
          addTrust(state, "A", 1);
          addResource(state, "study", 1);
        }
      }
      if (actionId === "club") {
        const base = 0.08;
        const scaling = (state.guys.B.affection / 100) * 0.06;
        const chance = Math.min(0.18, base + scaling);
        if (Math.random() < chance) {
          state.storyLog.push("ã€ç¤¾å›¢å°äº‹ä»¶ã€‘æµ…ç¾½æœ”å¸®ä½ æ¬å®Œç‰©æ–™ï¼Œè¿˜é¡ºæ‰‹ä¿®å¥½äº†æ‘‡æ™ƒçš„å±•æ¶ã€‚ä»–ç¬‘ç€è¯´â€œäº¤ç»™æˆ‘â€ï¼Œè®©ä½ å¿ä¸ä½æ”¾æ¾äº†ä¸€ç‚¹ã€‚");
          addAffection(state, "B", 2);
          addResource(state, "mood", 1);
          addResource(state, "project", 1);
        }
      }
      if (actionId === "rest" && state.guys.C.unlocked) {
        const base = 0.015;
        const scaling = (state.guys.C.affection / 100) * 0.03;
        const chance = Math.min(0.06, base + scaling);
        if (Math.random() < chance) {
          state.storyLog.push("ã€ä¼‘æ¯å°äº‹ä»¶ã€‘ä½ åœ¨å›¾ä¹¦é¦†è§’è½å°æ†©ï¼Œä¹…ä¸–ä¼¶çš„å½±å­åœ¨ä¹¦æ¶è¾¹åœä½ï¼Œä»–å‹ä½å£°éŸ³æé†’ä½ ä¼‘æ¯å¤Ÿäº†å†èµ°ã€‚é‚£ä»½é è¿‘è®©ä½ å¿ƒè·³æ…¢äº†åŠæ‹ã€‚");
          addAffection(state, "C", 1);
          addTrust(state, "C", 1);
          addResource(state, "energy", 5);
        }
      }
    }

    function applyNightRecovery() {
      let recovery = 25;
      if (state.resources.mood >= 70) recovery += 5;
      addResource(state, "energy", recovery);
      state.storyLog.push(`å¤œé—´æ¢å¤ï¼šç²¾åŠ›+${recovery}ã€‚`);
    }

    function checkUnlocks() {
      if (state.week >= 4 && !state.guys.A.unlocked) {
        state.guys.A.unlocked = true;
        state.storyLog.push("ã€ä¸»çº¿è§£é”ã€‘æ ¡åº†æµç¨‹/é¢„ç®—å®¡æ ¸å¡æ­»ï¼Œä½ éœ€è¦ç™½æ¾¤å‡›å¸ç­¾å­—ä¸æ ¡å¯¹ï¼Œç¬¬ä¸€æ¬¡æ­£å¼å¯¹è¯å°±æ­¤å±•å¼€ã€‚");
      }
      if (state.week >= 6 && !state.guys.C.unlocked) {
        state.guys.C.unlocked = true;
        state.storyLog.push("ã€ä¸»çº¿è§£é”ã€‘å®£ä¼ ä½è¢«æŠ¢/è°£è¨€æ‰©æ•£ï¼Œä½ ä¸å¾—ä¸ä¸ä¹…ä¸–ä¼¶äº¤æ¢ä¿¡æ¯ä¸èµ„æºï¼Œåˆä½œå…³ç³»æ­£å¼å»ºç«‹ã€‚");
      }
    }

    function finalizeDay() {
      applyNightRecovery();
      if (state.forcedRest) {
        state.storyLog.push("ã€å¼ºåˆ¶ä¼‘æ¯ã€‘ä»Šå¤©ä¸è®¡å…¥æ—¥ç¨‹ï¼Œä½ é‡æ–°æ•´ç†çŠ¶æ€ã€‚");
        state.forcedRest = false;
      } else {
        state.day += 1;
        updateWeek();
        checkUnlocks();
        if (state.day % 7 === 1) {
          state.storyLog.push(`ã€å‘¨æ€»ç»“ã€‘ç¬¬${state.week - 1}å‘¨ç»“æŸï¼Œä¼åˆ’è¿›åº¦${state.resources.project}%ã€‚`);
        }
      }
      state.actionsTaken = 0;
      initDaySummary();
      if (state.day > maxDay) {
        endGame();
      } else {
        state.storyLog.push(`ç¬¬${state.day}å¤©å¼€å§‹ã€‚`);
        renderAll();
      }
    }

    function openSettlement() {
      const summary = state.daySummary;
      if (!summary) return;
      const resDelta = Object.entries(state.resources).map(([key, value]) => {
        const delta = value - summary.startResources[key];
        return `<div class="small">${resourceLabels[key]}ï¼š${delta >= 0 ? "+" : ""}${delta}</div>`;
      }).join("");
      const guyDelta = Object.keys(state.guys).map((id) => {
        const start = summary.startGuys[id];
        const current = state.guys[id];
        const aff = current.affection - start.affection;
        const trust = current.trust - start.trust;
        return `<div class="small">${guyStories[id].name} å¥½æ„Ÿ${aff >= 0 ? "+" : ""}${aff} / ä¿¡ä»»${trust >= 0 ? "+" : ""}${trust}</div>`;
      }).join("");
      const itemsGained = summary.items.length ? summary.items.map((i) => `<li>${i}</li>`).join("") : "<li>æ— </li>";
      const cluesGained = summary.clues.length ? summary.clues.map((c) => `<li>${c}</li>`).join("") : "<li>æ— </li>";
      settlementBody.innerHTML = `
        <div class="small">èµ„æºå˜åŒ–</div>
        ${resDelta}
        <hr />
        <div class="small">ç”·ä¸»å˜åŒ–</div>
        ${guyDelta}
        <hr />
        <div class="small">è·å¾—é“å…·</div>
        <ul>${itemsGained}</ul>
        <div class="small">è§£é”çº¿ç´¢</div>
        <ul>${cluesGained}</ul>
      `;
      settlementModal.classList.add("active");
    }

    function endGame() {
      const mainSuccess = state.resources.project >= 100;
      if (!mainSuccess) {
        state.storyLog.push("ã€å¤±è´¥ç»“å±€ã€‘æ ¡åº†ä¼åˆ’æœªè¾¾æ ‡ï¼Œä½ ä¸å¾—ä¸æ¥å—ç›´æ¥å¤±è´¥çš„ç»“æœã€‚");
        renderAll();
        renderChoices([{ label: "è¿”å›æ ‡é¢˜", onClick: showTitle }]);
        return;
      }

      const endings = [];
      if (mainSuccess) {
        const trueEndings = Object.entries(state.guys).filter(([, g]) => g.affection >= 80 && g.trust >= 70 && g.storyTier === 2 && g.storyIndex >= 3);
        if (trueEndings.length > 0) {
          endings.push(...trueEndings.map(([id]) => `ã€çœŸç»“å±€ã€‘ä¸${guyStories[id].name}çš„å¿ƒæ„åœ¨æ ¡åº†å¤œæ˜æœ—ã€‚`));
        }
        const normalEndings = Object.entries(state.guys).filter(([, g]) => g.affection >= 60 && g.trust >= 50);
        if (normalEndings.length > 0) {
          endings.push(...normalEndings.map(([id]) => `ã€æ™®é€šæ‹çˆ±ç»“å±€ã€‘ä½ ä¸${guyStories[id].name}åœ¨èˆå°å¹•å¸ƒåç›¸æ‹¥ã€‚`));
        }
        if (endings.length === 0) {
          endings.push("ã€å‹æƒ…ç»“å±€ã€‘æ ¡åº†åœ†æ»¡ç»“æŸï¼Œä½ æ”¶è·äº†åšå®šçš„ä¼™ä¼´ã€‚" );
        }
      }
      state.storyLog.push("\n" + endings.join("\n"));
      renderAll();
      renderChoices([{ label: "è¿”å›æ ‡é¢˜", onClick: showTitle }]);
    }

    function checkAchievements() {
      achievements.forEach((ach) => {
        if (!state.achievements.includes(ach.id) && ach.check(state)) {
          state.achievements.push(ach.id);
          state.storyLog.push(`ã€æˆå°±è¾¾æˆã€‘${ach.name}`);
          if (ach.rewardItem) {
            gainItem(state, ach.rewardItem);
          }
          if (ach.rewardRewind) {
            state.rewindTokens += ach.rewardRewind;
          }
        }
      });
    }

    function openAchievements() {
      achievementList.innerHTML = achievements.map((ach) => {
        const done = state.achievements.includes(ach.id);
        return `<div class="item"><strong>${done ? "âœ“" : "â—‹"} ${ach.name}</strong><div class="small">${ach.desc}</div></div>`;
      }).join("");
      achievementModal.classList.add("active");
    }

    function openInventory(allowUse = false) {
      inventoryList.innerHTML = state.inventory.map((itemId, index) => {
        const item = items[itemId];
        const useBtn = allowUse ? `<button class="btn" data-index="${index}">ä½¿ç”¨</button>` : "";
        return `<div class="item"><strong>${item.name}</strong> <span class="badge">${item.type}</span><div class="small">${item.desc}</div>${useBtn}</div>`;
      }).join("");
      inventoryModal.classList.add("active");
      if (allowUse) {
        inventoryList.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", () => {
            const index = Number(btn.dataset.index);
            useItem(state.inventory[index]);
            state.inventory.splice(index, 1);
            inventoryModal.classList.remove("active");
            afterAction("ä½ ä½¿ç”¨äº†é“å…·ã€‚");
          });
        });
      }
    }

    function useItem(itemId) {
      const item = items[itemId];
      if (item) {
        item.effect(state);
      }
    }

    function renderAll() {
      renderResources();
      renderCharacters();
      renderTasks();
      renderStory();
      renderDayInfo();
      if (state.day === 1 && state.actionsTaken === 0 && state.playerName === defaultName && !state.flags.nameHintShown
        && !nameModal.classList.contains("active") && !mainlineWarningModal.classList.contains("active")) {
        state.flags.nameHintShown = true;
        document.getElementById("nameHintModal").classList.add("active");
      }
      if (state.day <= maxDay) {
        renderChoices(getDefaultChoices());
      }
    }

    function getDefaultChoices() {
      if (state.actionsTaken >= state.actionsPerDay) {
        return [{ label: "ç»“æŸä»Šå¤©", onClick: () => openSettlement() }];
      }
      let priorityTasks = tasks.filter((task) => task.condition(state));
      if (state.resources.energy < 25) {
        const urgentIds = ["emergencyRest", "canteen", "seekB"];
        const urgentTasks = priorityTasks.filter((task) => urgentIds.includes(task.id));
        const normalTasks = priorityTasks.filter((task) => !urgentIds.includes(task.id));
        priorityTasks = [...urgentTasks, ...normalTasks];
      }
      const options = priorityTasks.map((task) => ({
        label: task.name,
        onClick: () => runTask(task.id)
      }));
      options.push({ label: "æŸ¥çœ‹æœ¬å‘¨ç›®æ ‡", onClick: () => state.storyLog.push(`ã€æç¤ºã€‘${weekGoals[state.week - 1]}`) || renderAll() });
      options.push({ label: "æŸ¥çœ‹å›æº¯æ¬¡æ•°", onClick: () => { state.storyLog.push(`å½“å‰å›æº¯æ¬¡æ•°ï¼š${state.rewindTokens}`); renderAll(); } });
      return options.slice(0, 5);
    }

    function showTitle() {
      state.storyLog.push("ã€æ ‡é¢˜ã€‘é€‰æ‹©â€œæ–°æ¸¸æˆâ€å¼€å§‹ä½ çš„12å‘¨æ—…ç¨‹ã€‚");
      renderAll();
    }

    function openTutorial(startIndex = 0) {
      let step = startIndex;
      const renderStep = () => {
        tutorialBody.innerHTML = `<p>${tutorialSteps[step]}</p>`;
        tutorialControls.innerHTML = "";
        const prevBtn = document.createElement("button");
        prevBtn.className = "btn";
        prevBtn.textContent = "ä¸Šä¸€æ­¥";
        prevBtn.disabled = step === 0;
        prevBtn.addEventListener("click", () => { step = Math.max(0, step - 1); renderStep(); });
        const nextBtn = document.createElement("button");
        nextBtn.className = "btn";
        nextBtn.textContent = step === tutorialSteps.length - 1 ? "å®Œæˆ" : "ä¸‹ä¸€æ­¥";
        nextBtn.addEventListener("click", () => {
          if (step === tutorialSteps.length - 1) {
            tutorialModal.classList.remove("active");
          } else {
            step += 1;
            renderStep();
          }
        });
        const skipBtn = document.createElement("button");
        skipBtn.className = "btn";
        skipBtn.textContent = "è·³è¿‡";
        skipBtn.addEventListener("click", () => tutorialModal.classList.remove("active"));
        tutorialControls.append(prevBtn, nextBtn, skipBtn);
      };
      renderStep();
      tutorialModal.classList.add("active");
    }

    function openNameModal(mode = "rename") {
      nameModalMode = mode;
      const input = document.getElementById("nameInput");
      input.value = state.playerName || defaultName;
      nameModal.classList.add("active");
    }

    function applyPlayerName(name) {
      state.playerName = name && name.trim() ? name.trim() : defaultName;
      if (nameModalMode === "newgame") {
        state.storyLog = [`${state.playerName}åœ¨æ–°å­¦æœŸç¬¬1å‘¨å›åˆ°æ ¡å›­ã€‚ä¸€å¤©æœ‰3æ¬¡è¡ŒåŠ¨ï¼Œæ ¡åº†ä¼åˆ’ç­‰ç€ä½ ã€‚`];
        initDaySummary();
        renderAll();
        openTutorial(0);
        if (state.settings.showMainlineWarning) {
          mainlineWarningModal.classList.add("active");
        }
      } else {
        state.storyLog.push(`ã€æ”¹åã€‘ä½ å†³å®šä½¿ç”¨æ–°çš„åå­—ï¼š${state.playerName}ã€‚`);
        renderAll();
      }
    }

    function newGame() {
      state = stateTemplate();
      openNameModal("newgame");
      renderAll();
    }

    function saveGame() {
      const slot = prompt("å­˜æ¡£ä½ï¼š1/2/3", "1");
      if (!slot) return;
      localStorage.setItem(`otome_save_${slot}`, JSON.stringify(state));
      state.storyLog.push(`ã€å­˜æ¡£ã€‘å·²ä¿å­˜åˆ°å­˜æ¡£ä½${slot}ã€‚`);
      renderAll();
    }

    function loadGame() {
      const slot = prompt("è¯»æ¡£ä½ï¼š1/2/3", "1");
      if (!slot) return;
      const data = localStorage.getItem(`otome_save_${slot}`);
      if (data) {
        state = JSON.parse(data);
        if (!state.playerName) {
          state.playerName = state.name || defaultName;
        }
        ["A", "B", "C"].forEach((id) => {
          if (state.guys[id] && state.guys[id].unlocked == null) {
            state.guys[id].unlocked = id === "B";
          }
        });
        if (state.actionsPerDay == null) state.actionsPerDay = 3;
        if (state.actionsTaken == null) state.actionsTaken = 0;
        if (state.forcedRest == null) state.forcedRest = false;
        if (!state.daySummary) {
          initDaySummary();
        }
        if (!state.settings) state.settings = { showMainlineWarning: true };
        if (!state.flags) state.flags = { firstDate: false, triangle: false, nameHintShown: false };
        checkUnlocks();
        state.storyLog.push(`ã€è¯»æ¡£ã€‘å·²è¯»å–å­˜æ¡£ä½${slot}ã€‚`);
      } else {
        state.storyLog.push("ã€è¯»æ¡£ã€‘è¯¥å­˜æ¡£ä½ä¸ºç©ºã€‚");
      }
      renderAll();
    }

    document.getElementById("newGame").addEventListener("click", newGame);
    document.getElementById("saveGame").addEventListener("click", saveGame);
    document.getElementById("loadGame").addEventListener("click", loadGame);
    document.getElementById("toTitle").addEventListener("click", showTitle);
    document.getElementById("openTutorial").addEventListener("click", () => openTutorial(0));
    document.getElementById("renamePlayer").addEventListener("click", () => openNameModal("rename"));
    document.getElementById("openSettings").addEventListener("click", () => {
      document.getElementById("toggleMainlineWarning").checked = state.settings.showMainlineWarning;
      settingsModal.classList.add("active");
    });
    document.getElementById("openAchievements").addEventListener("click", openAchievements);
    document.getElementById("closeAchievements").addEventListener("click", () => achievementModal.classList.remove("active"));
    document.getElementById("openInventory").addEventListener("click", () => openInventory(false));
    document.getElementById("closeInventory").addEventListener("click", () => inventoryModal.classList.remove("active"));
    document.getElementById("confirmSettlement").addEventListener("click", () => {
      settlementModal.classList.remove("active");
      finalizeDay();
    });
    document.getElementById("confirmName").addEventListener("click", () => {
      const value = document.getElementById("nameInput").value;
      nameModal.classList.remove("active");
      applyPlayerName(value);
    });
    document.getElementById("skipName").addEventListener("click", () => {
      nameModal.classList.remove("active");
      applyPlayerName(defaultName);
    });
    document.getElementById("renameNow").addEventListener("click", () => {
      nameHintModal.classList.remove("active");
      openNameModal("rename");
    });
    document.getElementById("renameLater").addEventListener("click", () => {
      nameHintModal.classList.remove("active");
    });
    document.getElementById("ackWarning").addEventListener("click", () => {
      mainlineWarningModal.classList.remove("active");
      renderAll();
    });
    document.getElementById("skipWarning").addEventListener("click", () => {
      state.settings.showMainlineWarning = false;
      mainlineWarningModal.classList.remove("active");
      renderAll();
    });
    document.getElementById("toggleMainlineWarning").addEventListener("change", (event) => {
      state.settings.showMainlineWarning = event.target.checked;
    });
    document.getElementById("closeSettings").addEventListener("click", () => {
      settingsModal.classList.remove("active");
    });

    // å¦‚ä½•æ·»åŠ æ–°äº‹ä»¶/æ–°é“å…·/æ–°æˆå°±/æ–°è¡ŒåŠ¨ï¼š
    // 1) æ–°è¡ŒåŠ¨ï¼šåœ¨ tasks ä¸­æ–°å¢å¯¹è±¡ï¼Œå¹¶é…ç½® desc/effect/conditionï¼ˆè¡ŒåŠ¨ç‚¹ä¼šè‡ªåŠ¨è®¡æ•°ï¼‰ã€‚
    // 2) æ–°äº‹ä»¶ï¼šåœ¨ randomEvents æˆ– meetingEvents ä¸­è¿½åŠ å¯¹è±¡ï¼ŒåŒ…å« text/optionsã€‚
    // 3) æ–°é“å…·ï¼šåœ¨ items ä¸­æ–°å¢æ¡ç›®ï¼Œå¹¶å¯åœ¨äº‹ä»¶æˆ–æˆå°±å¥–åŠ±é‡Œ gainItemã€‚
    // 4) æ–°æˆå°±ï¼šåœ¨ achievements ä¸­è¿½åŠ å¯¹è±¡ï¼Œæä¾› check é€»è¾‘ä¸å¥–åŠ±ã€‚
    // 5) ç²¾åŠ›æ›²çº¿ï¼šä¿®æ”¹ tasks çš„ç²¾åŠ›æ¶ˆè€—ã€applyNightRecovery çš„æ¢å¤å€¼ã€æˆ–è¡¥ç»™é“å…·çš„æ¢å¤é‡ã€‚
    // 6) ç§°å‘¼åˆ†æ®µï¼šè°ƒæ•´ getCallName å†…å„é˜¶æ®µè¿”å›å€¼ã€‚
    // 7) å°äº‹ä»¶æ¦‚ç‡ï¼šè°ƒæ•´ triggerMiniEvent å†…çš„ base/scaling/ä¸Šé™ã€‚

    renderAll();
  </script>
</body>
</html>
