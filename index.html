<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>粉黑乙女：校庆心动企划</title>
  <style>
    :root {
      --bg: #0b0b12;
      --panel: #141420;
      --panel-2: #1f1a2a;
      --accent: #ff4f99;
      --accent-2: #ff8ac2;
      --text: #f5e9f2;
      --muted: #b7a6c6;
      --danger: #ff4f6d;
      --good: #7dffb0;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "PingFang SC", "Noto Sans CJK SC", "Microsoft Yahei", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top, #1b0c1f 0%, #08070d 65%);
      min-height: 100vh;
    }
    header {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 16px 20px;
      background: #09090f;
      border-bottom: 1px solid #2d2033;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 2px;
      color: var(--accent-2);
      flex: 1;
    }
    .btn {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--accent);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s ease;
    }
    .btn:hover {
      background: var(--accent);
      color: #0b0b12;
    }
    .container {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 16px;
      padding: 20px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid #2d2033;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    }
    .panel h2 {
      margin: 0 0 10px;
      font-size: 16px;
      color: var(--accent-2);
    }
    .stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .stat .bar {
      flex: 1;
      height: 8px;
      background: #2a2035;
      border-radius: 999px;
      margin-left: 10px;
      overflow: hidden;
    }
    .bar span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #a95bff);
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #2c1b33;
      color: var(--accent-2);
      margin-right: 6px;
    }
    .task-list {
      display: grid;
      gap: 8px;
    }
    .task {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #2d2033;
      background: var(--panel-2);
      font-size: 13px;
    }
    .task small {
      color: var(--muted);
      display: block;
      margin-top: 4px;
    }
    .story {
      min-height: 340px;
      max-height: 420px;
      overflow-y: auto;
      background: rgba(9, 7, 12, 0.7);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #2d2033;
      line-height: 1.7;
    }
    .story p {
      margin: 0 0 12px;
    }
    .choices {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-top: 16px;
    }
    .choices button {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--accent-2);
      background: #1b1223;
      color: var(--text);
      cursor: pointer;
      transition: 0.2s ease;
    }
    .choices button:hover {
      background: var(--accent-2);
      color: #0b0b12;
    }
    .right-panel .character {
      border-bottom: 1px solid #2d2033;
      padding-bottom: 12px;
      margin-bottom: 12px;
    }
    .character h3 {
      margin: 0 0 8px;
      font-size: 15px;
      color: var(--accent-2);
    }
    .small {
      font-size: 12px;
      color: var(--muted);
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: var(--panel);
      border: 1px solid #2d2033;
      border-radius: 12px;
      padding: 20px;
      width: min(640px, 90vw);
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content h2 {
      margin-top: 0;
      color: var(--accent-2);
    }
    .inventory {
      display: grid;
      gap: 8px;
      margin-top: 8px;
    }
    .inventory .item {
      background: #1d1525;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #2d2033;
    }
    footer {
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      padding: 20px 0 30px;
    }
    .highlight {
      color: var(--accent-2);
    }
  </style>
</head>
<body>
  <header>
    <h1>粉黑乙女：校庆心动企划</h1>
    <button class="btn" id="newGame">新游戏</button>
    <button class="btn" id="saveGame">存档</button>
    <button class="btn" id="loadGame">读档</button>
    <button class="btn" id="toTitle">返回标题</button>
    <button class="btn" id="openTutorial">帮助/教程</button>
  </header>

  <div class="container">
    <aside class="panel">
      <h2>资源面板</h2>
      <div class="small" id="actionInfo"></div>
      <div class="stat">精力 <span id="energyValue">0</span><div class="bar"><span id="energyBar"></span></div></div>
      <div class="stat">金钱 <span id="moneyValue">0</span><div class="bar"><span id="moneyBar"></span></div></div>
      <div class="stat">心情 <span id="moodValue">0</span><div class="bar"><span id="moodBar"></span></div></div>
      <div class="stat">学业 <span id="studyValue">0</span><div class="bar"><span id="studyBar"></span></div></div>
      <div class="stat">企划进度 <span id="projectValue">0</span><div class="bar"><span id="projectBar"></span></div></div>
      <div class="small" id="weekGoal"></div>
      <hr />
      <h2>每日任务清单</h2>
      <div class="task-list" id="taskList"></div>
      <div style="margin-top:12px;">
        <button class="btn" id="openAchievements">成就入口</button>
        <button class="btn" id="openInventory">道具</button>
      </div>
    </aside>

    <main class="panel">
      <div class="small" id="dayInfo"></div>
      <div class="story" id="story"></div>
      <div class="choices" id="choices"></div>
    </main>

    <aside class="panel right-panel">
      <h2>男主状态</h2>
      <div class="character" id="charA"></div>
      <div class="character" id="charB"></div>
      <div class="character" id="charC"></div>
    </aside>
  </div>

  <div class="modal" id="achievementModal">
    <div class="modal-content">
      <h2>成就</h2>
      <div id="achievementList"></div>
      <button class="btn" id="closeAchievements">关闭</button>
    </div>
  </div>

  <div class="modal" id="inventoryModal">
    <div class="modal-content">
      <h2>道具</h2>
      <div class="inventory" id="inventoryList"></div>
      <button class="btn" id="closeInventory">关闭</button>
    </div>
  </div>

  <div class="modal" id="settlementModal">
    <div class="modal-content">
      <h2>今日结算</h2>
      <div id="settlementBody"></div>
      <button class="btn" id="confirmSettlement">进入下一天</button>
    </div>
  </div>

  <div class="modal" id="tutorialModal">
    <div class="modal-content">
      <h2>新手教程</h2>
      <div id="tutorialBody"></div>
      <div class="choices" id="tutorialControls"></div>
    </div>
  </div>

  <footer>粉黑乙女风 · 现代校园 · 一天3次行动 · 12周一周目 Demo</footer>

  <script>
    const maxDay = 84;
    const maxWeek = 12;
    const defaultName = "新同学";

    const weekGoals = [
      "第1周：立项与分工，至少推进10%",
      "第2周：校庆主题确认，至少推进18%",
      "第3周：拉赞助&展台方案，至少推进26%",
      "第4周：舞台节目定案，至少推进34%",
      "第5周：节目试排，至少推进42%",
      "第6周：展台制作启动，至少推进50%",
      "第7周：第一轮彩排，至少推进58%",
      "第8周：危机处理与调整，至少推进66%",
      "第9周：二轮彩排，至少推进74%",
      "第10周：物资到位，至少推进82%",
      "第11周：最终彩排，至少推进90%",
      "第12周：校庆当天，完成100%"
    ];

    const milestoneEvents = [
      { threshold: 10, text: "【主线】校庆企划正式立项，你被推为展台联络人。" },
      { threshold: 18, text: "【主线】主题确认：粉黑学院恋爱剧场。" },
      { threshold: 26, text: "【主线】赞助谈判开局，A默默递来预算模板。" },
      { threshold: 34, text: "【主线】节目定案：三男主联动的校园舞台剧。" },
      { threshold: 50, text: "【主线】展台制作开工，材料清单排到爆。" },
      { threshold: 58, text: "【主线】第一次彩排，B把气氛带得像派对。" },
      { threshold: 66, text: "【主线】突发危机：赞助缩水，需要临时补救。" },
      { threshold: 74, text: "【主线】二轮彩排，C的台词改得更“贴近你”。" },
      { threshold: 82, text: "【主线】物资到位，展台初成型。" },
      { threshold: 90, text: "【主线】最终彩排，你站在舞台中央。" },
      { threshold: 100, text: "【主线】校庆当日，所有人都在等你的指挥。" }
    ];

    const items = {
      snack: { name: "能量小饼干", type: "补给", desc: "精力+15", effect: (state) => addResource(state, "energy", 15) },
      meal: { name: "食堂热餐", type: "补给", desc: "精力+25", effect: (state) => addResource(state, "energy", 25) },
      bento: { name: "便当盒", type: "补给", desc: "精力+30 心情+4", effect: (state) => { addResource(state, "energy", 30); addResource(state, "mood", 4); } },
      tonic: { name: "补给饮", type: "补给", desc: "精力+40 心情+2", effect: (state) => { addResource(state, "energy", 40); addResource(state, "mood", 2); } },
      note: { name: "灵感便笺", type: "补给", desc: "企划进度+6", effect: (state) => addResource(state, "project", 6) },
      charm: { name: "黑桃发夹", type: "礼物", desc: "送给A，好感+6", effect: (state) => giftTo(state, "A", 6) },
      soda: { name: "草莓汽水", type: "礼物", desc: "送给B，好感+6", effect: (state) => giftTo(state, "B", 6) },
      ribbon: { name: "暗红丝带", type: "礼物", desc: "送给C，好感+6", effect: (state) => giftTo(state, "C", 6) },
      ticket: { name: "演出券", type: "纪念品", desc: "心情+10，随机男主信任+4", effect: (state) => { addResource(state, "mood", 10); randomTrust(state, 4); } },
      clueA: { name: "A的旧奖状", type: "线索", desc: "解锁A的背景故事", effect: (state) => addClue(state, "A") },
      clueB: { name: "B的旧照片", type: "线索", desc: "解锁B的背景故事", effect: (state) => addClue(state, "B") },
      clueC: { name: "C的广播手稿", type: "线索", desc: "解锁C的背景故事", effect: (state) => addClue(state, "C") }
    };

    const achievements = [
      { id: "study7", name: "学霸养成", desc: "连续学习7天", reward: "灵感便笺", rewardItem: "note", check: (s) => s.streaks.study >= 7 },
      { id: "firstDate", name: "第一次约会", desc: "完成任意男主约会", reward: "草莓汽水", rewardItem: "soda", check: (s) => s.flags.firstDate },
      { id: "secret", name: "揭开秘密", desc: "任意男主故事解锁到核心真相", reward: "回溯+1", rewardRewind: 1, check: (s) => Object.values(s.guys).some((g) => g.storyTier === 2 && g.storyIndex >= 3) },
      { id: "project50", name: "校庆推进50%", desc: "企划进度达到50%", reward: "能量小饼干", rewardItem: "snack", check: (s) => s.resources.project >= 50 },
      { id: "triangle", name: "三人修罗场存活", desc: "同日触发两位男主事件", reward: "回溯+1", rewardRewind: 1, check: (s) => s.flags.triangle },
      { id: "support", name: "支援者", desc: "累计企划推进20次", reward: "灵感便笺", rewardItem: "note", check: (s) => s.stats.projectTasks >= 20 },
      { id: "workaholic", name: "勤劳打工人", desc: "累计打工10次", reward: "演出券", rewardItem: "ticket", check: (s) => s.stats.partTime >= 10 },
      { id: "clubStar", name: "社团明星", desc: "累计社团活动10次", reward: "暗红丝带", rewardItem: "ribbon", check: (s) => s.stats.club >= 10 },
      { id: "restMaster", name: "自我疗愈", desc: "休息次数达12次", reward: "能量小饼干", rewardItem: "snack", check: (s) => s.stats.rest >= 12 },
      { id: "affection70", name: "心动临界", desc: "任意男主好感>=70", reward: "回溯+1", rewardRewind: 1, check: (s) => Object.values(s.guys).some((g) => g.affection >= 70) },
      { id: "trust70", name: "信赖临界", desc: "任意男主信任>=70", reward: "演出券", rewardItem: "ticket", check: (s) => Object.values(s.guys).some((g) => g.trust >= 70) },
      { id: "week12", name: "坚持到底", desc: "完成12周", reward: "终局回溯+1", rewardRewind: 1, check: (s) => s.day > maxDay }
    ];

    const guyStories = {
      A: {
        name: "冷淡学霸",
        layers: [
          ["他总在图书馆固定座位，像一条冷清的走廊。", "对社团活动不屑一顾，视社交为浪费。", "他拒绝合照，理由是“没必要”。"],
          ["家里对他“必须第一”的高压让他习惯把情绪压成静音。", "他暗中在做校庆赞助申请，却不愿说出口。", "他把忙碌当成防护罩，只留给你一丝温度。"],
          ["他曾因一次“放弃机会去救人”导致成绩受影响。", "家里的冷暴力把他逼成了“可靠机器”。", "他把“可靠”当成赎罪，直到你伸手。"]
        ]
      },
      B: {
        name: "阳光竹马",
        layers: [
          ["他总能逗你笑，像春天的操场。", "小卖部新品第一口总想塞给你。", "对你转学回来特别上心，像在确认你还在。"],
          ["他对外像太阳，对内却自卑。", "他怕你越走越远，于是拼命跟上。", "他常替你挡流言，却装作不经意。"],
          ["他曾经“误会”你一次，导致你离开。", "他把这三年当作补偿，日复一日。", "他想在校庆那天把真心说出口。"]
        ]
      },
      C: {
        name: "阴湿病娇",
        layers: [
          ["他温柔、会记住你所有细节。", "总能“刚好路过”，像一阵精准的风。", "他把你的喜好写进广播台的片尾。"],
          ["他在学生会/广播站掌握信息。", "会用“为了你好”制造选择倾向。", "他给你安排“最佳路线”，不让别人靠近。"],
          ["他小时候被长期忽视。", "靠观察与操控获得安全感。", "他害怕失去你，所以宁愿当“坏人也要留下你”。"]
        ]
      }
    };

    const randomEvents = [
      { id: "energyLow", condition: (s) => s.resources.energy <= 30, text: "你在走廊靠着窗深呼吸，有人递来一瓶水。", effect: (s) => addResource(s, "energy", 10) },
      { id: "moodLow", condition: (s) => s.resources.mood <= 30, text: "手机弹出“匿名鼓励语”，你忽然想继续努力。", effect: (s) => addResource(s, "mood", 8) },
      { id: "moneyLow", condition: (s) => s.resources.money <= 20, text: "兼职群招人加班，你抓住机会。", effect: (s) => addResource(s, "money", 30) },
      { id: "studyHigh", condition: (s) => s.resources.study >= 70, text: "老师夸你稳得像全年级的定心丸。", effect: (s) => addResource(s, "mood", 5) },
      { id: "projectPush", condition: (s) => s.resources.project >= 40, text: "企划会议顺利，推进更高效。", effect: (s) => addResource(s, "project", 4) },
      { id: "giftDrop", condition: () => true, text: "社团柜子里发现一份“未署名礼物”。", effect: (s) => gainItem(s, "ticket") },
      { id: "library", condition: () => true, text: "图书馆里灯光暖黄，你决定安静整理企划。", effect: (s) => { addResource(s, "study", 4); addResource(s, "project", 2); } },
      { id: "canteen", condition: () => true, text: "食堂推出粉黑限定甜品，你的心情被拉满。", effect: (s) => addResource(s, "mood", 6) },
      { id: "rain", condition: () => true, text: "突然下雨，三把伞从三个方向赶来。", effect: (s) => { addAffection(s, "A", 2); addAffection(s, "B", 2); addAffection(s, "C", 2); s.flags.triangle = true; } },
      { id: "broadcast", condition: () => true, text: "广播台点名致谢，你的名字被温柔念出。", effect: (s) => addResource(s, "mood", 5) },
      { id: "campusCat", condition: () => true, text: "校园猫趴在你脚边，时间慢下来。", effect: (s) => addResource(s, "energy", 5) },
      { id: "poster", condition: () => true, text: "你设计的海报被挂在主楼。", effect: (s) => addResource(s, "project", 3) },
      { id: "rumor", condition: (s) => s.resources.mood <= 40, text: "有人在背后议论你的忙碌，你学会无视。", effect: (s) => addResource(s, "mood", 4) },
      { id: "clinic", condition: (s) => s.resources.energy <= 25, text: "校医给你贴上温热的暖宝宝。", effect: (s) => addResource(s, "energy", 12) },
      { id: "bonus", condition: (s) => s.resources.money >= 120, text: "你把多余的钱捐给校庆。", effect: (s) => { addResource(s, "money", -20); addResource(s, "project", 4); } },
      { id: "practice", condition: (s) => s.resources.project >= 60, text: "舞台试排比预想更顺利。", effect: (s) => addResource(s, "project", 4) },
      { id: "sleepy", condition: (s) => s.resources.energy <= 40, text: "你被允许小憩片刻。", effect: (s) => addResource(s, "energy", 8) },
      { id: "volunteer", condition: () => true, text: "新生志愿者加入，任务被分担。", effect: (s) => addResource(s, "project", 2) }
    ];

    const guyEvents = {
      A: [
        { id: "A1", text: "A把书签塞到你的笔记本里：“别漏掉重点。”", affection: 4, trust: 3 },
        { id: "A2", text: "你在社团门口看见他默默递交赞助材料。", affection: 3, trust: 4 },
        { id: "A3", text: "他冷冷说“别熬夜”，却把咖啡放下。", affection: 4, trust: 3 },
        { id: "A4", text: "你帮他整理资料，他说：“谢谢…只有你。”", affection: 5, trust: 4 },
        { id: "A5", text: "矛盾爆发：他指责你不够严谨，气氛僵住。", affection: -2, trust: -4, conflict: true },
        { id: "A6", text: "和解：他承认压力太大，向你道歉。", affection: 6, trust: 6 },
        { id: "A7", text: "高心动：图书馆关灯，他护着你穿过黑暗。", affection: 7, trust: 4 },
        { id: "A8", text: "高心动：他在雨中撑伞，半边衣服湿透。", affection: 6, trust: 5 },
        { id: "A9", text: "他把自制的时间表贴在你桌前。", affection: 3, trust: 5 },
        { id: "A10", text: "他轻声说：“我愿意跟你一起承担。”", affection: 5, trust: 6 }
      ],
      B: [
        { id: "B1", text: "B递来新口味饮料：“你总会喜欢这个。”", affection: 4, trust: 3 },
        { id: "B2", text: "他带你在操场慢跑，笑着说你没变。", affection: 3, trust: 4 },
        { id: "B3", text: "他替你挡掉流言，拍拍你的肩。", affection: 4, trust: 4 },
        { id: "B4", text: "你们一起分发传单，他突然握住你的手。", affection: 6, trust: 3 },
        { id: "B5", text: "矛盾爆发：他误会你有意疏远，语气失控。", affection: -2, trust: -4, conflict: true },
        { id: "B6", text: "和解：他道歉说自己太害怕失去你。", affection: 6, trust: 6 },
        { id: "B7", text: "高心动：夜跑时他把耳机分你一半。", affection: 7, trust: 4 },
        { id: "B8", text: "高心动：他在台阶上系好你的鞋带。", affection: 6, trust: 5 },
        { id: "B9", text: "他认真询问你的梦想，然后说会帮你实现。", affection: 4, trust: 5 },
        { id: "B10", text: "他悄悄准备彩排惊喜，让你成为中心。", affection: 5, trust: 6 }
      ],
      C: [
        { id: "C1", text: "C递给你一份“刚好顺路”的资料。", affection: 4, trust: 3 },
        { id: "C2", text: "他在广播里念你的名字，语气温柔。", affection: 3, trust: 4 },
        { id: "C3", text: "他提醒你某人动向：“为了你好。”", affection: 4, trust: 4 },
        { id: "C4", text: "他帮你安排最优路线，效率爆表。", affection: 5, trust: 4 },
        { id: "C5", text: "矛盾爆发：你发现他隐瞒信息，心里发冷。", affection: -2, trust: -5, conflict: true },
        { id: "C6", text: "和解：他承认太害怕失去你，愿意坦白。", affection: 6, trust: 6 },
        { id: "C7", text: "高心动：夜里他披上你的外套，怕你着凉。", affection: 7, trust: 4 },
        { id: "C8", text: "高心动：他把广播站钥匙交给你。", affection: 6, trust: 5 },
        { id: "C9", text: "他为你准备好所有备选方案。", affection: 4, trust: 5 },
        { id: "C10", text: "他低声说：“你是我唯一的优先级。”", affection: 5, trust: 6 }
      ]
    };

    const tasks = [
      { id: "study", name: "学习", desc: "学业+6 心情-1 精力-10", effect: (s) => { addResource(s, "study", 6); addResource(s, "mood", -1); addResource(s, "energy", -10); s.streaks.study++; },
        condition: () => true },
      { id: "club", name: "社团", desc: "心情+5 企划+3 精力-9", effect: (s) => { addResource(s, "mood", 5); addResource(s, "project", 3); addResource(s, "energy", -9); s.stats.club++; s.streaks.study = 0; },
        condition: () => true },
      { id: "parttime", name: "打工", desc: "金钱+30 心情-2 精力-14", effect: (s) => { addResource(s, "money", 30); addResource(s, "mood", -2); addResource(s, "energy", -14); s.stats.partTime++; s.streaks.study = 0; },
        condition: () => true },
      { id: "rest", name: "休息", desc: "精力+35 心情+4（有概率额外+5）", effect: (s) => { addResource(s, "energy", 35); addResource(s, "mood", 4); if (Math.random() < 0.35) addResource(s, "mood", 5); s.stats.rest++; s.streaks.study = 0; },
        condition: () => true },
      { id: "date", name: "约会", desc: "触发男主事件 好感/信任↑ 精力-8 心情+5", effect: (s) => { s.flags.firstDate = true; },
        condition: (s) => s.day >= 3 },
      { id: "project", name: "校庆推进", desc: "企划+10 精力-12 心情-1", effect: (s) => { addResource(s, "project", 10); addResource(s, "energy", -12); addResource(s, "mood", -1); s.stats.projectTasks++; s.streaks.study = 0; },
        condition: () => true },
      { id: "useItem", name: "使用道具", desc: "使用背包内道具", effect: () => {}, condition: (s) => s.inventory.length > 0 },
      { id: "emergencyRest", name: "强制休整", desc: "精力+40 心情+3（低精力时解锁）", effect: (s) => { addResource(s, "energy", 40); addResource(s, "mood", 3); s.stats.rest++; }, condition: (s) => s.resources.energy < 25 },
      { id: "canteen", name: "食堂补给", desc: "精力+30 心情+3（低精力时解锁）", effect: (s) => { addResource(s, "energy", 30); addResource(s, "mood", 3); }, condition: (s) => s.resources.energy < 25 },
      { id: "seekB", name: "向竹马求助", desc: "精力+25 心情+6 信任+4（低精力时解锁）", effect: (s) => { addResource(s, "energy", 25); addResource(s, "mood", 6); addTrust(s, "B", 4); }, condition: (s) => s.resources.energy < 25 && s.day >= 2 }
    ];

    const tutorialSteps = [
      "欢迎来到粉黑乙女校园！左侧是资源面板、任务与成就入口。",
      "一天有3次行动：学习/社团/打工/休息/约会/校庆推进等。",
      "主线目标是3个月内完成校庆企划，进度条与周目标会提示你。",
      "右侧是男主好感与信任，提升后可解锁背景故事层层秘密。",
      "顶部可存档/读档，成就会奖励道具或回溯券。",
      "回溯券可在关键时刻救场，放心探索选择！"
    ];

    const stateTemplate = () => ({
      name: defaultName,
      day: 1,
      week: 1,
      actionsPerDay: 3,
      actionsTaken: 0,
      storyLog: ["新学期第1周，你作为转学/返校生踏进校园。一天有3次行动。校庆企划的消息铺天盖地。"],
      resources: { energy: 80, money: 100, mood: 60, study: 50, project: 0 },
      inventory: ["snack", "meal"],
      achievements: [],
      guys: {
        A: { affection: 20, trust: 20, storyTier: 0, storyIndex: 0 },
        B: { affection: 20, trust: 20, storyTier: 0, storyIndex: 0 },
        C: { affection: 20, trust: 20, storyTier: 0, storyIndex: 0 }
      },
      stats: { projectTasks: 0, partTime: 0, club: 0, rest: 0 },
      streaks: { study: 0 },
      flags: { firstDate: false, triangle: false },
      milestoneIndex: 0,
      extremeChoices: 0,
      lowTrustDays: 0,
      rewindTokens: 1,
      daySummary: null,
      forcedRest: false
    });

    let state = stateTemplate();
    initDaySummary();

    const storyEl = document.getElementById("story");
    const choicesEl = document.getElementById("choices");
    const taskListEl = document.getElementById("taskList");
    const dayInfoEl = document.getElementById("dayInfo");
    const actionInfoEl = document.getElementById("actionInfo");

    const achievementModal = document.getElementById("achievementModal");
    const inventoryModal = document.getElementById("inventoryModal");
    const settlementModal = document.getElementById("settlementModal");
    const settlementBody = document.getElementById("settlementBody");
    const tutorialModal = document.getElementById("tutorialModal");
    const tutorialBody = document.getElementById("tutorialBody");
    const tutorialControls = document.getElementById("tutorialControls");
    const achievementList = document.getElementById("achievementList");
    const inventoryList = document.getElementById("inventoryList");

    const resourceMap = {
      energy: { value: document.getElementById("energyValue"), bar: document.getElementById("energyBar") },
      money: { value: document.getElementById("moneyValue"), bar: document.getElementById("moneyBar") },
      mood: { value: document.getElementById("moodValue"), bar: document.getElementById("moodBar") },
      study: { value: document.getElementById("studyValue"), bar: document.getElementById("studyBar") },
      project: { value: document.getElementById("projectValue"), bar: document.getElementById("projectBar") }
    };
    const resourceLabels = {
      energy: "精力",
      money: "金钱",
      mood: "心情",
      study: "学业",
      project: "企划进度"
    };

    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

    function cloneGuyStats(guys) {
      return Object.fromEntries(Object.entries(guys).map(([id, g]) => [id, { affection: g.affection, trust: g.trust }]));
    }

    function initDaySummary() {
      state.daySummary = {
        startResources: { ...state.resources },
        startGuys: cloneGuyStats(state.guys),
        items: [],
        clues: [],
        logs: []
      };
    }

    function addResource(s, key, amount) {
      s.resources[key] = clamp(s.resources[key] + amount, 0, 100);
      if (key === "project") {
        s.resources.project = clamp(s.resources.project, 0, 100);
        checkMilestones(s);
      }
    }

    function addAffection(s, guy, amount) {
      s.guys[guy].affection = clamp(s.guys[guy].affection + amount, 0, 100);
      if (s.daySummary) {
        s.daySummary.logs.push(`好感变动：${guyStories[guy].name} ${amount > 0 ? "+" : ""}${amount}`);
      }
    }

    function addTrust(s, guy, amount) {
      s.guys[guy].trust = clamp(s.guys[guy].trust + amount, 0, 100);
      if (s.daySummary) {
        s.daySummary.logs.push(`信任变动：${guyStories[guy].name} ${amount > 0 ? "+" : ""}${amount}`);
      }
    }

    function giftTo(s, guy, amount) {
      addAffection(s, guy, amount);
      addTrust(s, guy, Math.floor(amount / 2));
    }

    function randomTrust(s, amount) {
      const keys = Object.keys(s.guys);
      const pick = keys[Math.floor(Math.random() * keys.length)];
      addTrust(s, pick, amount);
    }

    function gainItem(s, itemId) {
      s.inventory.push(itemId);
      s.storyLog.push(`获得道具：${items[itemId].name}。`);
      if (s.daySummary) {
        s.daySummary.items.push(items[itemId].name);
      }
    }

    function addClue(s, guy) {
      const g = s.guys[guy];
      const layer = guyStories[guy].layers[g.storyTier] || [];
      const index = g.storyIndex;
      if (layer[index]) {
        s.storyLog.push(`【${guyStories[guy].name}背景】${layer[index]}`);
        if (s.daySummary) {
          s.daySummary.clues.push(`${guyStories[guy].name}：${layer[index]}`);
        }
        g.storyIndex += 1;
        if (g.storyIndex >= 3 && g.storyTier < 2) {
          g.storyTier += 1;
          g.storyIndex = 0;
        }
      } else {
        s.storyLog.push("故事线索已全部解锁。");
      }
    }

    function checkMilestones(s) {
      const next = milestoneEvents[s.milestoneIndex];
      if (next && s.resources.project >= next.threshold) {
        s.storyLog.push(next.text);
        s.milestoneIndex += 1;
      }
    }

    function getWeek() {
      return Math.ceil(state.day / 7);
    }

    function updateWeek() {
      state.week = getWeek();
    }

    function renderResources() {
      Object.entries(state.resources).forEach(([key, value]) => {
        resourceMap[key].value.textContent = value;
        resourceMap[key].bar.style.width = `${value}%`;
      });
      document.getElementById("weekGoal").textContent = weekGoals[state.week - 1] || "";
    }

    function renderCharacters() {
      const renderGuy = (id, elId) => {
        const guy = state.guys[id];
        const storyProgress = guy.storyTier * 3 + guy.storyIndex;
        const text = `
          <h3>${guyStories[id].name}</h3>
          <div class="stat">好感 ${guy.affection}<div class="bar"><span style="width:${guy.affection}%"></span></div></div>
          <div class="stat">信任 ${guy.trust}<div class="bar"><span style="width:${guy.trust}%"></span></div></div>
          <div class="small">背景故事解锁进度：${storyProgress}/9</div>
        `;
        document.getElementById(elId).innerHTML = text;
      };
      renderGuy("A", "charA");
      renderGuy("B", "charB");
      renderGuy("C", "charC");
    }

    function renderTasks() {
      taskListEl.innerHTML = "";
      tasks.filter((task) => task.condition(state)).forEach((task) => {
        const div = document.createElement("div");
        div.className = "task";
        div.innerHTML = `<strong>${task.name}</strong><small>${task.desc}</small>`;
        taskListEl.appendChild(div);
      });
    }

    function renderStory() {
      storyEl.innerHTML = state.storyLog.map((line) => `<p>${line}</p>`).join("");
      storyEl.scrollTop = storyEl.scrollHeight;
    }

    function renderDayInfo() {
      dayInfoEl.innerHTML = `第${state.day}天 / 第${state.week}周 · 今日行动：${state.actionsTaken}/${state.actionsPerDay}`;
      actionInfoEl.textContent = `今日行动：${state.actionsTaken}/${state.actionsPerDay}`;
    }

    function renderChoices(options) {
      choicesEl.innerHTML = "";
      options.forEach((option) => {
        const button = document.createElement("button");
        button.textContent = option.label;
        button.addEventListener("click", option.onClick);
        choicesEl.appendChild(button);
      });
    }

    function getRandomEvent() {
      const pool = randomEvents.filter((evt) => evt.condition(state));
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function triggerRandomEvent() {
      const chance = state.resources.energy < 25 ? 0.25 : 0.45;
      if (Math.random() < chance) {
        const evt = getRandomEvent();
        if (evt) {
          state.storyLog.push(`【随机事件】${evt.text}`);
          evt.effect(state);
        }
      }
    }

    function triggerGuyEvent(guyId) {
      const pool = guyEvents[guyId];
      const event = pool[Math.floor(Math.random() * pool.length)];
      state.storyLog.push(`【${guyStories[guyId].name}事件】${event.text}`);
      addAffection(state, guyId, event.affection);
      addTrust(state, guyId, event.trust);
      if (event.conflict) {
        state.extremeChoices += 1;
      }
    }

    function runTask(taskId) {
      const task = tasks.find((t) => t.id === taskId);
      if (!task) return;
      if (taskId === "useItem") {
        openInventory(true);
        return;
      }
      if (taskId === "date") {
        renderChoices([
          { label: "约会·A", onClick: () => { doDate("A"); } },
          { label: "约会·B", onClick: () => { doDate("B"); } },
          { label: "约会·C", onClick: () => { doDate("C"); } },
          { label: "返回", onClick: () => { renderChoices(getDefaultChoices()); } }
        ]);
        return;
      }
      task.effect(state);
      afterAction(`${task.name}完成。`);
    }

    function doDate(guyId) {
      tasks.find((t) => t.id === "date").effect(state);
      addResource(state, "energy", -8);
      addResource(state, "mood", 5);
      triggerGuyEvent(guyId);
      if (Math.random() < 0.3) {
        gainItem(state, `clue${guyId}`);
      }
      afterAction(`与${guyStories[guyId].name}的约会结束。`);
    }

    function afterAction(summary) {
      state.storyLog.push(summary);
      state.actionsTaken += 1;
      if (state.daySummary) {
        state.daySummary.logs.push(summary);
      }
      triggerRandomEvent();
      checkAchievements();
      updateTrustStreak();
      if (state.resources.energy <= 0) {
        state.storyLog.push("【体力透支】你被强制休息一天，且获得1次回溯券。");
        state.rewindTokens += 1;
        state.forcedRest = true;
        state.actionsTaken = state.actionsPerDay;
      }
      renderAll();
    }

    function updateTrustStreak() {
      const lowTrust = Object.values(state.guys).some((g) => g.trust <= 25);
      if (lowTrust) {
        state.lowTrustDays += 1;
      } else {
        state.lowTrustDays = 0;
      }
    }

    function applyNightRecovery() {
      let recovery = 25;
      if (state.resources.mood >= 70) recovery += 5;
      addResource(state, "energy", recovery);
      state.storyLog.push(`夜间恢复：精力+${recovery}。`);
    }

    function finalizeDay() {
      applyNightRecovery();
      if (state.forcedRest) {
        state.storyLog.push("【强制休息】今天不计入日程，你重新整理状态。");
        state.forcedRest = false;
      } else {
        state.day += 1;
        updateWeek();
        if (state.day % 7 === 1) {
          state.storyLog.push(`【周总结】第${state.week - 1}周结束，企划进度${state.resources.project}%。`);
        }
      }
      state.actionsTaken = 0;
      initDaySummary();
      if (state.day > maxDay) {
        endGame();
      } else {
        state.storyLog.push(`第${state.day}天开始。`);
        renderAll();
      }
    }

    function openSettlement() {
      const summary = state.daySummary;
      if (!summary) return;
      const resDelta = Object.entries(state.resources).map(([key, value]) => {
        const delta = value - summary.startResources[key];
        return `<div class="small">${resourceLabels[key]}：${delta >= 0 ? "+" : ""}${delta}</div>`;
      }).join("");
      const guyDelta = Object.keys(state.guys).map((id) => {
        const start = summary.startGuys[id];
        const current = state.guys[id];
        const aff = current.affection - start.affection;
        const trust = current.trust - start.trust;
        return `<div class="small">${guyStories[id].name} 好感${aff >= 0 ? "+" : ""}${aff} / 信任${trust >= 0 ? "+" : ""}${trust}</div>`;
      }).join("");
      const itemsGained = summary.items.length ? summary.items.map((i) => `<li>${i}</li>`).join("") : "<li>无</li>";
      const cluesGained = summary.clues.length ? summary.clues.map((c) => `<li>${c}</li>`).join("") : "<li>无</li>";
      settlementBody.innerHTML = `
        <div class="small">资源变化</div>
        ${resDelta}
        <hr />
        <div class="small">男主变化</div>
        ${guyDelta}
        <hr />
        <div class="small">获得道具</div>
        <ul>${itemsGained}</ul>
        <div class="small">解锁线索</div>
        <ul>${cluesGained}</ul>
      `;
      settlementModal.classList.add("active");
    }

    function endGame() {
      const mainSuccess = state.resources.project >= 100;
      const badEnding = !mainSuccess && state.extremeChoices >= 3 && state.lowTrustDays >= 3;
      if (badEnding) {
        state.storyLog.push("【坏结局预警】你被困在疲惫与误解里。是否使用补救机制？");
        renderAll();
        renderChoices([
          { label: "休息重整", onClick: () => { addResource(state, "energy", 20); addResource(state, "mood", 15); state.lowTrustDays = 0; state.extremeChoices = 0; state.storyLog.push("你选择休息与求助，局势缓和。重新迎接一天。"); state.day = maxDay; endGame(); } },
          { label: "求助男主", onClick: () => { addTrust(state, "A", 10); addTrust(state, "B", 10); addTrust(state, "C", 10); state.lowTrustDays = 0; state.extremeChoices = 0; state.storyLog.push("三人同时出手帮你稳定局面。" ); state.day = maxDay; endGame(); } },
          { label: "使用道具", onClick: () => { if (state.inventory.length > 0) { useItem(state.inventory[0]); } state.storyLog.push("你用道具稳住心态。" ); state.day = maxDay; endGame(); } },
          { label: "回溯", onClick: () => { if (state.rewindTokens > 0) { state.rewindTokens -= 1; state.day = maxDay - 3; state.actionsTaken = 0; initDaySummary(); state.storyLog.push("你回溯到三天前。" ); renderAll(); } else { state.storyLog.push("回溯次数不足。" ); renderAll(); } } }
        ]);
        return;
      }

      const endings = [];
      if (mainSuccess) {
        const trueEndings = Object.entries(state.guys).filter(([, g]) => g.affection >= 80 && g.trust >= 70 && g.storyTier === 2 && g.storyIndex >= 3);
        if (trueEndings.length > 0) {
          endings.push(...trueEndings.map(([id]) => `【真结局】与${guyStories[id].name}的心意在校庆夜明朗。`));
        }
        const normalEndings = Object.entries(state.guys).filter(([, g]) => g.affection >= 60 && g.trust >= 50);
        if (normalEndings.length > 0) {
          endings.push(...normalEndings.map(([id]) => `【普通恋爱结局】你与${guyStories[id].name}在舞台幕布后相拥。`));
        }
        if (endings.length === 0) {
          endings.push("【友情结局】校庆圆满结束，你收获了坚定的伙伴。" );
        }
      } else {
        endings.push("【友情结局】主线未完成，但你仍得到朋友的支持。" );
      }
      state.storyLog.push("\n" + endings.join("\n"));
      renderAll();
      renderChoices([{ label: "返回标题", onClick: showTitle }]);
    }

    function checkAchievements() {
      achievements.forEach((ach) => {
        if (!state.achievements.includes(ach.id) && ach.check(state)) {
          state.achievements.push(ach.id);
          state.storyLog.push(`【成就达成】${ach.name}`);
          if (ach.rewardItem) {
            gainItem(state, ach.rewardItem);
          }
          if (ach.rewardRewind) {
            state.rewindTokens += ach.rewardRewind;
          }
        }
      });
    }

    function openAchievements() {
      achievementList.innerHTML = achievements.map((ach) => {
        const done = state.achievements.includes(ach.id);
        return `<div class="item"><strong>${done ? "✓" : "○"} ${ach.name}</strong><div class="small">${ach.desc}</div></div>`;
      }).join("");
      achievementModal.classList.add("active");
    }

    function openInventory(allowUse = false) {
      inventoryList.innerHTML = state.inventory.map((itemId, index) => {
        const item = items[itemId];
        const useBtn = allowUse ? `<button class="btn" data-index="${index}">使用</button>` : "";
        return `<div class="item"><strong>${item.name}</strong> <span class="badge">${item.type}</span><div class="small">${item.desc}</div>${useBtn}</div>`;
      }).join("");
      inventoryModal.classList.add("active");
      if (allowUse) {
        inventoryList.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", () => {
            const index = Number(btn.dataset.index);
            useItem(state.inventory[index]);
            state.inventory.splice(index, 1);
            inventoryModal.classList.remove("active");
            afterAction("你使用了道具。");
          });
        });
      }
    }

    function useItem(itemId) {
      const item = items[itemId];
      if (item) {
        item.effect(state);
      }
    }

    function renderAll() {
      renderResources();
      renderCharacters();
      renderTasks();
      renderStory();
      renderDayInfo();
      if (state.day <= maxDay) {
        renderChoices(getDefaultChoices());
      }
    }

    function getDefaultChoices() {
      if (state.actionsTaken >= state.actionsPerDay) {
        return [{ label: "结束今天", onClick: () => openSettlement() }];
      }
      let priorityTasks = tasks.filter((task) => task.condition(state));
      if (state.resources.energy < 25) {
        const urgentIds = ["emergencyRest", "canteen", "seekB"];
        const urgentTasks = priorityTasks.filter((task) => urgentIds.includes(task.id));
        const normalTasks = priorityTasks.filter((task) => !urgentIds.includes(task.id));
        priorityTasks = [...urgentTasks, ...normalTasks];
      }
      const options = priorityTasks.map((task) => ({
        label: task.name,
        onClick: () => runTask(task.id)
      }));
      options.push({ label: "查看本周目标", onClick: () => state.storyLog.push(`【提示】${weekGoals[state.week - 1]}`) || renderAll() });
      options.push({ label: "查看回溯次数", onClick: () => { state.storyLog.push(`当前回溯次数：${state.rewindTokens}`); renderAll(); } });
      return options.slice(0, 5);
    }

    function showTitle() {
      state.storyLog.push("【标题】选择“新游戏”开始你的12周旅程。");
      renderAll();
    }

    function openTutorial(startIndex = 0) {
      let step = startIndex;
      const renderStep = () => {
        tutorialBody.innerHTML = `<p>${tutorialSteps[step]}</p>`;
        tutorialControls.innerHTML = "";
        const prevBtn = document.createElement("button");
        prevBtn.className = "btn";
        prevBtn.textContent = "上一步";
        prevBtn.disabled = step === 0;
        prevBtn.addEventListener("click", () => { step = Math.max(0, step - 1); renderStep(); });
        const nextBtn = document.createElement("button");
        nextBtn.className = "btn";
        nextBtn.textContent = step === tutorialSteps.length - 1 ? "完成" : "下一步";
        nextBtn.addEventListener("click", () => {
          if (step === tutorialSteps.length - 1) {
            tutorialModal.classList.remove("active");
          } else {
            step += 1;
            renderStep();
          }
        });
        const skipBtn = document.createElement("button");
        skipBtn.className = "btn";
        skipBtn.textContent = "跳过";
        skipBtn.addEventListener("click", () => tutorialModal.classList.remove("active"));
        tutorialControls.append(prevBtn, nextBtn, skipBtn);
      };
      renderStep();
      tutorialModal.classList.add("active");
    }

    function promptName() {
      const name = prompt("请输入女主名字：", state.name);
      if (name) state.name = name;
    }

    function newGame() {
      state = stateTemplate();
      promptName();
      state.storyLog = [`${state.name}在新学期第1周回到校园。一天有3次行动，校庆企划等着你。`];
      initDaySummary();
      renderAll();
      openTutorial(0);
    }

    function saveGame() {
      const slot = prompt("存档位：1/2/3", "1");
      if (!slot) return;
      localStorage.setItem(`otome_save_${slot}`, JSON.stringify(state));
      state.storyLog.push(`【存档】已保存到存档位${slot}。`);
      renderAll();
    }

    function loadGame() {
      const slot = prompt("读档位：1/2/3", "1");
      if (!slot) return;
      const data = localStorage.getItem(`otome_save_${slot}`);
      if (data) {
        state = JSON.parse(data);
        if (state.actionsPerDay == null) state.actionsPerDay = 3;
        if (state.actionsTaken == null) state.actionsTaken = 0;
        if (state.forcedRest == null) state.forcedRest = false;
        if (!state.daySummary) {
          initDaySummary();
        }
        state.storyLog.push(`【读档】已读取存档位${slot}。`);
      } else {
        state.storyLog.push("【读档】该存档位为空。");
      }
      renderAll();
    }

    document.getElementById("newGame").addEventListener("click", newGame);
    document.getElementById("saveGame").addEventListener("click", saveGame);
    document.getElementById("loadGame").addEventListener("click", loadGame);
    document.getElementById("toTitle").addEventListener("click", showTitle);
    document.getElementById("openTutorial").addEventListener("click", () => openTutorial(0));
    document.getElementById("openAchievements").addEventListener("click", openAchievements);
    document.getElementById("closeAchievements").addEventListener("click", () => achievementModal.classList.remove("active"));
    document.getElementById("openInventory").addEventListener("click", () => openInventory(false));
    document.getElementById("closeInventory").addEventListener("click", () => inventoryModal.classList.remove("active"));
    document.getElementById("confirmSettlement").addEventListener("click", () => {
      settlementModal.classList.remove("active");
      finalizeDay();
    });

    // 如何添加新事件/新道具/新成就/新行动：
    // 1) 新行动：在 tasks 中新增对象，并配置 desc/effect/condition（行动点会自动计数）。
    // 2) 新事件：在 randomEvents 或 guyEvents 中追加对象，包含 condition/text/effect。
    // 3) 新道具：在 items 中新增条目，并可在事件或成就奖励里 gainItem。
    // 4) 新成就：在 achievements 中追加对象，提供 check 逻辑与奖励。
    // 5) 精力曲线：修改 tasks 的精力消耗、applyNightRecovery 的恢复值、或补给道具的恢复量。

    renderAll();
  </script>
</body>
</html>
